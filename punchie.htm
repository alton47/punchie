<!doctype html>
<html lang="en">
  <head>
    <!--
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘   PUNCH'S GREAT ESCAPE  â€”  V4                    â•‘
  â•‘   by Allan (@alton47)                             â•‘
  â•‘   Inspired by the viral Punch monkey trend 2026  â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Punch's Great Escape ğŸ’</title>
    <meta
      name="description"
      content="The bully monkeys yoinked Punch's red plushie! Help him run through 10 wild levels to get it back. Free browser game."
    />
    <meta
      name="keywords"
      content="punch monkey game, punch plushie game, monkey runner, free browser game, punch monkey trend 2026"
    />
    <meta
      property="og:title"
      content="Punch's Great Escape ğŸ’ â€” Get the plushie back!"
    />
    <meta
      property="og:description"
      content="The bully monkeys yoinked Punch's red plushie. 10 levels of pure chaos."
    />
    <meta name="twitter:card" content="summary" />
    <!-- Custom monkey favicon via SVG data URI -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='55' r='38' fill='%23c47a2e'/><circle cx='50' cy='48' r='28' fill='%23c47a2e'/><circle cx='22' cy='36' r='12' fill='%23c47a2e'/><circle cx='78' cy='36' r='12' fill='%23c47a2e'/><circle cx='22' cy='36' r='7' fill='%23e8c09a'/><circle cx='78' cy='36' r='7' fill='%23e8c09a'/><ellipse cx='50' cy='54' rx='20' ry='18' fill='%23e8a96a'/><circle cx='42' cy='43' r='5' fill='%231a0a2e'/><circle cx='58' cy='43' r='5' fill='%231a0a2e'/><circle cx='43' cy='41' r='2' fill='white'/><circle cx='59' cy='41' r='2' fill='white'/><ellipse cx='50' cy='60' rx='8' ry='5' fill='%23c47a2e'/><circle cx='38' cy='62' r='4' fill='%23ff4d6d'/></svg>"
    />
    <style>
      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
      @import url("https://fonts.googleapis.com/css2?family=Boogaloo&family=Nunito:wght@400;700;900&display=swap");

      :root {
        /* Brand palette */
        --c-orange: #ff6b35;
        --c-orange-d: #c23b0a;
        --c-yellow: #ffd166;
        --c-teal: #06d6a0;
        --c-red: #ff4d6d;
        --c-purple: #1a0a2e;
        --c-violet: #a78bfa;
        /* Radii */
        --r-sm: 8px;
        --r-md: 14px;
        --r-lg: 22px;
        --r-pill: 50px;
      }

      /* â”€â”€ RESET â”€â”€ */
      *,
      *::before,
      *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        background: #050115;
        font-family: "Boogaloo", cursive;
        overflow: hidden;
        touch-action: none;
        user-select: none;
        -webkit-user-select: none;
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT  â€”  The entire game lives in #shell which
   fills the viewport. #gc is the game container
   that scales to fill available space correctly.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
      #shell {
        position: fixed;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #050115;
      }

      #gc {
        position: relative;
        /* Size set entirely by JS resize() */
        background: var(--c-purple);
        border-radius: var(--r-md);
        overflow: hidden;
        box-shadow:
          0 0 0 1px rgba(255, 107, 53, 0.12),
          0 0 60px rgba(255, 107, 53, 0.28),
          0 0 120px rgba(45, 27, 105, 0.45);
        /* Prevent sub-pixel bleed */
        image-rendering: pixelated;
      }

      /* The only canvas â€” sized dynamically */
      #cv {
        display: block;
        touch-action: none;
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREENS  â€”  Overlay system. Only .active shows.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
      .scr {
        position: absolute;
        inset: 0;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        overflow-y: auto;
        overflow-x: hidden;
        padding: clamp(10px, 2vw, 20px);
        gap: clamp(6px, 1.2vh, 12px);
        z-index: 50;
        background: linear-gradient(
          160deg,
          #0d0420 0%,
          #1a0a2e 55%,
          #2d1b69 100%
        );
      }
      .scr.active {
        display: flex;
      }

      /* Scrollable screens show bar on hover */
      .scr::-webkit-scrollbar {
        width: 4px;
      }
      .scr::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 2px;
      }

      /* â”€â”€ Title screen hero â”€â”€ */
      #scr-home {
        padding-top: clamp(8px, 1.5vh, 18px);
      }

      #title-art-canvas {
        /* JS sets exact size */
        display: block;
        flex-shrink: 0;
      }

      .game-title {
        font-size: clamp(28px, 6.5vw, 64px);
        color: var(--c-orange);
        text-shadow:
          3px 3px 0 var(--c-orange-d, #c23b0a),
          0 0 40px rgba(255, 107, 53, 0.35);
        line-height: 1;
        text-align: center;
        letter-spacing: 2px;
      }

      .game-subtitle {
        font-size: clamp(10px, 2vw, 16px);
        color: var(--c-yellow);
        letter-spacing: 3px;
        text-align: center;
        margin-top: 2px;
      }

      .story-box {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 107, 53, 0.22);
        border-radius: var(--r-md);
        padding: clamp(8px, 1.5vh, 14px) clamp(12px, 2vw, 20px);
        max-width: min(440px, 90%);
        font-size: clamp(10px, 1.9vw, 14px);
        font-family: "Nunito", sans-serif;
        color: rgba(255, 255, 255, 0.82);
        line-height: 1.65;
        text-align: center;
        width: 100%;
      }

      .best-row {
        font-size: clamp(10px, 1.7vw, 13px);
        color: rgba(255, 255, 255, 0.3);
        font-family: "Nunito", sans-serif;
        text-align: center;
      }

      /* â”€â”€ Persistent top bar (mute + coffee) visible on title + in-game â”€â”€ */
      #topbar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 6px;
        padding: clamp(5px, 1vh, 10px) clamp(8px, 1.5vw, 14px);
        z-index: 60;
        pointer-events: none; /* children handle their own events */
      }
      #topbar > * {
        pointer-events: all;
      }

      #coffee-btn {
        background: rgba(255, 213, 79, 0.12);
        border: 1px solid rgba(255, 213, 79, 0.35);
        color: var(--c-yellow);
        text-decoration: none;
        padding: 4px 11px;
        font-size: clamp(9px, 1.6vw, 12px);
        font-family: "Boogaloo", cursive;
        border-radius: var(--r-pill);
        display: flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
        transition: background 0.2s;
      }
      #coffee-btn:hover {
        background: rgba(255, 213, 79, 0.24);
      }

      #mute-btn {
        width: clamp(26px, 3.5vw, 34px);
        height: clamp(26px, 3.5vw, 34px);
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        font-size: clamp(12px, 2vw, 16px);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }
      #mute-btn:hover {
        background: rgba(255, 255, 255, 0.22);
      }

      /* About button on home */
      #about-btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.18);
        color: rgba(255, 255, 255, 0.55);
        padding: 4px 14px;
        font-size: clamp(9px, 1.6vw, 12px);
        font-family: "Boogaloo", cursive;
        border-radius: var(--r-pill);
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }
      #about-btn:hover {
        color: white;
        border-color: rgba(255, 255, 255, 0.4);
      }

      /* â”€â”€ HUD bar (shown during gameplay) â”€â”€ */
      #hud {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: none;
        align-items: center;
        gap: clamp(4px, 1vw, 8px);
        padding: clamp(4px, 0.8vh, 8px) clamp(8px, 1.5vw, 14px);
        background: rgba(0, 0, 0, 0.58);
        backdrop-filter: blur(8px);
        z-index: 20;
      }
      #hud.visible {
        display: flex;
      }

      #hud-hearts {
        font-size: clamp(12px, 2.2vw, 17px);
        white-space: nowrap;
        flex-shrink: 0;
      }
      #hud-level {
        font-size: clamp(10px, 1.8vw, 14px);
        color: var(--c-teal);
        white-space: nowrap;
        flex-shrink: 0;
      }
      #hud-prog-wrap {
        flex: 1;
        height: 6px;
        min-width: 30px;
        background: rgba(255, 255, 255, 0.12);
        border-radius: 3px;
        overflow: hidden;
      }
      #hud-prog {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--c-teal), var(--c-yellow));
        border-radius: 3px;
        transition: width 0.3s;
      }
      #hud-gems {
        font-size: clamp(10px, 1.7vw, 13px);
        color: var(--c-violet);
        white-space: nowrap;
        flex-shrink: 0;
      }
      #hud-score {
        font-size: clamp(10px, 1.8vw, 14px);
        color: var(--c-yellow);
        white-space: nowrap;
        flex-shrink: 0;
      }
      #hud-pause {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        font-size: clamp(11px, 1.8vw, 15px);
        cursor: pointer;
        border-radius: var(--r-sm);
        padding: 2px 7px;
        font-family: "Boogaloo", cursive;
        flex-shrink: 0;
      }

      #immuno-badge {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(192, 132, 252, 0.9);
        color: white;
        padding: 1px 10px;
        font-size: 11px;
        border-radius: 0 0 10px 10px;
        pointer-events: none;
        display: none;
        box-shadow: 0 0 16px rgba(192, 132, 252, 0.8);
      }

      /* â”€â”€ Dev mode badge â”€â”€ */
      #dev-badge {
        position: absolute;
        top: clamp(30px, 5vw, 48px);
        left: 8px;
        background: rgba(255, 77, 109, 0.18);
        border: 1px solid rgba(255, 77, 109, 0.45);
        color: var(--c-red);
        padding: 2px 9px;
        font-size: 10px;
        font-family: "Nunito", sans-serif;
        border-radius: 8px;
        z-index: 30;
        display: none;
      }
      #dev-badge.visible {
        display: block;
      }

      /* â”€â”€ Mobile on-screen controls (touch only) â”€â”€ */
      #mob-ctrl {
        position: absolute;
        bottom: clamp(6px, 2vh, 16px);
        left: 0;
        right: 0;
        display: none; /* JS shows only on touch devices */
        justify-content: space-between;
        align-items: flex-end;
        padding: 0 clamp(8px, 2vw, 20px);
        z-index: 25;
        pointer-events: none;
      }
      #mob-ctrl.visible {
        display: flex;
      }

      .mob-btn {
        width: clamp(52px, 13vw, 70px);
        height: clamp(52px, 13vw, 70px);
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.09);
        border: 2px solid rgba(255, 255, 255, 0.22);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: clamp(22px, 5vw, 30px);
        pointer-events: all;
        cursor: pointer;
        backdrop-filter: blur(4px);
        transition:
          background 0.1s,
          transform 0.1s;
        -webkit-tap-highlight-color: transparent;
      }
      .mob-btn:active {
        background: rgba(255, 255, 255, 0.24);
        transform: scale(0.88);
      }
      #mob-jump {
        order: 2;
      }
      #mob-slide {
        order: 1;
      }

      /* â”€â”€ Level toast â”€â”€ */
      #level-toast {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.82);
        border: 2px solid var(--c-yellow);
        border-radius: var(--r-md);
        padding: 14px 28px;
        text-align: center;
        z-index: 55;
        pointer-events: none;
        display: none;
        backdrop-filter: blur(12px);
      }
      #toast-lvl {
        font-size: clamp(40px, 9vw, 62px);
        color: var(--c-yellow);
        line-height: 1;
      }
      #toast-name {
        font-size: clamp(14px, 2.8vw, 20px);
        color: rgba(255, 255, 255, 0.85);
        font-family: "Nunito", sans-serif;
      }
      #toast-desc {
        font-size: clamp(11px, 2vw, 15px);
        color: var(--c-teal);
        margin-top: 3px;
      }

      /* â”€â”€ Tutorial overlay â”€â”€ */
      #tutorial-box {
        position: absolute;
        bottom: clamp(50px, 12vw, 90px);
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.88);
        border: 2px solid var(--c-orange);
        border-radius: var(--r-md);
        padding: 12px 20px;
        text-align: center;
        z-index: 55;
        pointer-events: none;
        display: none;
        backdrop-filter: blur(10px);
        min-width: clamp(160px, 50%, 280px);
        animation: tutPulse 1s ease-in-out infinite alternate;
      }
      @keyframes tutPulse {
        from {
          border-color: var(--c-orange);
        }
        to {
          border-color: var(--c-yellow);
        }
      }
      #tut-icon {
        font-size: clamp(24px, 5vw, 36px);
        line-height: 1.2;
      }
      #tut-text {
        font-size: clamp(12px, 2.2vw, 16px);
        color: white;
        margin-top: 4px;
        font-family: "Nunito", sans-serif;
        line-height: 1.5;
      }
      #tut-key {
        font-size: clamp(11px, 2vw, 14px);
        color: var(--c-yellow);
        margin-top: 4px;
        font-family: "Boogaloo", cursive;
      }

      /* â”€â”€ Rare gem banner â”€â”€ */
      #gem-banner {
        position: absolute;
        top: clamp(38px, 8vw, 60px);
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, var(--c-yellow), #ff9f1c);
        color: #1a0a2e;
        padding: 6px 18px;
        border-radius: var(--r-pill);
        font-size: clamp(11px, 2vw, 14px);
        font-family: "Nunito", sans-serif;
        font-weight: 700;
        z-index: 45;
        pointer-events: none;
        display: none;
        white-space: nowrap;
        box-shadow: 0 4px 20px rgba(255, 209, 102, 0.5);
      }
      #gem-banner.pop {
        display: block;
        animation: gemPop 2.8s ease forwards;
      }
      @keyframes gemPop {
        0% {
          opacity: 0;
          transform: translateX(-50%) scale(0.4);
        }
        12% {
          opacity: 1;
          transform: translateX(-50%) scale(1.12);
        }
        22% {
          transform: translateX(-50%) scale(1);
        }
        78% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translateX(-50%) scale(0.8);
        }
      }

      /* â”€â”€ Pause screen â”€â”€ */
      #scr-pause {
        background: rgba(5, 1, 15, 0.92);
        backdrop-filter: blur(12px);
        justify-content: center;
        gap: 14px;
      }
      #scr-pause h2 {
        font-size: clamp(28px, 7vw, 52px);
        color: var(--c-yellow);
      }
      #scr-pause p {
        color: rgba(255, 255, 255, 0.5);
        font-family: "Nunito", sans-serif;
        font-size: clamp(11px, 1.9vw, 14px);
        text-align: center;
      }
      #countdown {
        font-size: clamp(64px, 16vw, 108px);
        color: var(--c-orange);
        text-shadow: 0 0 40px rgba(255, 107, 53, 0.6);
        display: none;
        line-height: 1;
      }

      /* â”€â”€ Game-over screen â”€â”€ */
      #scr-over {
        justify-content: center;
        gap: 8px;
      }
      #fail-title {
        font-size: clamp(22px, 5.5vw, 44px);
        line-height: 1.1;
        text-align: center;
      }
      .fail-msg {
        font-size: clamp(11px, 2.2vw, 15px);
        color: rgba(255, 200, 100, 0.9);
        text-align: center;
        font-family: "Nunito", sans-serif;
        max-width: 360px;
      }

      /* â”€â”€ Win screen â”€â”€ */
      #scr-win {
        justify-content: center;
        gap: 8px;
      }
      #scr-win h2 {
        font-size: clamp(20px, 5vw, 42px);
        color: var(--c-teal);
        text-shadow: 2px 2px 0 #028a66;
        text-align: center;
      }
      #win-canvas {
        border-radius: var(--r-md);
        background: #050218;
        flex-shrink: 0;
      }
      .win-story {
        font-size: clamp(11px, 2vw, 14px);
        font-family: "Nunito", sans-serif;
        color: rgba(255, 255, 255, 0.85);
        text-align: center;
        max-width: 400px;
        line-height: 1.7;
      }

      /* â”€â”€ About screen â”€â”€ */
      #scr-about {
        justify-content: flex-start;
        gap: 8px;
      }
      #scr-about h2 {
        font-size: clamp(20px, 4.5vw, 36px);
        color: var(--c-orange);
        align-self: center;
      }
      .about-card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.09);
        border-radius: var(--r-md);
        padding: 10px 14px;
        width: 100%;
        max-width: min(480px, 100%);
        align-self: center;
      }
      .about-card h3 {
        font-size: clamp(12px, 2.2vw, 16px);
        color: var(--c-yellow);
        margin-bottom: 5px;
      }
      .about-card p,
      .about-card li {
        font-size: clamp(10px, 1.8vw, 13px);
        font-family: "Nunito", sans-serif;
        color: rgba(255, 255, 255, 0.75);
        line-height: 1.7;
      }
      .about-card a {
        color: var(--c-teal);
      }
      .about-card ul {
        list-style: none;
      }
      .about-card li {
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        padding: 2px 0;
      }
      .about-card li strong {
        color: rgba(255, 220, 150, 0.9);
      }

      /* â”€â”€ Stat boxes (shared by over + win) â”€â”€ */
      .stat-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .stat-box {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--r-md);
        padding: 8px 14px;
        text-align: center;
        min-width: 68px;
      }
      .stat-box .sv {
        font-size: clamp(18px, 4vw, 28px);
        color: var(--c-yellow);
      }
      .stat-box .sl {
        font-size: clamp(9px, 1.6vw, 11px);
        font-family: "Nunito", sans-serif;
        color: rgba(255, 255, 255, 0.45);
      }

      /* â”€â”€ Buttons â”€â”€ */
      .btn-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
      }

      .btn-primary {
        background: var(--c-orange);
        color: white;
        border: none;
        padding: clamp(8px, 1.8vh, 14px) clamp(22px, 4vw, 42px);
        font-size: clamp(15px, 3.2vw, 22px);
        font-family: "Boogaloo", cursive;
        border-radius: var(--r-pill);
        cursor: pointer;
        letter-spacing: 1px;
        box-shadow:
          0 4px 0 var(--c-orange-d, #c23b0a),
          0 0 26px rgba(255, 107, 53, 0.35);
        transition:
          transform 0.1s,
          box-shadow 0.1s;
      }
      .btn-primary:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 var(--c-orange-d, #c23b0a);
      }

      .btn-teal {
        @extend .btn-primary;
        background: var(--c-teal);
        color: #0d1a14;
        box-shadow: 0 4px 0 #028a66;
      }
      .btn-teal {
        background: var(--c-teal);
        color: #0d1a14;
        border: none;
        padding: clamp(8px, 1.8vh, 12px) clamp(18px, 3.5vw, 30px);
        font-size: clamp(13px, 2.5vw, 18px);
        font-family: "Boogaloo", cursive;
        border-radius: var(--r-pill);
        cursor: pointer;
        box-shadow: 0 4px 0 #028a66;
      }
      .btn-red {
        background: var(--c-red);
        color: white;
        border: none;
        padding: clamp(8px, 1.8vh, 12px) clamp(18px, 3.5vw, 30px);
        font-size: clamp(13px, 2.5vw, 18px);
        font-family: "Boogaloo", cursive;
        border-radius: var(--r-pill);
        cursor: pointer;
        box-shadow: 0 4px 0 #a01030;
      }
      .btn-share {
        background: linear-gradient(135deg, var(--c-orange), var(--c-red));
        color: white;
        border: none;
        padding: clamp(8px, 1.8vh, 12px) clamp(18px, 3.5vw, 30px);
        font-size: clamp(13px, 2.5vw, 18px);
        font-family: "Boogaloo", cursive;
        border-radius: var(--r-pill);
        cursor: pointer;
        box-shadow: 0 4px 0 #a01030;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .btn-ghost {
        background: transparent;
        color: rgba(255, 255, 255, 0.55);
        border: 1px solid rgba(255, 255, 255, 0.18);
        padding: clamp(6px, 1.4vh, 10px) clamp(16px, 3vw, 26px);
        font-size: clamp(11px, 2vw, 14px);
        font-family: "Boogaloo", cursive;
        border-radius: var(--r-pill);
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-ghost:hover {
        color: white;
        border-color: rgba(255, 255, 255, 0.42);
      }

      /* â”€â”€ Players badge on home â”€â”€ */
      #player-count {
        font-size: clamp(10px, 1.8vw, 13px);
        color: rgba(255, 255, 255, 0.35);
        font-family: "Nunito", sans-serif;
        text-align: center;
      }
      #player-count span {
        color: var(--c-teal);
        font-weight: 700;
      }

      /* â”€â”€ Footer credit â”€â”€ */
      .made-with {
        position: absolute;
        bottom: clamp(3px, 1vw, 7px);
        left: 50%;
        transform: translateX(-50%);
        font-size: clamp(8px, 1.5vw, 11px);
        color: rgba(255, 255, 255, 0.2);
        font-family: "Nunito", sans-serif;
        white-space: nowrap;
        z-index: 5;
        pointer-events: all;
      }
      .made-with a {
        color: rgba(255, 255, 255, 0.38);
        text-decoration: none;
        transition: color 0.2s;
      }
      .made-with a:hover {
        color: rgba(255, 255, 255, 0.7);
      }

      /* â”€â”€ How to play screen â”€â”€ */
      #scr-how {
        justify-content: flex-start;
        gap: 8px;
      }
      #scr-how h2 {
        font-size: clamp(20px, 4.5vw, 36px);
        color: var(--c-yellow);
        align-self: center;
      }

      .ctrl-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        width: 100%;
        max-width: min(480px, 100%);
        align-self: center;
      }
      .ctrl-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--r-sm);
        padding: 8px 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .ctrl-key {
        background: rgba(255, 255, 255, 0.14);
        border-radius: 6px;
        padding: 3px 7px;
        font-size: clamp(9px, 1.7vw, 12px);
        color: var(--c-yellow);
        white-space: pre;
        min-width: 54px;
        text-align: center;
        line-height: 1.4;
      }
      .ctrl-desc {
        font-size: clamp(10px, 1.7vw, 12px);
        font-family: "Nunito", sans-serif;
        color: rgba(255, 255, 255, 0.75);
        line-height: 1.3;
      }

      .gem-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 5px;
        width: 100%;
        max-width: min(480px, 100%);
        align-self: center;
      }
      .gem-card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: var(--r-sm);
        padding: 5px 6px;
        text-align: center;
      }
      .gem-ico {
        font-size: clamp(14px, 2.8vw, 20px);
      }
      .gem-nm {
        font-size: clamp(8px, 1.4vw, 10px);
        font-family: "Nunito", sans-serif;
        color: rgba(255, 255, 255, 0.65);
        margin-top: 2px;
        line-height: 1.2;
      }

      .villain-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        justify-content: center;
        max-width: min(480px, 100%);
        align-self: center;
      }
      .vchip {
        background: rgba(255, 77, 109, 0.1);
        border: 1px solid rgba(255, 77, 109, 0.28);
        border-radius: 7px;
        padding: 3px 9px;
        font-size: clamp(9px, 1.6vw, 11px);
        font-family: "Nunito", sans-serif;
        color: rgba(255, 190, 190, 0.9);
      }

      /* Score popup float */
      .score-pop {
        position: absolute;
        pointer-events: none;
        font-family: "Boogaloo", cursive;
        font-size: clamp(12px, 2.3vw, 17px);
        z-index: 45;
        animation: floatUp 0.85s ease-out forwards;
      }
      @keyframes floatUp {
        0% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(-52px) scale(1.3);
        }
      }
    </style>
  </head>
  <body>
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DOM STRUCTURE
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="shell">
      <div id="gc">
        <!-- Main game canvas -->
        <canvas id="cv"></canvas>

        <!-- â”€â”€ Persistent top bar (always visible) â”€â”€ -->
        <div id="topbar">
          <button id="about-btn" onclick="showScr('scr-about')">
            ğŸ“– About
          </button>
          <button id="mute-btn" onclick="toggleMute()">ğŸ”Š</button>
          <a
            id="coffee-btn"
            href="https://buymeacoffee.com/allanito"
            target="_blank"
            onclick="onCoffeeClick()"
            >â˜• Buy me a coffee</a
          >
        </div>

        <!-- â”€â”€ HUD (gameplay only) â”€â”€ -->
        <div id="hud">
          <span id="hud-hearts">â¤ï¸â¤ï¸â¤ï¸</span>
          <span id="hud-level">LVL 1</span>
          <div id="hud-prog-wrap"><div id="hud-prog"></div></div>
          <span id="hud-gems">ğŸ’ 0</span>
          <span id="hud-score">0</span>
          <button id="hud-pause" onclick="togglePause()">â¸</button>
          <div id="immuno-badge">ğŸ›¡ï¸ IMMUNE</div>
        </div>

        <!-- â”€â”€ Dev mode badge â”€â”€ -->
        <div id="dev-badge">ğŸ”§ DEV MODE</div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TITLE / HOME SCREEN
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="scr-home" class="scr active">
          <canvas id="title-art-canvas"></canvas>
          <h1 class="game-title">PUNCH'S<br />GREAT ESCAPE</h1>
          <p class="game-subtitle">ğŸ§¸ THE PLUSHIE MUST BE RECLAIMED ğŸ§¸</p>
          <div class="story-box">
            The bully monkeys <strong>YOINKED</strong> Punch's beloved red
            plushie.<br />
            10 wild levels stand between him and getting it back.<br />
            <em>Jump. Slide. Survive. Reclaim.</em>
          </div>
          <div class="btn-row">
            <button class="btn-primary" onclick="goHowToPlay()">
              Start Game!! ğŸ’
            </button>
          </div>
          <button class="btn-ghost" onclick="startGame()">Skip intro â†’</button>
          <div class="best-row">
            ğŸ† Best score: <span id="best-score-el">â€”</span> &nbsp;|&nbsp; Max
            level: <span id="best-level-el">â€”</span>
          </div>
          <div id="player-count">
            ğŸ”¥ <span id="play-count-el">2,847</span> monkeys have played this
          </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HOW TO PLAY SCREEN
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="scr-how" class="scr">
          <h2>ğŸ® How to Play</h2>
          <!-- Control grid filled by JS so mobile/desktop differ -->
          <div class="ctrl-grid" id="ctrl-grid-el"></div>
          <div
            style="
              font-size: clamp(10px, 1.9vw, 14px);
              color: var(--c-yellow);
              text-align: center;
            "
          >
            âš ï¸ Villain gang â€” Jump or Slide!
          </div>
          <div class="villain-chips" id="villain-chips-el"></div>
          <div
            style="
              font-size: clamp(10px, 1.8vw, 13px);
              color: var(--c-violet);
              text-align: center;
            "
          >
            âœ¨ Collect gems for powers!
          </div>
          <div class="gem-grid" id="gem-grid-el"></div>
          <div
            class="about-card"
            style="padding: 8px 14px; max-width: min(480px, 100%)"
          >
            <p>
              ğŸ¯ <strong>Goal:</strong> Beat all 10 levels by clearing enough
              obstacles each level.<br />Level 1 = 10 obstacles. Each level adds
              1 more.<br />Collect â¤ï¸ gems to gain lives, ğŸ”® for immunity!
            </p>
          </div>
          <div class="btn-row">
            <button class="btn-primary" onclick="startGame()">
              Let's GO! ğŸš€
            </button>
            <button class="btn-ghost" onclick="showScr('scr-home')">
              â† Back
            </button>
          </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ABOUT SCREEN
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="scr-about" class="scr">
          <h2>ğŸ“– About</h2>
          <div class="about-card">
            <h3>ğŸ’ The Story</h3>
            <p>
              Inspired by the viral <strong>Punch monkey trend</strong> that
              swept Instagram in early 2026 â€” a tiny monkey and his beloved red
              plushie. The bully gang took it. He's going to get it back.
            </p>
          </div>
          <div class="about-card">
            <h3>ğŸ‘¨â€ğŸ’» The Creator</h3>
            <p>
              <strong>Allan</strong> saw the Punch trend and decided to jump in
              to spread some love. Built this in under a day.<br />
              <a href="https://github.com/alton47" target="_blank"
                >@alton47 on GitHub</a
              >
              &nbsp;â€¢&nbsp;
              <a href="https://buymeacoffee.com/allanito" target="_blank"
                >Buy him a coffee â˜•</a
              >
            </p>
          </div>
          <div class="about-card">
            <h3>ğŸ‘¿ The Villain Gang</h3>
            <ul id="villain-about-el"></ul>
          </div>
          <div class="about-card">
            <h3>âœ¨ Gem Powers</h3>
            <ul id="gem-about-el"></ul>
          </div>
          <div class="about-card">
            <h3>ğŸ¯ The Mission</h3>
            <p>
              Fight through all <strong>10 levels</strong>. Collect the ğŸ”®
              Immunity Orb (ultra rare!) to go invincible. Reach level 10 â€”
              watch Punch finally sleep peacefully next to his plushie.
              <strong>Emotional. Dope. Free.</strong>
            </p>
          </div>
          <div class="btn-row">
            <button class="btn-primary" onclick="startGame()">
              Play Now ğŸ’
            </button>
            <button class="btn-ghost" onclick="showScr('scr-home')">
              â† Back
            </button>
          </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PAUSE SCREEN
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="scr-pause" class="scr">
          <h2>â¸ PAUSED</h2>
          <p>Press P / ESC or tap Resume</p>
          <div id="countdown"></div>
          <div class="btn-row">
            <button class="btn-primary" onclick="resumeGame()">â–¶ Resume</button>
            <button class="btn-ghost" onclick="goHome()">Main Menu</button>
          </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GAME OVER SCREEN
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="scr-over" class="scr">
          <h2 id="fail-title">ğŸ’€ GOT CAUGHT</h2>
          <p class="fail-msg" id="fail-msg">The gang caught up...</p>
          <div class="stat-row">
            <div class="stat-box">
              <div class="sv" id="go-score">0</div>
              <div class="sl">Score</div>
            </div>
            <div class="stat-box">
              <div class="sv" id="go-level">1</div>
              <div class="sl">Level</div>
            </div>
            <div class="stat-box">
              <div class="sv" id="go-best">0</div>
              <div class="sl">Best</div>
            </div>
            <div class="stat-box">
              <div class="sv" id="go-maxlvl">1</div>
              <div class="sl">Max LVL</div>
            </div>
          </div>
          <div
            id="go-gems-info"
            style="
              font-size: clamp(10px, 1.8vw, 13px);
              color: rgba(200, 180, 255, 0.8);
              font-family: Nunito, sans-serif;
              text-align: center;
            "
          ></div>
          <div
            id="continue-info"
            style="
              font-size: clamp(10px, 1.7vw, 12px);
              color: rgba(255, 255, 255, 0.5);
              font-family: Nunito, sans-serif;
              text-align: center;
            "
          ></div>
          <div class="btn-row">
            <button class="btn-teal" id="cont-btn" onclick="continueRun()">
              Continue â¤ï¸
            </button>
            <button class="btn-red" onclick="restartGame()">Restart ğŸ”„</button>
            <button class="btn-share" onclick="shareScore('over')">
              ğŸ“¤ Share
            </button>
          </div>
          <button class="btn-ghost" onclick="goHome()">Main Menu</button>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       WIN SCREEN
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="scr-win" class="scr">
          <h2>ğŸ§¸ PLUSHIE RECLAIMED!</h2>
          <canvas id="win-canvas"></canvas>
          <p class="win-story">
            Punch ran through jungle, ruins, storms and pure chaos...<br />and
            he finally made it. He curled up with the red plushie,<br /><strong
              >finally at peace. ğŸ’›</strong
            >
          </p>
          <div class="stat-row" style="justify-content: center">
            <div class="stat-box">
              <div class="sv" id="win-score">0</div>
              <div class="sl">Score</div>
            </div>
            <div class="stat-box">
              <div class="sv" id="win-time">0s</div>
              <div class="sl">Time</div>
            </div>
            <div class="stat-box">
              <div class="sv" id="win-gems">0</div>
              <div class="sl">Gems</div>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn-share" onclick="shareScore('win')">
              ğŸ“¤ Share Victory!
            </button>
            <button class="btn-primary" onclick="restartGame()">
              Play Again ğŸ’
            </button>
          </div>
        </div>

        <!-- â”€â”€ Level toast â”€â”€ -->
        <div id="level-toast">
          <div id="toast-lvl">1</div>
          <div id="toast-name">Monkey Zoo</div>
          <div id="toast-desc">Welcome to the zoo!</div>
        </div>

        <!-- â”€â”€ Tutorial overlay â”€â”€ -->
        <div id="tutorial-box">
          <div id="tut-icon">â¬†ï¸</div>
          <div id="tut-text">An obstacle is coming!</div>
          <div id="tut-key">SPACE / â†‘ / W or Swipe Up</div>
        </div>

        <!-- â”€â”€ Gem banner â”€â”€ -->
        <div id="gem-banner"></div>

        <!-- â”€â”€ Mobile controls (touch devices only) â”€â”€ -->
        <div id="mob-ctrl">
          <div
            class="mob-btn"
            id="mob-slide"
            ontouchstart="event.preventDefault();mobileSlide(true)"
            ontouchend="event.preventDefault();mobileSlide(false)"
          >
            â†“
          </div>
          <div
            class="mob-btn"
            id="mob-jump"
            ontouchstart="event.preventDefault();mobileJump()"
          >
            â†‘
          </div>
        </div>

        <!-- â”€â”€ Footer â”€â”€ -->
        <div class="made-with">
          made with â¤ï¸
          <a href="https://github.com/alton47" target="_blank">Allan</a>
        </div>
      </div>
      <!-- /gc -->
    </div>
    <!-- /shell -->

    <script>
      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PUNCH'S GREAT ESCAPE  V4
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Architecture:
   â€¢ Delta-time based physics â€” correct on any refresh rate
   â€¢ Single canvas, scales to fill viewport preserving 800:340 ratio
   â€¢ Web Audio API custom sounds â€” zero copyright
   â€¢ localStorage persistence for best score/level
   â€¢ Tutorial system for level 1
   â€¢ 10 named villains, 8 gem types incl immunity + magnet
   â€¢ Full mobile touch + swipe + on-screen buttons
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      // â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      /** Design-space dimensions â€” all game logic runs in these units,
    then the canvas transform scales them to the actual pixels.   */
      const DS_W = 800; // design-space width
      const DS_H = 300; // design-space height
      const DS_GR = 245; // ground Y in design-space

      /** Physics in design-space units per second */
      const GRAVITY = 1800; // px/sÂ²
      const JUMP_VEL = -620; // px/s  (first jump)
      const DJUMP_VEL = -520; // px/s  (double jump)
      const BASE_SPEED = 280; // px/s at level 1

      /** Target FPS for animation limiter (optional) */
      const TARGET_FPS = 60;

      // â”€â”€â”€ GAME DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      /** Villain roster. Each villain unlocks at a specific tier/level. */
      const VILLAINS = [
        {
          id: "slider",
          name: "Knuckles",
          color: "#ef476f",
          tier: 1,
          action: "JUMP",
          desc: "Slides low. Jump over!",
        },
        {
          id: "jumper",
          name: "Bobo",
          color: "#ff9f1c",
          tier: 1,
          action: "JUMP",
          desc: "Mid-height. Jump over!",
        },
        {
          id: "vine",
          name: "Creepvine",
          color: "#06d6a0",
          tier: 1,
          action: "DUCK",
          desc: "Hanging vine. Duck under!",
        },
        {
          id: "stone",
          name: "Rockhead",
          color: "#94a3b8",
          tier: 2,
          action: "JUMP",
          desc: "Big stone. Jump over!",
        },
        {
          id: "peel",
          name: "Slippy",
          color: "#fdd835",
          tier: 2,
          action: "JUMP",
          desc: "Banana peel. Jump over!",
        },
        {
          id: "bigbobo",
          name: "BIG Bobo",
          color: "#f97316",
          tier: 3,
          action: "HIGH",
          desc: "Tall monkey. High jump!",
        },
        {
          id: "swinger",
          name: "Swingby",
          color: "#a855f7",
          tier: 3,
          action: "DUCK",
          desc: "Swings from above. Duck!",
        },
        {
          id: "twintrap",
          name: "Twin Trap",
          color: "#ec4899",
          tier: 4,
          action: "JUMP",
          desc: "Two at once. Stay sharp!",
        },
        {
          id: "boulder",
          name: "Crusher",
          color: "#6b7280",
          tier: 4,
          action: "JUMP",
          desc: "Rolling boulder. Jump!",
        },
        {
          id: "spike",
          name: "Stabby",
          color: "#ef4444",
          tier: 5,
          action: "HIGH",
          desc: "Spike wall. Highest jump!",
        },
      ];

      /** Gem roster. rarity = spawn probability weight (0â€“1). */
      const GEMS = [
        {
          id: "coin",
          emoji: "ğŸª™",
          name: "Gold Coin",
          pts: 30,
          rarity: 0.52,
          color: "#ffd166",
          effect: "pts",
          desc: "+30 pts",
        },
        {
          id: "banana",
          emoji: "ğŸŒ",
          name: "Banana",
          pts: 50,
          rarity: 0.22,
          color: "#fdd835",
          effect: "pts",
          desc: "+50 pts",
        },
        {
          id: "ruby",
          emoji: "ğŸ’",
          name: "Ruby Gem",
          pts: 120,
          rarity: 0.1,
          color: "#ff4d6d",
          effect: "pts",
          desc: "+120 pts",
        },
        {
          id: "heart",
          emoji: "â¤ï¸",
          name: "Heart Gem",
          pts: 0,
          rarity: 0.06,
          color: "#ff6b6b",
          effect: "life",
          desc: "+1 heart!",
        },
        {
          id: "star",
          emoji: "â­",
          name: "Lucky Star",
          pts: 200,
          rarity: 0.04,
          color: "#ffd166",
          effect: "pts",
          desc: "+200 pts (rare!)",
        },
        {
          id: "magnet",
          emoji: "ğŸ§²",
          name: "Magnet",
          pts: 40,
          rarity: 0.03,
          color: "#f472b6",
          effect: "magnet",
          desc: "Auto-collect gems 5s!",
        },
        {
          id: "orb",
          emoji: "ğŸ”®",
          name: "Immunity Orb",
          pts: 80,
          rarity: 0.02,
          color: "#c084fc",
          effect: "immuno",
          desc: "5s immunity! (RARE!)",
        },
        {
          id: "diamond",
          emoji: "ğŸ’ ",
          name: "Diamond Shard",
          pts: 400,
          rarity: 0.01,
          color: "#67e8f9",
          effect: "pts",
          desc: "+400 pts (ULTRA RARE!)",
        },
      ];

      /** Level configuration. obsCount = obstacles needed to pass the level. */
      const LEVELS = [
        {
          n: 1,
          name: "Monkey Zoo",
          emoji: "ğŸ›ï¸",
          bg: "zoo",
          speedMult: 1.0,
          obsCount: 10,
          music: "calm",
          desc: "Welcome to the zoo!",
        },
        {
          n: 2,
          name: "Bamboo Forest",
          emoji: "ğŸ‹",
          bg: "bamboo",
          speedMult: 1.05,
          obsCount: 11,
          music: "calm",
          desc: "Watch the bamboo!",
        },
        {
          n: 3,
          name: "River Banks",
          emoji: "ğŸŒŠ",
          bg: "river",
          speedMult: 1.1,
          obsCount: 12,
          music: "calm",
          desc: "Slippery out here!",
        },
        {
          n: 4,
          name: "Ancient Ruins",
          emoji: "ğŸ›ï¸",
          bg: "ruins",
          speedMult: 1.15,
          obsCount: 13,
          music: "tense",
          desc: "The ruins shift...",
        },
        {
          n: 5,
          name: "Mushroom Grove",
          emoji: "ğŸ„",
          bg: "mushroom",
          speedMult: 1.22,
          obsCount: 14,
          music: "tense",
          desc: "Things get weird.",
        },
        {
          n: 6,
          name: "Crystal Cave",
          emoji: "ğŸ’",
          bg: "cave",
          speedMult: 1.3,
          obsCount: 15,
          music: "dark",
          desc: "Dark & dangerous.",
        },
        {
          n: 7,
          name: "Volcano Edge",
          emoji: "ğŸŒ‹",
          bg: "volcano",
          speedMult: 1.38,
          obsCount: 16,
          music: "dark",
          desc: "HOT. HOT. HOT.",
        },
        {
          n: 8,
          name: "Moonlit Path",
          emoji: "ğŸŒ™",
          bg: "moon",
          speedMult: 1.47,
          obsCount: 17,
          music: "dark",
          desc: "Almost there...",
        },
        {
          n: 9,
          name: "Storm Valley",
          emoji: "âš¡",
          bg: "storm",
          speedMult: 1.56,
          obsCount: 18,
          music: "intense",
          desc: "The final stretch!",
        },
        {
          n: 10,
          name: "The Plushie!!!",
          emoji: "ğŸ§¸",
          bg: "final",
          speedMult: 1.65,
          obsCount: 20,
          music: "intense",
          desc: "THIS IS IT!! ğŸ”¥",
        },
      ];

      /** Fail messages cycled randomly on game over. */
      const FAILS = [
        {
          title: "ğŸ’€ BONKED!",
          msg: "A rock to the skull. Seeing stars. â­",
          col: "#ff4d6d",
        },
        {
          title: "ğŸŒ SLIPPED!",
          msg: "Classic banana peel. No shame, really.",
          col: "#ffd166",
        },
        {
          title: "ğŸ’ TACKLED!",
          msg: "Knuckles body-slammed him. Respect.",
          col: "#ff9f1c",
        },
        {
          title: "ğŸŒ¿ TANGLED!",
          msg: "Creepvine grabbed him mid-stride.",
          col: "#06d6a0",
        },
        {
          title: "ğŸª¨ CRUSHED!",
          msg: "Crusher rolled right over poor Punch.",
          col: "#94a3b8",
        },
        {
          title: "ğŸ‘¿ AMBUSHED!",
          msg: "Twin Trap had this planned all along.",
          col: "#ec4899",
        },
        {
          title: "âš¡ SPIKED!",
          msg: "Stabby appeared from nowhere. Gone.",
          col: "#ef4444",
        },
        {
          title: "ğŸ˜µ OVERWHELMED!",
          msg: "The whole gang showed up. It's a party.",
          col: "#a855f7",
        },
      ];

      /** Tutorial steps for level 1. */
      const TUTORIAL_STEPS = [
        {
          trigger: "start",
          icon: "â¤ï¸",
          text: "You have 3 hearts. Lose them all and it's over.",
          key: "Tap to continue!",
        },
        {
          trigger: "obs_jump",
          icon: "â¬†ï¸",
          text: "Jump over this obstacle!",
          key: "SPACE / â†‘ / W   or   Swipe Up",
        },
        {
          trigger: "obs_duck",
          icon: "â¬‡ï¸",
          text: "Duck under this vine!",
          key: "â†“ / S   or   Swipe Down",
        },
        {
          trigger: "gem_intro",
          icon: "ğŸ’",
          text: "Collect gems for points & powers!\nDouble-tap jump for extra height!",
          key: "Jump twice quickly!",
        },
      ];

      // â”€â”€â”€ DOM REFS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const cv = document.getElementById("cv");
      const ctx = cv.getContext("2d");
      const gcEl = document.getElementById("gc");
      const hudEl = document.getElementById("hud");
      const mobCtrl = document.getElementById("mob-ctrl");
      const devBadge = document.getElementById("dev-badge");
      const gemBanner = document.getElementById("gem-banner");
      const immunoBadge = document.getElementById("immuno-badge");
      const levelToast = document.getElementById("level-toast");
      const tutBox = document.getElementById("tutorial-box");

      // â”€â”€â”€ RESIZE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      /**
       * Scales the game container so it FILLS the viewport while
       * keeping the 800:340 design ratio. Uses CSS transform scale
       * so the canvas always draws at native resolution.
       */
      let scale = 1;

      function resize() {
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const ratio = DS_W / DS_H;

        // Fit the design space into the viewport
        let displayW, displayH;
        if (vw / vh > ratio) {
          displayH = Math.min(vh, 600);
          displayW = Math.round(displayH * ratio);
        } else {
          displayW = Math.min(vw, 960);
          displayH = Math.round(displayW / ratio);
        }

        // Canvas always renders at design resolution for crisp drawing
        cv.width = DS_W;
        cv.height = DS_H;

        // Scale the container to fill the screen
        scale = displayW / DS_W;
        gcEl.style.width = DS_W + "px";
        gcEl.style.height = DS_H + "px";
        gcEl.style.transform = `scale(${scale})`;
        gcEl.style.transformOrigin = "center center";

        // Shell centers it
        document.getElementById("shell").style.width = displayW + "px";
        document.getElementById("shell").style.height = displayH + "px";

        // Rebuild title art at correct display size
        renderTitleArt();

        // Win canvas
        const wc = document.getElementById("win-canvas");
        wc.width = 300;
        wc.height = 140;
      }

      window.addEventListener("resize", resize);

      // â”€â”€â”€ AUDIO ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      /**
       * Completely custom Web Audio API sounds.
       * Zero external assets, zero copyright.
       * Uses the pentatonic scale for all music (D pentatonic).
       */
      let audioCtx;
      let isMuted = false;
      let bgMusicTimeout = null;
      let bgMusicPhase = 0;

      /** Get or create AudioContext (lazy init to avoid autoplay policy). */
      function getAC() {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        return audioCtx;
      }

      /**
       * @param {number} freq
       * @param {OscillatorType} type
       * @param {number} dur  seconds
       * @param {number} vol  0â€“1
       * @param {number} delay  seconds (from now)
       */
      function tone(freq, type, dur, vol = 0.22, delay = 0) {
        if (isMuted) return;
        try {
          const ac = getAC();
          const o = ac.createOscillator();
          const g = ac.createGain();
          o.connect(g);
          g.connect(ac.destination);
          o.type = type;
          o.frequency.setValueAtTime(freq, ac.currentTime + delay);
          g.gain.setValueAtTime(0, ac.currentTime + delay);
          g.gain.linearRampToValueAtTime(vol, ac.currentTime + delay + 0.015);
          g.gain.exponentialRampToValueAtTime(
            0.0001,
            ac.currentTime + delay + dur,
          );
          o.start(ac.currentTime + delay);
          o.stop(ac.currentTime + delay + dur + 0.05);
        } catch (e) {}
      }

      function noiseSwish(dur = 0.12, vol = 0.15) {
        if (isMuted) return;
        try {
          const ac = getAC();
          const buf = ac.createBuffer(
            1,
            Math.floor(ac.sampleRate * dur),
            ac.sampleRate,
          );
          const d = buf.getChannelData(0);
          for (let i = 0; i < d.length; i++)
            d[i] = (Math.random() * 2 - 1) * (1 - i / d.length);
          const src = ac.createBufferSource();
          const g = ac.createGain();
          src.buffer = buf;
          src.connect(g);
          g.connect(ac.destination);
          g.gain.setValueAtTime(vol, ac.currentTime);
          g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + dur);
          src.start();
        } catch (e) {}
      }

      // D-pentatonic scale frequencies
      const PENTA = [
        293.66, 329.63, 392, 440, 493.88, 587.33, 659.25, 783.99, 880,
      ];
      // Darker, more mysterious minor-ish phrases
      const PHRASES = {
        calm: [
          [4, 6, 7, 6, 4, 2, 0, 2, 4, 2],
          [0, 2, 4, 2, 0, 4, 6, 7, 6, 4],
        ],
        tense: [
          [2, 4, 6, 4, 2, 0, 2, 4, 0, 2],
          [0, 1, 3, 4, 3, 1, 0, 3, 4, 6],
        ],
        dark: [
          [3, 1, 0, 1, 3, 4, 3, 1, 0, 3],
          [0, 3, 4, 3, 0, 1, 3, 1, 0, 4],
        ],
        intense: [
          [4, 6, 7, 8, 7, 6, 4, 3, 1, 0],
          [7, 6, 4, 3, 1, 0, 1, 3, 4, 6],
        ],
        end: [
          [0, 2, 4, 6, 7, 6, 4, 2, 0, 2],
          [4, 6, 7, 6, 4, 2, 4, 6, 7, 4],
        ],
      };

      function startBgMusic(mood = "calm") {
        stopBgMusic();
        if (isMuted) return;
        const phraseSet = PHRASES[mood] || PHRASES.calm;
        const phrase = phraseSet[bgMusicPhase % phraseSet.length];
        bgMusicPhase++;
        const tempo =
          mood === "calm"
            ? 0.42
            : mood === "end"
              ? 0.5
              : mood === "intense"
                ? 0.3
                : 0.36;
        let step = 0;

        function nextNote() {
          if (isMuted) return;
          const idx = phrase[step % phrase.length];
          const freq = PENTA[idx];
          // Flute-like synthesis: sine + harmonics + occasional pad
          tone(freq, "sine", tempo * 0.78, 0.13);
          tone(freq * 2, "sine", tempo * 0.4, 0.035);
          tone(freq * 3, "sine", tempo * 0.2, 0.015);
          if (step % 4 === 0) tone(freq * 0.5, "triangle", tempo * 2.2, 0.06); // bass pad
          if (step % 8 === 0)
            tone(
              PENTA[Math.floor(Math.random() * PENTA.length)],
              "sine",
              tempo * 1.5,
              0.025,
            ); // wind
          step++;
          if (step < phrase.length * 2) {
            bgMusicTimeout = setTimeout(nextNote, tempo * 1000);
          } else {
            bgMusicTimeout = setTimeout(() => startBgMusic(mood), 400);
          }
        }
        nextNote();
      }

      function stopBgMusic() {
        if (bgMusicTimeout) {
          clearTimeout(bgMusicTimeout);
          bgMusicTimeout = null;
        }
      }

      function toggleMute() {
        isMuted = !isMuted;
        document.getElementById("mute-btn").textContent = isMuted ? "ğŸ”‡" : "ğŸ”Š";
        if (isMuted) {
          stopBgMusic();
        } else {
          // Resume appropriate music
          const mood =
            gameState === "playing"
              ? LEVELS[level - 1]?.music || "calm"
              : "calm";
          startBgMusic(mood);
        }
      }

      /** SFX bundle â€” named for clarity */
      const SFX = {
        jump: () => {
          tone(440, "sine", 0.12, 0.18);
          tone(600, "sine", 0.08, 0.1, 0.07);
        },
        djump: () => {
          tone(660, "triangle", 0.1, 0.18);
          tone(880, "sine", 0.1, 0.14, 0.06);
        },
        slide: () => {
          noiseSwish(0.1, 0.18);
          tone(220, "sine", 0.08, 0.08);
        },
        hit: () => {
          tone(160, "square", 0.18, 0.24);
          tone(110, "sawtooth", 0.14, 0.18, 0.06);
          setTimeout(() => SFX.mkCry(), 150);
        },
        mkCry: () => {
          tone(340, "sine", 0.07, 0.1);
          tone(260, "sine", 0.1, 0.08, 0.07);
          tone(190, "sine", 0.14, 0.07, 0.14);
        },
        mkPass: () => {
          noiseSwish(0.07, 0.08);
          tone(380, "sawtooth", 0.05, 0.05);
        }, // whoosh past
        gem: () => {
          tone(880, "sine", 0.06, 0.18);
          tone(1100, "sine", 0.08, 0.14, 0.05);
        },
        rare: () => {
          [784, 1047, 1319, 1568].forEach((f, i) =>
            tone(f, "triangle", 0.28, 0.16, i * 0.09),
          );
        },
        immuno: () => {
          tone(523, "sine", 0.2, 0.2);
          tone(659, "sine", 0.2, 0.18, 0.08);
          tone(784, "sine", 0.25, 0.2, 0.16);
          tone(1047, "sine", 0.3, 0.22, 0.24);
          SFX.rare();
        },
        magnet: () => {
          tone(440, "triangle", 0.12, 0.18);
          tone(660, "triangle", 0.1, 0.14, 0.08);
          tone(880, "sine", 0.1, 0.12, 0.16);
        },
        lvlUp: () => {
          [392, 523, 659, 784].forEach((f, i) =>
            tone(f, "sine", 0.22, 0.2, i * 0.1),
          );
        },
        death: () => {
          tone(300, "square", 0.1, 0.22);
          tone(200, "square", 0.15, 0.2, 0.1);
          tone(100, "sawtooth", 0.3, 0.28, 0.22);
        },
        win: () => {
          [523, 659, 784, 1047, 784, 1047, 1319, 1047].forEach((f, i) =>
            tone(f, "sine", 0.3, 0.22, i * 0.16),
          );
        },
        countdown: () => {
          tone(440, "triangle", 0.2, 0.22);
        },
        go: () => {
          tone(660, "sine", 0.15, 0.3);
          tone(880, "sine", 0.2, 0.25, 0.12);
        },
        wind: () => {
          if (isMuted) return;
          try {
            const ac = getAC(),
              o = ac.createOscillator(),
              g = ac.createGain();
            o.connect(g);
            g.connect(ac.destination);
            o.type = "sine";
            o.frequency.setValueAtTime(70, ac.currentTime);
            o.frequency.linearRampToValueAtTime(130, ac.currentTime + 1.8);
            g.gain.setValueAtTime(0.03, ac.currentTime);
            g.gain.linearRampToValueAtTime(0.07, ac.currentTime + 0.8);
            g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + 2.6);
            o.start();
            o.stop(ac.currentTime + 3);
          } catch (e) {}
        },
      };

      // â”€â”€â”€ GAME STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let gameState = "home"; // home|howtoplay|playing|paused|over|won|transition

      // Runtime
      let score = 0;
      let level = 1;
      let lives = 3;
      let obsBeaten = 0;
      let obsNeeded = 10;
      let gemsCollected = 0;
      let gemsTotal = 0;
      let gemTypesFound = {}; // { gemId: count }
      let devMode = false;
      let magnetTimer = 0; // frames remaining for magnet effect
      let immunoTimer = 0; // frames remaining for immunity
      let speedBoostTimer = 0;
      let startTime = 0; // Date.now() at game start

      // Persistence
      let bestScore = 0;
      let bestLevel = 1;

      // Delta time
      let lastTS = 0; // timestamp of last frame

      // Object pools
      let particles = [];
      let obstacles = [];
      let collectibles = [];

      // Spawn cooldowns (in seconds)
      let obsSpawnCD = 1.5;
      let colSpawnCD = 1.8;
      let bgX = [0, 0, 0]; // parallax layer offsets

      // Tutorial
      let tutorialActive = false;
      let tutStep = 0;
      let tutWaitingForAct = false; // game paused mid-tutorial
      let tutObsShown = { jump: false, duck: false, gem: false };

      // â”€â”€â”€ PUNCH OBJECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const P = {
        x: 120,
        y: DS_GR,
        vy: 0,
        jumpCount: 0,
        jumping: false,
        sliding: false,
        slideTimer: 0,
        animFrame: 0,
        animTimer: 0,
        // Hit-box helpers
        get hitY() {
          return this.y - (this.sliding ? this.h * 0.5 : this.h);
        },
        get hitH() {
          return this.sliding ? this.h * 0.5 : this.h;
        },
        w: 40,
        h: 50,
      };

      function resetPunch() {
        P.x = 120;
        P.y = DS_GR;
        P.vy = 0;
        P.jumpCount = 0;
        P.jumping = false;
        P.sliding = false;
        P.slideTimer = 0;
        P.animFrame = 0;
        P.animTimer = 0;
      }

      // â”€â”€â”€ PERSISTENCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function loadPersisted() {
        try {
          bestScore = parseInt(localStorage.getItem("pm_best") || "0");
          bestLevel = parseInt(localStorage.getItem("pm_bestlv") || "1");
        } catch (e) {}
        document.getElementById("best-score-el").textContent = bestScore || "â€”";
        document.getElementById("best-level-el").textContent =
          bestLevel > 1 ? bestLevel : "â€”";
      }

      function savePersisted() {
        try {
          if (score > bestScore) {
            bestScore = score;
            localStorage.setItem("pm_best", bestScore);
          }
          if (level > bestLevel) {
            bestLevel = level;
            localStorage.setItem("pm_bestlv", bestLevel);
          }
        } catch (e) {}
      }

      loadPersisted();

      // Fake player count (seeded, grows over time)
      (function initPlayerCount() {
        const BASE = 2847;
        const stored = parseInt(localStorage.getItem("pm_plays") || "0");
        const shown = BASE + stored;
        document.getElementById("play-count-el").textContent =
          shown.toLocaleString();
      })();

      function bumpPlayCount() {
        try {
          const n = parseInt(localStorage.getItem("pm_plays") || "0") + 1;
          localStorage.setItem("pm_plays", n);
          document.getElementById("play-count-el").textContent = (
            2847 + n
          ).toLocaleString();
        } catch (e) {}
      }

      // â”€â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const keysDown = {};

      document.addEventListener("keydown", (e) => {
        if (keysDown[e.code]) return;
        keysDown[e.code] = true;

        // Wake audio context on first key
        getAC().resume?.();

        if (gameState === "playing") {
          if (["Space", "ArrowUp", "KeyW"].includes(e.code)) {
            e.preventDefault();
            doJump();
          }
          if (["ArrowDown", "KeyS"].includes(e.code)) {
            e.preventDefault();
            doSlide();
          }
          if (e.code === "ArrowRight") speedBoostTimer = 80;
          if (e.code === "KeyL") toggleDevMode();
        }
        if (
          ["KeyP", "Escape"].includes(e.code) &&
          (gameState === "playing" || gameState === "paused")
        ) {
          e.preventDefault();
          togglePause();
        }
      });

      document.addEventListener("keyup", (e) => {
        keysDown[e.code] = false;
        if (["ArrowDown", "KeyS"].includes(e.code)) {
          P.sliding = false;
          P.slideTimer = 0;
        }
        if (e.code === "ArrowRight") speedBoostTimer = 0;
      });

      // Touch / swipe on canvas
      let touchStartY = 0,
        touchStartX = 0,
        touchStartTime = 0;

      cv.addEventListener(
        "touchstart",
        (e) => {
          touchStartY = e.touches[0].clientY;
          touchStartX = e.touches[0].clientX;
          touchStartTime = Date.now();
          getAC().resume?.();
        },
        { passive: true },
      );

      cv.addEventListener(
        "touchend",
        (e) => {
          if (gameState !== "playing") return;
          const dy = touchStartY - e.changedTouches[0].clientY;
          const dx = touchStartX - e.changedTouches[0].clientX;
          const dt = Date.now() - touchStartTime;
          if (Math.abs(dy) > Math.abs(dx)) {
            if (dy > 18) doJump();
            else if (dy < -18) {
              P.sliding = true;
              P.slideTimer = 0.4;
            }
          } else {
            if (dx > 30 && dt < 300) speedBoostTimer = 80;
            if (Math.abs(dy) < 15 && Math.abs(dx) < 20) doJump(); // tap = jump
          }
        },
        { passive: true },
      );

      function mobileJump() {
        getAC().resume?.();
        if (gameState === "playing") doJump();
      }
      function mobileSlide(active) {
        if (active) {
          P.sliding = true;
          P.slideTimer = 0.4;
        } else {
          P.sliding = false;
          P.slideTimer = 0;
        }
      }

      // â”€â”€â”€ JUMP / SLIDE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function doJump() {
        if (tutorialActive && tutWaitingForAct) {
          advanceTutorial();
          return;
        }
        if (P.jumpCount < 2) {
          P.vy = P.jumpCount === 0 ? JUMP_VEL : DJUMP_VEL;
          P.jumping = true;
          P.jumpCount++;
          P.sliding = false;
          spawnParticles(P.x + P.w / 2, P.y, "#ffd166", 5);
          P.jumpCount === 1 ? SFX.jump() : SFX.djump();
        }
      }

      function doSlide() {
        if (!P.jumping) {
          if (!P.sliding) SFX.slide();
          P.sliding = true;
          P.slideTimer = 0.4; // seconds
        }
      }

      // â”€â”€â”€ DEV MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function toggleDevMode() {
        devMode = !devMode;
        devBadge.classList.toggle("visible", devMode);
        if (devMode) lives = Math.max(lives, 5);
        document.getElementById("hud-hearts").textContent = heartStr();
        SFX.rare();
      }

      // â”€â”€â”€ SCREEN SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function showScr(id) {
        document
          .querySelectorAll(".scr")
          .forEach((s) => s.classList.remove("active"));
        if (id) document.getElementById(id).classList.add("active");
      }

      function showHUD(v) {
        hudEl.classList.toggle("visible", v);
        // Mobile controls only on touch devices
        const touch = "ontouchstart" in window || navigator.maxTouchPoints > 0;
        mobCtrl.classList.toggle("visible", v && touch);
      }

      // â”€â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function goHowToPlay() {
        buildHowToPlayContent();
        showScr("scr-how");
        startBgMusic("calm");
      }

      function goHome() {
        gameState = "home";
        stopBgMusic();
        cancelAnimationFrame(animId);
        showScr("scr-home");
        showHUD(false);
        loadPersisted();
        tutBox.style.display = "none";
        startBgMusic("calm");
      }

      function onCoffeeClick() {
        if (gameState === "playing") {
          gameState = "paused";
          stopBgMusic();
          showScr("scr-pause");
        }
      }

      // â”€â”€â”€ HOW TO PLAY CONTENT BUILDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function buildHowToPlayContent() {
        const touch = "ontouchstart" in window || navigator.maxTouchPoints > 0;

        // Controls grid
        const controls = touch
          ? [
              { k: "Tap / Swipe â†‘", d: "Jump (tap twice = double jump!)" },
              { k: "Swipe â†“", d: "Slide / duck under vines" },
              { k: "Swipe â†’", d: "Speed burst!" },
              { k: "P / ESC", d: "Pause â€” 3-2-1 countdown to resume" },
            ]
          : [
              { k: "SPACE / â†‘ / W", d: "Jump (double-tap = double jump!)" },
              { k: "â†“ / S", d: "Slide / duck under vines" },
              { k: "â†’ / ArrowRight", d: "Speed burst!" },
              { k: "P / ESC", d: "Pause â€” 3-2-1 countdown to resume" },
              { k: "L key", d: "ğŸ”§ Dev mode (slow + no death)" },
            ];

        document.getElementById("ctrl-grid-el").innerHTML = controls
          .map(
            (c) =>
              `<div class="ctrl-card"><div class="ctrl-key">${c.k}</div><div class="ctrl-desc">${c.d}</div></div>`,
          )
          .join("");

        document.getElementById("villain-chips-el").innerHTML = VILLAINS.map(
          (v) => `<div class="vchip">${v.name} â€” <b>${v.action}</b></div>`,
        ).join("");

        document.getElementById("gem-grid-el").innerHTML = GEMS.map(
          (g) =>
            `<div class="gem-card"><div class="gem-ico">${g.emoji}</div><div class="gem-nm"><b>${g.name}</b><br>${g.desc}</div></div>`,
        ).join("");

        // About content
        document.getElementById("villain-about-el").innerHTML = VILLAINS.map(
          (v) =>
            `<li><strong>${v.name}</strong> (${v.id}) â€” ${v.desc} Tier ${v.tier}.</li>`,
        ).join("");

        document.getElementById("gem-about-el").innerHTML = GEMS.map(
          (g) =>
            `<li>${g.emoji} <strong>${g.name}</strong> â€” ${g.desc} (spawn rate â‰ˆ${Math.round(g.rarity * 100)}%)</li>`,
        ).join("");
      }

      // â”€â”€â”€ GAME INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function startGame() {
        getAC().resume?.();
        bumpPlayCount();

        // Reset all state
        score = 0;
        level = 1;
        lives = 3;
        gemsCollected = 0;
        gemsTotal = 0;
        gemTypesFound = {};
        obstacles = [];
        collectibles = [];
        particles = [];
        magnetTimer = 0;
        immunoTimer = 0;
        speedBoostTimer = 0;
        devMode = false;
        devBadge.classList.remove("visible");
        startTime = Date.now();

        showHUD(true);
        showScr(null); // hide all screens

        initLevel(1);
      }

      function initLevel(lv) {
        level = lv;
        obsBeaten = 0;
        obsNeeded = LEVELS[lv - 1].obsCount;
        obstacles = [];
        collectibles = [];
        obsSpawnCD = 1.4;
        colSpawnCD = 1.8;
        bgX = [0, 0, 0];
        resetPunch();

        tutorialActive = lv === 1;
        tutStep = 0;
        tutWaitingForAct = false;
        tutObsShown = { jump: false, duck: false, gem: false };
        tutBox.style.display = "none";

        updateHUD();

        showLevelToast(lv, () => {
          stopBgMusic();
          startBgMusic(LEVELS[lv - 1].music);
          gameState = "playing";

          // First tutorial step in level 1
          if (lv === 1) {
            setTimeout(() => showTutStep(0), 600);
          }

          lastTS = performance.now();
          cancelAnimationFrame(animId);
          animId = requestAnimationFrame(mainLoop);
        });
      }

      // â”€â”€â”€ LEVEL TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function showLevelToast(lv, cb) {
        const lc = LEVELS[lv - 1];
        document.getElementById("toast-lvl").textContent = "LEVEL " + lv;
        document.getElementById("toast-name").textContent =
          lc.emoji + " " + lc.name;
        document.getElementById("toast-desc").textContent = lc.desc;
        levelToast.style.display = "block";
        SFX.lvlUp();
        setTimeout(() => {
          levelToast.style.display = "none";
          if (cb) cb();
        }, 2100);
      }

      // â”€â”€â”€ TUTORIAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function showTutStep(idx) {
        if (!tutorialActive || idx >= TUTORIAL_STEPS.length) return;
        const step = TUTORIAL_STEPS[idx];
        tutBox.style.display = "block";
        document.getElementById("tut-icon").textContent = step.icon;
        document.getElementById("tut-text").textContent = step.text;
        document.getElementById("tut-key").textContent = step.key;

        if (step.trigger === "start") {
          // Auto-dismiss after 3 seconds
          setTimeout(() => {
            tutBox.style.display = "none";
            tutStep = 1;
          }, 3000);
        }
      }

      function advanceTutorial() {
        tutWaitingForAct = false;
        tutBox.style.display = "none";
      }

      // â”€â”€â”€ HUD UPDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function heartStr() {
        let h = "";
        for (let i = 0; i < lives; i++) h += "â¤ï¸";
        for (let i = lives; i < 3; i++) h += "ğŸ–¤";
        return h || "ğŸ’€";
      }

      function updateHUD() {
        document.getElementById("hud-hearts").textContent = heartStr();
        document.getElementById("hud-level").textContent = "LVL " + level;
        document.getElementById("hud-score").textContent = score;
        document.getElementById("hud-gems").textContent = "ğŸ’ " + gemsCollected;
        document.getElementById("hud-prog").style.width =
          Math.min((obsBeaten / obsNeeded) * 100, 100) + "%";
        immunoBadge.style.display = immunoTimer > 0 ? "block" : "none";
      }

      // â”€â”€â”€ PAUSE / RESUME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let resumeInProgress = false;

      function togglePause() {
        if (gameState === "playing") {
          gameState = "paused";
          stopBgMusic();
          cancelAnimationFrame(animId);
          showScr("scr-pause");
          document.getElementById("hud-pause").textContent = "â–¶";
          document.getElementById("countdown").style.display = "none";
        } else if (gameState === "paused") {
          resumeGame();
        }
      }

      function resumeGame() {
        if (resumeInProgress) return;
        resumeInProgress = true;

        const cdEl = document.getElementById("countdown");
        cdEl.style.display = "block";
        let c = 3;
        cdEl.textContent = c;
        SFX.countdown();

        const iv = setInterval(() => {
          c--;
          if (c > 0) {
            cdEl.textContent = c;
            SFX.countdown();
          } else {
            clearInterval(iv);
            cdEl.textContent = "GO!";
            SFX.go();
            setTimeout(() => {
              cdEl.style.display = "none";
              showScr(null);
              document.getElementById("hud-pause").textContent = "â¸";
              gameState = "playing";
              resumeInProgress = false;
              startBgMusic(LEVELS[level - 1].music);
              lastTS = performance.now();
              animId = requestAnimationFrame(mainLoop);
            }, 400);
          }
        }, 800);
      }

      // â”€â”€â”€ OBSTACLE SPAWNING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function getVillainPool(lv) {
        const maxTier =
          lv <= 2 ? 1 : lv <= 4 ? 2 : lv <= 6 ? 3 : lv <= 8 ? 4 : 5;
        return VILLAINS.filter((v) => v.tier <= maxTier);
      }

      function spawnObstacle() {
        const pool = getVillainPool(level);
        const villain = pool[Math.floor(Math.random() * pool.length)];

        const ob = {
          type: villain.id,
          villain: villain,
          x: DS_W + 30,
          y: DS_GR,
          w: villain.id === "spike" ? 26 : 46,
          h: villain.id === "bigbobo" ? 68 : villain.id === "boulder" ? 40 : 44,
          animT: 0, // animation timer (seconds)
          passed: false,
          wobble: 0, // wobble angle (radians)
        };

        if (villain.id === "vine" || villain.id === "swinger") {
          ob.y = DS_GR - 100;
        }

        obstacles.push(ob);

        // Twin trap spawns a buddy
        if (villain.id === "twintrap") {
          obstacles.push({
            ...ob,
            villain: VILLAINS.find((v) => v.id === "jumper"),
            type: "jumper",
            x: DS_W + 88,
            passed: false,
            wobble: 0,
          });
        }
      }

      function spawnCollectible() {
        // Weighted random selection from GEMS
        const r = Math.random();
        let cum = 0;
        let gem = GEMS[0];
        for (const g of GEMS) {
          cum += g.rarity;
          if (r < cum) {
            gem = g;
            break;
          }
        }
        gemsTotal++;
        collectibles.push({
          x: DS_W + 20,
          y: DS_GR - 40 - Math.random() * 70,
          r: 11,
          gem,
          collected: false,
          bobOffset: Math.random() * Math.PI * 2,
        });

        // Tutorial gem hint
        if (tutorialActive && !tutObsShown.gem) {
          tutObsShown.gem = true;
          setTimeout(() => {
            if (tutorialActive) {
              tutStep = 3;
              showTutStep(3);
              setTimeout(() => (tutBox.style.display = "none"), 3500);
            }
          }, 400);
        }
      }

      // â”€â”€â”€ PARTICLE SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function spawnParticles(x, y, color, n = 8) {
        for (let i = 0; i < n; i++) {
          particles.push({
            x,
            y,
            vx: (Math.random() - 0.5) * 180, // px/s
            vy: -Math.random() * 200 - 40,
            life: 0.6 + Math.random() * 0.4,
            maxLife: 1.0,
            color,
            r: 3 + Math.random() * 4,
          });
        }
      }

      // â”€â”€â”€ GEM COLLECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function collectGem(c) {
        gemsCollected++;
        if (!gemTypesFound[c.gem.id]) gemTypesFound[c.gem.id] = 0;
        gemTypesFound[c.gem.id]++;
        score += c.gem.pts;

        spawnParticles(c.x, c.y, c.gem.color, 12);

        switch (c.gem.effect) {
          case "life":
            if (lives < 6) {
              lives++;
              SFX.gem();
              showGemBanner("â¤ï¸ +1 HEART!", c.gem.color);
            } else {
              score += 50;
              SFX.gem();
              showGemBanner("â¤ï¸ Full health! +50pts", c.gem.color);
            }
            break;
          case "immuno":
            immunoTimer = 5; // seconds
            SFX.immuno();
            showGemBanner("ğŸ”® IMMUNITY! 5 SECONDS!", c.gem.color);
            break;
          case "magnet":
            magnetTimer = 5; // seconds
            SFX.magnet();
            showGemBanner("ğŸ§² MAGNET! Auto-collect!", c.gem.color);
            break;
          default:
            if (c.gem.rarity < 0.05) {
              SFX.rare();
              showGemBanner(
                c.gem.emoji + " " + c.gem.name + "! +" + c.gem.pts,
                c.gem.color,
              );
            } else {
              SFX.gem();
            }
        }

        updateHUD();
      }

      function showGemBanner(text, color) {
        gemBanner.textContent = text;
        gemBanner.style.background = color
          ? `linear-gradient(135deg, ${color}, ${color}cc)`
          : "linear-gradient(135deg,#ffd166,#ff9f1c)";
        gemBanner.classList.remove("pop");
        void gemBanner.offsetWidth;
        gemBanner.classList.add("pop");
      }

      // â”€â”€â”€ TAKE DAMAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let hitCooldown = 0; // seconds

      function takeDamage(villain) {
        if (devMode) return; // dev mode: invincible
        if (immunoTimer > 0) return; // immunity active

        lives--;
        hitCooldown = 1.2; // seconds of invincibility after hit
        spawnParticles(P.x + P.w / 2, P.y - P.h / 2, "#ff4d6d", 22);
        SFX.hit();
        updateHUD();

        if (lives <= 0) triggerGameOver(villain);
      }

      // â”€â”€â”€ LEVEL COMPLETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function triggerLevelComplete() {
        gameState = "transition";
        stopBgMusic();
        savePersisted();

        if (level >= 10) {
          triggerWin();
          return;
        }

        SFX.lvlUp();
        setTimeout(() => initLevel(level + 1), 500);
      }

      // â”€â”€â”€ GAME OVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function triggerGameOver(villain) {
        gameState = "over";
        stopBgMusic();
        savePersisted();
        SFX.death();
        startBgMusic("end");

        const fail = FAILS[Math.floor(Math.random() * FAILS.length)];
        document.getElementById("fail-title").textContent = fail.title;
        document.getElementById("fail-title").style.color = fail.col;
        document.getElementById("fail-msg").textContent = villain
          ? `Killed by ${villain.name}. ${fail.msg}`
          : fail.msg;

        document.getElementById("go-score").textContent = score;
        document.getElementById("go-level").textContent = level;
        document.getElementById("go-best").textContent = bestScore;
        document.getElementById("go-maxlvl").textContent = bestLevel;

        const gemsStr =
          Object.entries(gemTypesFound)
            .map(([id, n]) => {
              const g = GEMS.find((x) => x.id === id);
              return g ? `${g.emoji}Ã—${n}` : "";
            })
            .filter(Boolean)
            .join("  ") || "none";
        document.getElementById("go-gems-info").textContent =
          `Gems: ${gemsCollected}/${gemsTotal} â€” ${gemsStr}`;

        const canContinue = lives > 0;
        document.getElementById("cont-btn").style.display = canContinue
          ? ""
          : "none";
        document.getElementById("continue-info").textContent = canContinue
          ? `${lives} heart${lives > 1 ? "s" : ""} left â€” continue from Level ${level}?`
          : "No hearts remaining. Start fresh!";

        showHUD(false);
        showScr("scr-over");
      }

      function continueRun() {
        if (lives <= 0) {
          restartGame();
          return;
        }
        showHUD(true);
        obstacles = [];
        collectibles = [];
        obsBeaten = 0;
        hitCooldown = 0;
        resetPunch();
        showLevelToast(level, () => {
          stopBgMusic();
          startBgMusic(LEVELS[level - 1].music);
          gameState = "playing";
          lastTS = performance.now();
          animId = requestAnimationFrame(mainLoop);
        });
      }

      function restartGame() {
        cancelAnimationFrame(animId);
        startGame();
      }

      // â”€â”€â”€ WIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function triggerWin() {
        gameState = "won";
        savePersisted();
        SFX.win();
        setTimeout(() => {
          startBgMusic("end");
          SFX.wind();
        }, 400);

        const elapsed = Math.round((Date.now() - startTime) / 1000);
        document.getElementById("win-score").textContent = score;
        document.getElementById("win-time").textContent = elapsed + "s";
        document.getElementById("win-gems").textContent = gemsCollected;

        showHUD(false);
        showScr("scr-win");
        setTimeout(() => animateWinScene(), 150);
      }

      // â”€â”€â”€ SHARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function shareScore(ctx) {
        let text;
        if (ctx === "win") {
          text = `ğŸ§¸ I BEAT PUNCH'S GREAT ESCAPE!\nAll 10 levels cleared. Score: ${score}, Gems: ${gemsCollected}\nThe plushie is finally back! ğŸ’›\n\n#PunchMonkey #PunchEscape\nhttps://punch-monkey.vercel.app`;
        } else {
          text = `ğŸ’ Playing Punch's Great Escape!\nLevel ${level}, Score: ${score}pts\nBest level ever: ${bestLevel}\n\nCan you beat me? #PunchMonkey\nhttps://punch-monkey.vercel.app`;
        }
        if (navigator.share) {
          navigator
            .share({ title: "Punch's Great Escape", text })
            .catch(() => {});
        } else {
          try {
            navigator.clipboard.writeText(text);
            alert("Copied! Paste & share ğŸ’\n\n" + text);
          } catch (e) {
            alert(text);
          }
        }
      }

      // â”€â”€â”€ UPDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      /**
       * Main physics/logic update. dt = delta time in seconds.
       * All movement uses dt to stay framerate-independent.
       */
      function update(dt) {
        // Cap dt to avoid huge jumps after tab switch
        dt = Math.min(dt, 0.05);

        // â”€â”€ Current speed from level config + modifiers â”€â”€
        const lc = LEVELS[level - 1];
        const spd =
          BASE_SPEED * lc.speedMult * (speedBoostTimer > 0 ? 1.35 : 1);

        // â”€â”€ Timers â”€â”€
        if (hitCooldown > 0) hitCooldown -= dt;
        if (immunoTimer > 0) {
          immunoTimer -= dt;
          if (immunoTimer <= 0) {
            immunoTimer = 0;
            SFX.hit();
          }
        }
        if (magnetTimer > 0) magnetTimer -= dt;
        if (speedBoostTimer > 0) speedBoostTimer -= dt;

        // â”€â”€ Score â”€â”€
        score += Math.floor(spd * dt * 0.4 + level * dt * 0.5);

        // â”€â”€ Parallax â”€â”€
        bgX[0] = (bgX[0] + spd * 0.18 * dt) % (DS_W * 1.5);
        bgX[1] = (bgX[1] + spd * 0.45 * dt) % DS_W;
        bgX[2] = (bgX[2] + spd * 0.82 * dt) % DS_W;

        // â”€â”€ Punch physics â”€â”€
        if (P.sliding) {
          P.slideTimer -= dt;
          if (P.slideTimer <= 0) P.sliding = false;
        }
        P.vy += GRAVITY * dt;
        P.y += P.vy * dt;
        if (P.y >= DS_GR) {
          P.y = DS_GR;
          P.vy = 0;
          P.jumping = false;
          P.jumpCount = 0;
        }
        P.animTimer += dt;
        if (P.animTimer > 0.1) {
          P.animTimer = 0;
          P.animFrame = (P.animFrame + 1) % 4;
        }

        // â”€â”€ Spawn obstacles â”€â”€
        obsSpawnCD -= dt;
        if (obsSpawnCD <= 0 && obstacles.length < 7) {
          spawnObstacle();
          // Tutorial: first jump obstacle
          if (tutorialActive && !tutObsShown.jump && obstacles.length > 0) {
            const last = obstacles[obstacles.length - 1];
            if (last.type !== "vine" && last.type !== "swinger") {
              tutObsShown.jump = true;
              tutStep = 1;
              showTutStep(1);
            }
          }
          if (tutorialActive && !tutObsShown.duck && obsBeaten >= 3) {
            // Force a vine next
            tutObsShown.duck = true;
            const vineOb = {
              type: "vine",
              villain: VILLAINS.find((v) => v.id === "vine"),
              x: DS_W + 30,
              y: DS_GR - 100,
              w: 20,
              h: 60,
              animT: 0,
              passed: false,
              wobble: 0,
            };
            obstacles.push(vineOb);
            tutStep = 2;
            showTutStep(2);
          }
          // Progress-based spawn rate tightening
          const prog = obsBeaten / obsNeeded;
          const minGap = Math.max(0.5, 1.2 - level * 0.07 - prog * 0.4);
          const maxGap = Math.max(0.9, 2.0 - level * 0.08 - prog * 0.5);
          obsSpawnCD = minGap + Math.random() * (maxGap - minGap);
        }

        // â”€â”€ Spawn collectibles â”€â”€
        colSpawnCD -= dt;
        if (colSpawnCD <= 0) {
          spawnCollectible();
          colSpawnCD = 0.9 + Math.random() * 1.0;
        }

        // â”€â”€ Move + collide obstacles â”€â”€
        for (let i = obstacles.length - 1; i >= 0; i--) {
          const o = obstacles[i];
          o.x -= spd * dt;
          o.animT += dt;
          o.wobble = Math.sin(o.animT * 6) * 0.08; // gentle wobble

          // Passed?
          if (!o.passed && o.x + o.w < P.x) {
            o.passed = true;
            obsBeaten++;
            score += 8 + level * 2;
            SFX.mkPass();
            updateHUD();
            if (obsBeaten >= obsNeeded) {
              triggerLevelComplete();
              return;
            }
          }

          // Collision check
          if (hitCooldown <= 0 && immunoTimer <= 0) {
            const mx = 7,
              my = 6;
            const px = P.x + mx,
              pw = P.w - mx * 2;
            const py = P.hitY + my * 0.5,
              ph = P.hitH - my;

            let ox, ow, oy, oh;
            if (o.type === "vine" || o.type === "swinger") {
              ox = o.x + 4;
              ow = o.w - 8;
              oy = o.y;
              oh = 14;
            } else {
              ox = o.x + mx;
              ow = o.w - mx * 2;
              oy = o.y - o.h + my;
              oh = o.h - my;
            }

            if (px < ox + ow && px + pw > ox && py < oy + oh && py + ph > oy) {
              takeDamage(o.villain);
            }
          }

          // Obstacle leaves screen
          if (o.x < -100) obstacles.splice(i, 1);
        }

        // â”€â”€ Move + collect gems â”€â”€
        for (let i = collectibles.length - 1; i >= 0; i--) {
          const c = collectibles[i];
          c.x -= spd * dt;

          // Magnet: pull nearby gems to Punch
          if (magnetTimer > 0) {
            const dx = P.x + P.w / 2 - c.x;
            const dy = P.hitY + P.hitH / 2 - c.y;
            const d = Math.hypot(dx, dy);
            if (d < 160) {
              c.x += dx * 8 * dt;
              c.y += dy * 8 * dt;
            }
          }

          if (!c.collected) {
            const dx = P.x + P.w / 2 - c.x;
            const dy = P.hitY + P.hitH / 2 - c.y;
            if (Math.hypot(dx, dy) < c.r + P.w * 0.38) {
              c.collected = true;
              collectGem(c);
            }
          }

          if (c.x < -30) collectibles.splice(i, 1);
        }

        // â”€â”€ Particles â”€â”€
        for (let i = particles.length - 1; i >= 0; i--) {
          const p = particles[i];
          p.x += p.vx * dt;
          p.y += p.vy * dt;
          p.vy += 400 * dt; // gravity on particles
          p.life -= dt;
          if (p.life <= 0) particles.splice(i, 1);
        }

        updateHUD();
      }

      // â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      /** Background colour themes keyed by level.bg */
      const BG_THEMES = {
        zoo: {
          sky: ["#1a3a4a", "#0d1f2d"],
          gnd: ["#4a3a1a", "#2a1a0a"],
          acc: "#8b5e3c",
        },
        bamboo: {
          sky: ["#0d2e1a", "#071a0d"],
          gnd: ["#2a4a1a", "#1a2a0a"],
          acc: "#4a7a3a",
        },
        river: {
          sky: ["#0d1a3a", "#071022"],
          gnd: ["#1a3a4a", "#0a1a2a"],
          acc: "#3a6a8a",
        },
        ruins: {
          sky: ["#2a1a0a", "#1a0a05"],
          gnd: ["#3a2a1a", "#1a1a0a"],
          acc: "#7a6a4a",
        },
        mushroom: {
          sky: ["#2a0a2a", "#1a051a"],
          gnd: ["#3a1a3a", "#1a0a1a"],
          acc: "#8a3a8a",
        },
        cave: {
          sky: ["#0a0a1a", "#050510"],
          gnd: ["#1a1a2a", "#0a0a1a"],
          acc: "#3a3a6a",
        },
        volcano: {
          sky: ["#2a0a00", "#1a0500"],
          gnd: ["#3a1a0a", "#1a0a05"],
          acc: "#ff4a00",
        },
        moon: {
          sky: ["#0a0a2a", "#05051a"],
          gnd: ["#1a1a3a", "#0a0a1a"],
          acc: "#4a4a8a",
        },
        storm: {
          sky: ["#080808", "#050508"],
          gnd: ["#1a1a0a", "#0a0a05"],
          acc: "#dfdf00",
        },
        final: {
          sky: ["#1a0a2e", "#0d0420"],
          gnd: ["#2d1b69", "#1a0a3e"],
          acc: "#ff6b35",
        },
      };

      function renderBg(lc, t) {
        // Sky gradient
        const g = ctx.createLinearGradient(0, 0, 0, DS_H);
        g.addColorStop(0, t.sky[0]);
        g.addColorStop(1, t.sky[1]);
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, DS_W, DS_H);

        // Stars
        ctx.fillStyle = "rgba(255,255,255,.5)";
        for (let i = 0; i < 22; i++) {
          ctx.beginPath();
          ctx.arc(
            (i * 139 + level * 19) % DS_W,
            (i * 73 + 19) % (DS_H * 0.62),
            i % 3 === 0 ? 1.2 : 0.65,
            0,
            Math.PI * 2,
          );
          ctx.fill();
        }

        // Moon (for dark levels)
        if (["cave", "moon", "final", "storm"].includes(lc.bg)) {
          ctx.fillStyle = "#ffd166";
          ctx.shadowColor = "#ffd16655";
          ctx.shadowBlur = 14;
          ctx.beginPath();
          ctx.arc(DS_W * 0.84, DS_H * 0.14, 20, 0, Math.PI * 2);
          ctx.fill();
          ctx.shadowBlur = 0;
        }

        // Level-specific atmosphere
        renderAtmosphere(lc.bg);

        // Far tree layer
        ctx.globalAlpha = 0.6;
        ctx.fillStyle = t.sky[0] + "dd";
        for (let i = 0; i < 7; i++) {
          const tx2 =
            (((i / 7) * DS_W * 1.3 + bgX[0] * 0.45) % (DS_W * 1.5)) -
            DS_W * 0.08;
          const th2 = DS_H * (0.42 + (i % 3) * 0.08);
          renderTree(tx2, DS_GR, th2, lc.bg);
        }
        // Near tree layer
        ctx.fillStyle = "rgba(0,0,0,.55)";
        for (let i = 0; i < 5; i++) {
          const tx2 =
            (((i / 5) * DS_W * 1.2 + bgX[1] * 0.7) % (DS_W * 1.3)) -
            DS_W * 0.08;
          const th2 = DS_H * (0.26 + (i % 2) * 0.07);
          renderTree(tx2, DS_GR, th2, lc.bg);
        }
        ctx.globalAlpha = 1;

        // Ground
        const gg = ctx.createLinearGradient(0, DS_GR, 0, DS_H);
        gg.addColorStop(0, t.gnd[0]);
        gg.addColorStop(1, t.gnd[1]);
        ctx.fillStyle = gg;
        ctx.fillRect(0, DS_GR, DS_W, DS_H - DS_GR);
        // Ground line
        ctx.strokeStyle = t.acc;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, DS_GR);
        ctx.lineTo(DS_W, DS_GR);
        ctx.stroke();
        // Running marks
        ctx.strokeStyle = t.acc + "44";
        ctx.lineWidth = 1;
        const mk = 80;
        const off = bgX[2] % mk;
        for (let x = -off; x < DS_W; x += mk) {
          ctx.beginPath();
          ctx.moveTo(x, DS_GR + 7);
          ctx.lineTo(x + 22, DS_GR + 7);
          ctx.stroke();
        }

        // Level name watermark
        ctx.globalAlpha = 0.05;
        ctx.fillStyle = "white";
        ctx.font = "bold 26px Boogaloo";
        ctx.textAlign = "center";
        ctx.fillText(
          lc.emoji + " " + lc.name.toUpperCase(),
          DS_W / 2,
          DS_H * 0.52,
        );
        ctx.globalAlpha = 1;
      }

      function renderAtmosphere(bg) {
        if (bg === "bamboo") {
          ctx.strokeStyle = "rgba(60,120,40,.22)";
          ctx.lineWidth = 5;
          for (let x = DS_W * 0.05; x < DS_W; x += DS_W * 0.09) {
            ctx.beginPath();
            ctx.moveTo(x + Math.sin(bgX[0] * 0.015 + x) * 5, 0);
            ctx.lineTo(x, DS_GR);
            ctx.stroke();
          }
        }
        if (bg === "lava" || bg === "volcano") {
          ctx.fillStyle = "rgba(255,50,0,.06)";
          ctx.fillRect(0, 0, DS_W, DS_H);
        }
        if (bg === "storm") {
          // Lightning flash occasionally
          ctx.fillStyle = "rgba(220,220,50,.04)";
          ctx.fillRect(0, 0, DS_W, DS_H);
        }
        if (bg === "final") {
          const pg = ctx.createRadialGradient(
            DS_W * 0.5,
            DS_GR,
            0,
            DS_W * 0.5,
            DS_GR,
            DS_W * 0.42,
          );
          pg.addColorStop(0, "rgba(255,77,109,.16)");
          pg.addColorStop(1, "transparent");
          ctx.fillStyle = pg;
          ctx.fillRect(0, DS_H * 0.25, DS_W, DS_H * 0.75);
        }
      }

      function renderTree(x, baseY, h, bg) {
        if (bg === "ruins" || bg === "cave") {
          ctx.fillRect(x - 7, baseY - h, 14, h);
          ctx.fillRect(x - 13, baseY - h, 26, 7);
        } else {
          ctx.fillRect(x - 4, baseY - h * 0.45, 8, h * 0.45);
          ctx.beginPath();
          ctx.arc(x, baseY - h * 0.54, h * 0.36, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      /** Render Punch with all states: running, jumping, sliding, immune flash */
      function renderPunch() {
        const x = P.x;
        const y = P.y;
        const bob = P.jumping ? 0 : Math.sin(Date.now() * 0.004) * 2;
        const flash = hitCooldown > 0 && Math.floor(Date.now() / 80) % 2 === 0;
        const immG = immunoTimer > 0;

        ctx.save();
        ctx.translate(x + P.w / 2, y + bob);
        if (P.sliding) ctx.scale(1, 0.55);
        if (flash) ctx.globalAlpha = 0.25;

        if (immG) {
          ctx.shadowColor = "#c084fc";
          ctx.shadowBlur = 16;
        }

        // Shadow
        ctx.globalAlpha = flash ? 0.05 : immG ? 0.5 : 0.22;
        ctx.fillStyle = immG ? "#c084fc" : "#000";
        ctx.beginPath();
        ctx.ellipse(0, 3, 20, 6, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = flash ? 0.25 : 1;

        const bc = immG ? "#d8a0ff" : "#c47a2e"; // body color
        const fc = immG ? "#f0d0ff" : "#e8a96a"; // face color

        // Body
        ctx.fillStyle = bc;
        ctx.beginPath();
        ctx.roundRect(-15, -42, 30, 34, 7);
        ctx.fill();
        // Belly
        ctx.fillStyle = fc;
        ctx.beginPath();
        ctx.ellipse(0, -28, 9, 11, 0, 0, Math.PI * 2);
        ctx.fill();
        // Head
        ctx.fillStyle = bc;
        ctx.beginPath();
        ctx.arc(0, -50, 16, 0, Math.PI * 2);
        ctx.fill();
        // Face
        ctx.fillStyle = fc;
        ctx.beginPath();
        ctx.ellipse(0, -46, 11, 10, 0, 0, Math.PI * 2);
        ctx.fill();
        // Eyes
        ctx.fillStyle = "#1a0a2e";
        ctx.beginPath();
        ctx.arc(-5, -52, 3.2, 0, Math.PI * 2);
        ctx.arc(5, -52, 3.2, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(-4, -53, 1.1, 0, Math.PI * 2);
        ctx.arc(6, -53, 1.1, 0, Math.PI * 2);
        ctx.fill();
        // Smile
        ctx.strokeStyle = "#1a0a2e";
        ctx.lineWidth = 1.8;
        ctx.beginPath();
        ctx.arc(0, -42, 4.5, 0.18, Math.PI - 0.18);
        ctx.stroke();
        // Ears
        ctx.fillStyle = bc;
        ctx.beginPath();
        ctx.arc(-15, -53, 6.5, 0, Math.PI * 2);
        ctx.arc(15, -53, 6.5, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = immG ? "#f5e0ff" : "#e8c09a";
        ctx.beginPath();
        ctx.arc(-15, -53, 3.8, 0, Math.PI * 2);
        ctx.arc(15, -53, 3.8, 0, Math.PI * 2);
        ctx.fill();

        // Red plushie cradled in arm
        ctx.shadowColor = "#ff4d6d55";
        ctx.shadowBlur = 7;
        ctx.fillStyle = "#ff4d6d";
        ctx.beginPath();
        ctx.arc(-18, -28, 9, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.fillStyle = "#ff8fa3";
        ctx.beginPath();
        ctx.ellipse(-18, -25, 6.5, 5.5, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "#ff4d6d";
        ctx.beginPath();
        ctx.arc(-24, -35, 3.5, 0, Math.PI * 2);
        ctx.arc(-13, -36, 3.5, 0, Math.PI * 2);
        ctx.fill();

        // Running legs
        const leg = P.jumping ? 6 : Math.sin(Date.now() * 0.01) * 11;
        ctx.fillStyle = bc;
        ctx.save();
        ctx.translate(-6, -7);
        ctx.rotate(leg * 0.04);
        ctx.beginPath();
        ctx.roundRect(-4.5, 0, 9, 13, 3);
        ctx.fill();
        ctx.fillStyle = "#9a5a1e";
        ctx.beginPath();
        ctx.ellipse(0, 14, 7, 4.5, leg * 0.02, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
        ctx.fillStyle = bc;
        ctx.save();
        ctx.translate(6, -7);
        ctx.rotate(-leg * 0.04);
        ctx.beginPath();
        ctx.roundRect(-4.5, 0, 9, 13, 3);
        ctx.fill();
        ctx.fillStyle = "#9a5a1e";
        ctx.beginPath();
        ctx.ellipse(0, 14, 7, 4.5, -leg * 0.02, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();

        ctx.restore();
        ctx.globalAlpha = 1;
        ctx.shadowBlur = 0;
      }

      /** Render a villain obstacle with wobble animation */
      function renderVillain(o) {
        ctx.save();
        ctx.translate(o.x + o.w / 2, 0);
        ctx.rotate(o.wobble); // gentle wobble

        const v = o.villain;
        const anim = Math.sin(o.animT * 5); // -1..1
        const bob = anim * 3;

        // Render label
        ctx.font = "bold 10px Boogaloo";
        ctx.textAlign = "center";

        // â”€â”€ Vine / Swinger â”€â”€
        if (o.type === "vine" || o.type === "swinger") {
          const vy = o.y;
          ctx.fillStyle = "#2d7a2d";
          ctx.fillRect(-o.w / 2, 0, o.w, vy);
          for (let i = 0; i < 4; i++) {
            const lx = i % 2 === 0 ? 9 : -9;
            const ly = (i + 1) * (vy / 5);
            ctx.fillStyle = i % 2 === 0 ? "#3da03d" : "#2d7a2d";
            ctx.beginPath();
            ctx.ellipse(lx, ly, 9, 14, 0.4, 0, Math.PI * 2);
            ctx.fill();
          }
          // Hit zone indicator (semi-visible)
          ctx.strokeStyle = "rgba(255,100,100,.25)";
          ctx.lineWidth = 2;
          ctx.strokeRect(-o.w / 2 + 4, vy - 1, o.w - 8, 14);
          ctx.fillStyle = "rgba(255,255,255,.75)";
          ctx.fillText("DUCK!", 0, vy - 20);

          // â”€â”€ Stone / Boulder â”€â”€
        } else if (o.type === "stone" || o.type === "boulder") {
          const gy = o.y;
          // Squash on landing bob
          const squashY = 1 + Math.abs(anim) * 0.06;
          ctx.save();
          ctx.scale(1, squashY);
          ctx.fillStyle = "#6b7280";
          ctx.beginPath();
          ctx.roundRect(-o.w / 2, gy / squashY - o.h + bob, o.w, o.h, 7);
          ctx.fill();
          ctx.fillStyle = "#9ca3af";
          ctx.beginPath();
          ctx.ellipse(
            -5,
            gy / squashY - o.h + o.h * 0.3 + bob,
            7,
            4,
            -0.4,
            0,
            Math.PI * 2,
          );
          ctx.fill();
          // Angry face on stone
          ctx.fillStyle = "#1a0a2e";
          ctx.beginPath();
          ctx.arc(-4, gy / squashY - o.h * 0.55 + bob, 3, 0, Math.PI * 2);
          ctx.arc(5, gy / squashY - o.h * 0.55 + bob, 3, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
          ctx.fillStyle = "rgba(255,255,255,.75)";
          ctx.fillText("JUMP!", 0, gy - o.h - 10 + bob);

          // â”€â”€ Banana Peel â”€â”€
        } else if (o.type === "peel") {
          const gy = o.y;
          ctx.fillStyle = "#fdd835";
          ctx.beginPath();
          ctx.ellipse(0, gy - 5, 17, 7, 0.3, 0, Math.PI * 2);
          ctx.fill();
          ctx.strokeStyle = "#e6b800";
          ctx.lineWidth = 2;
          [-1, 0, 1].forEach((d) => {
            ctx.beginPath();
            ctx.moveTo(d * 7, gy - 5);
            ctx.quadraticCurveTo(d * 14, gy - 22, d * 5, gy - 26);
            ctx.stroke();
          });
          ctx.fillStyle = "rgba(255,255,255,.75)";
          ctx.fillText("ğŸŒ", 0, gy - 30);

          // â”€â”€ Spike â”€â”€
        } else if (o.type === "spike") {
          const gy = o.y;
          for (let i = -1; i <= 1; i++) {
            ctx.fillStyle = v.color;
            ctx.beginPath();
            ctx.moveTo(i * 14, gy);
            ctx.lineTo(i * 14 - 6, gy - o.h);
            ctx.lineTo(i * 14 + 6, gy - o.h);
            ctx.fill();
          }
          ctx.fillStyle = "rgba(255,255,255,.75)";
          ctx.fillText("HIGH JUMP!", 0, DS_GR - o.h - 13 + bob);

          // â”€â”€ Default monkey â”€â”€
        } else {
          const gy = o.y;
          const isSlide = o.type === "slider";
          const isBig = o.type === "bigbobo";
          const sc = isBig ? 1.35 : 1;

          ctx.save();
          if (isSlide) {
            ctx.scale(1, 0.7);
            ctx.translate(0, -5);
          }

          // Body
          ctx.fillStyle = v.color;
          ctx.beginPath();
          ctx.roundRect(
            (-o.w / 2) * sc,
            gy - o.h * sc + bob,
            o.w * sc,
            o.h * 0.65 * sc,
            7,
          );
          ctx.fill();
          // Head
          const hx = isSlide ? (-o.w / 2) * sc + 12 : 0;
          const hyr = gy - o.h * sc - 7 + bob;
          ctx.beginPath();
          ctx.arc(hx, hyr, (isBig ? 17 : 13) * sc, 0, Math.PI * 2);
          ctx.fill();
          // Face
          ctx.fillStyle = "rgba(255,255,255,.35)";
          ctx.beginPath();
          ctx.ellipse(hx, hyr + 3 * sc, 9 * sc, 8 * sc, 0, 0, Math.PI * 2);
          ctx.fill();
          // Eyes
          ctx.fillStyle = "white";
          ctx.beginPath();
          ctx.arc(hx - 4 * sc, hyr - 2 * sc, 3.5 * sc, 0, Math.PI * 2);
          ctx.arc(hx + 4 * sc, hyr - 2 * sc, 3.5 * sc, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = "#1a0a2e";
          ctx.beginPath();
          ctx.arc(hx - 3.5 * sc, hyr - 1 * sc, 2.2 * sc, 0, Math.PI * 2);
          ctx.arc(hx + 4.5 * sc, hyr - 1 * sc, 2.2 * sc, 0, Math.PI * 2);
          ctx.fill();
          // Angry brows
          ctx.strokeStyle = "#1a0a2e";
          ctx.lineWidth = 2.2 * sc;
          ctx.beginPath();
          ctx.moveTo(hx - 8 * sc, hyr - 7 * sc);
          ctx.lineTo(hx - 1 * sc, hyr - 4 * sc);
          ctx.moveTo(hx + 1 * sc, hyr - 7 * sc);
          ctx.lineTo(hx + 8 * sc, hyr - 4 * sc);
          ctx.stroke();
          // Name badge
          ctx.fillStyle = "rgba(0,0,0,.65)";
          const bw = v.name.length * 6 * sc + 6;
          ctx.beginPath();
          ctx.roundRect(
            hx - bw / 2,
            hyr - o.h * 0.56 * sc + bob,
            bw,
            13 * sc,
            3,
          );
          ctx.fill();
          ctx.fillStyle = "rgba(255,255,255,.9)";
          ctx.font = `bold ${9 * sc}px Boogaloo`;
          ctx.fillText(v.name, hx, hyr - o.h * 0.44 * sc + bob);
          // Action hint
          ctx.fillStyle = "rgba(255,255,255,.75)";
          ctx.font = "bold 10px Boogaloo";
          ctx.fillText(
            v.action === "HIGH" ? "HIGH JUMP!" : v.action + "!",
            hx,
            gy - o.h * sc - 32 + bob,
          );

          ctx.restore();
        }

        ctx.restore();
      }

      function renderCollectibles() {
        const t = Date.now() * 0.001;
        for (const c of collectibles) {
          if (c.collected) continue;
          const bob = Math.sin(t * 3 + c.bobOffset) * 4;
          const isR = c.gem.rarity < 0.05;

          ctx.save();
          ctx.translate(c.x, c.y + bob);

          if (isR) {
            ctx.shadowColor = c.gem.color;
            ctx.shadowBlur = 14;
          }

          ctx.fillStyle = c.gem.color;
          ctx.beginPath();
          ctx.arc(0, 0, c.r, 0, Math.PI * 2);
          ctx.fill();
          ctx.shadowBlur = 0;

          ctx.font = `${c.r * 1.9}px serif`;
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(c.gem.emoji, 0, 1);
          ctx.textBaseline = "alphabetic";
          ctx.restore();
        }
      }

      function renderParticles() {
        for (const p of particles) {
          ctx.globalAlpha = p.life / p.maxLife;
          ctx.fillStyle = p.color;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r * (p.life / p.maxLife), 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.globalAlpha = 1;
      }

      function renderFrame() {
        ctx.clearRect(0, 0, DS_W, DS_H);
        const lc = LEVELS[level - 1];
        const t = BG_THEMES[lc.bg] || BG_THEMES.zoo;
        renderBg(lc, t);
        renderCollectibles();
        for (const o of obstacles) renderVillain(o);
        renderPunch();
        renderParticles();
      }

      // â”€â”€â”€ TITLE CANVAS ART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      /** Emotional scene: Punch hugging plushie from behind, looking up */
      function renderTitleArt() {
        const tc = document.getElementById("title-art-canvas");
        if (!tc) return;
        const sz = Math.round(
          Math.min(window.innerWidth * 0.22, window.innerHeight * 0.22, 156),
        );
        tc.width = sz;
        tc.height = sz;
        const tx = tc.getContext("2d");
        const s = sz / 140;
        tx.clearRect(0, 0, sz, sz);

        // Ambient glow
        const glow = tx.createRadialGradient(
          sz * 0.5,
          sz * 0.65,
          0,
          sz * 0.5,
          sz * 0.65,
          sz * 0.55,
        );
        glow.addColorStop(0, "rgba(255,100,53,.18)");
        glow.addColorStop(1, "transparent");
        tx.fillStyle = glow;
        tx.fillRect(0, 0, sz, sz);

        tx.save();
        tx.translate(sz * 0.5, sz * 0.78);

        // â”€â”€ PLUSHIE (in front, slightly rotated, warm glow) â”€â”€
        tx.save();
        tx.rotate(-0.15);
        tx.shadowColor = "#ff4d6d";
        tx.shadowBlur = 18 * s;
        tx.fillStyle = "#ff4d6d";
        tx.beginPath();
        tx.arc(0, 0, 28 * s, 0, Math.PI * 2);
        tx.fill();
        tx.shadowBlur = 0;
        tx.fillStyle = "#ff8fa3";
        tx.beginPath();
        tx.ellipse(0, 4 * s, 20 * s, 17 * s, 0, 0, Math.PI * 2);
        tx.fill();
        // Closed happy eyes
        tx.strokeStyle = "#1a0a2e";
        tx.lineWidth = 2.5 * s;
        tx.beginPath();
        tx.arc(-8 * s, -5 * s, 5 * s, Math.PI * 0.1, Math.PI * 0.9);
        tx.stroke();
        tx.beginPath();
        tx.arc(8 * s, -5 * s, 5 * s, Math.PI * 0.1, Math.PI * 0.9);
        tx.stroke();
        // Blush
        tx.fillStyle = "rgba(255,100,120,.4)";
        tx.beginPath();
        tx.ellipse(-13 * s, 3 * s, 6 * s, 4 * s, 0, 0, Math.PI * 2);
        tx.ellipse(13 * s, 3 * s, 6 * s, 4 * s, 0, 0, Math.PI * 2);
        tx.fill();
        // Ears
        tx.fillStyle = "#ff4d6d";
        tx.beginPath();
        tx.arc(-22 * s, -20 * s, 8 * s, 0, Math.PI * 2);
        tx.arc(22 * s, -20 * s, 8 * s, 0, Math.PI * 2);
        tx.fill();
        tx.fillStyle = "#ff8fa3";
        tx.beginPath();
        tx.arc(-22 * s, -20 * s, 5 * s, 0, Math.PI * 2);
        tx.arc(22 * s, -20 * s, 5 * s, 0, Math.PI * 2);
        tx.fill();
        tx.restore();

        // â”€â”€ PUNCH (behind, arms around, peeking with big eyes) â”€â”€
        tx.save();
        tx.translate(3 * s, -17 * s);
        // Arms
        tx.fillStyle = "#b36a25";
        tx.save();
        tx.rotate(0.55);
        tx.beginPath();
        tx.roundRect(-7 * s, 10 * s, 14 * s, 30 * s, 6 * s);
        tx.fill();
        tx.restore();
        tx.save();
        tx.rotate(-0.4);
        tx.beginPath();
        tx.roundRect(-6 * s, 10 * s, 14 * s, 28 * s, 6 * s);
        tx.fill();
        tx.restore();
        // Body
        tx.fillStyle = "#b36a25";
        tx.beginPath();
        tx.roundRect(-13 * s, 0, 26 * s, 28 * s, 8 * s);
        tx.fill();
        // Head
        tx.fillStyle = "#c47a2e";
        tx.beginPath();
        tx.arc(1 * s, -16 * s, 18 * s, 0, Math.PI * 2);
        tx.fill();
        tx.fillStyle = "#e8a96a";
        tx.beginPath();
        tx.ellipse(1 * s, -12 * s, 13 * s, 12 * s, 0, 0, Math.PI * 2);
        tx.fill();
        // Big hopeful shiny eyes
        tx.fillStyle = "#1a0a2e";
        tx.beginPath();
        tx.arc(-6 * s, -18 * s, 5 * s, 0, Math.PI * 2);
        tx.arc(8 * s, -18 * s, 5 * s, 0, Math.PI * 2);
        tx.fill();
        tx.fillStyle = "white";
        tx.beginPath();
        tx.arc(-5 * s, -19 * s, 2 * s, 0, Math.PI * 2);
        tx.arc(9 * s, -19 * s, 2 * s, 0, Math.PI * 2);
        tx.fill();
        tx.fillStyle = "rgba(255,255,255,.65)";
        tx.beginPath();
        tx.arc(-4.2 * s, -20 * s, 0.8 * s, 0, Math.PI * 2);
        tx.arc(9.8 * s, -20 * s, 0.8 * s, 0, Math.PI * 2);
        tx.fill();
        // Smile
        tx.strokeStyle = "#1a0a2e";
        tx.lineWidth = 2.5 * s;
        tx.beginPath();
        tx.arc(1 * s, -8 * s, 6 * s, 0.12, Math.PI - 0.12);
        tx.stroke();
        // Blush
        tx.fillStyle = "rgba(220,110,50,.44)";
        tx.beginPath();
        tx.ellipse(-10 * s, -13 * s, 5 * s, 3 * s, 0, 0, Math.PI * 2);
        tx.ellipse(12 * s, -13 * s, 5 * s, 3 * s, 0, 0, Math.PI * 2);
        tx.fill();
        // Ears
        tx.fillStyle = "#c47a2e";
        tx.beginPath();
        tx.arc(-17 * s, -20 * s, 7 * s, 0, Math.PI * 2);
        tx.arc(19 * s, -20 * s, 7 * s, 0, Math.PI * 2);
        tx.fill();
        tx.fillStyle = "#e8c09a";
        tx.beginPath();
        tx.arc(-17 * s, -20 * s, 4 * s, 0, Math.PI * 2);
        tx.arc(19 * s, -20 * s, 4 * s, 0, Math.PI * 2);
        tx.fill();
        // Floating hearts
        tx.font = `${9 * s}px serif`;
        tx.textAlign = "center";
        tx.globalAlpha = 0.85;
        tx.fillText("ğŸ’›", -26 * s, -34 * s);
        tx.fillText("â¤ï¸", 24 * s, -30 * s);
        tx.fillText("âœ¨", 30 * s, -44 * s);
        tx.globalAlpha = 1;
        tx.restore();
        tx.restore();
      }

      // â”€â”€â”€ WIN SCENE ANIMATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let winAnimId;

      function animateWinScene() {
        const wc = document.getElementById("win-canvas");
        if (!wc) return;
        const wx = wc.getContext("2d");
        const w = wc.width,
          h = wc.height;
        let wf = 0;

        function frame() {
          wf++;
          wx.clearRect(0, 0, w, h);

          // Sky
          const bg = wx.createLinearGradient(0, 0, 0, h);
          bg.addColorStop(0, "#05020f");
          bg.addColorStop(1, "#1a0a2e");
          wx.fillStyle = bg;
          wx.fillRect(0, 0, w, h);

          // Twinkling stars
          for (let i = 0; i < 20; i++) {
            const al = 0.3 + 0.7 * Math.abs(Math.sin(wf * 0.04 + i * 1.4));
            wx.globalAlpha = al;
            wx.fillStyle = "white";
            wx.beginPath();
            wx.arc((i * 97) % w, (i * 53) % (h * 0.52), 1.2, 0, Math.PI * 2);
            wx.fill();
          }
          wx.globalAlpha = 1;

          // Moon
          wx.fillStyle = "#ffd166";
          wx.shadowColor = "#ffd16655";
          wx.shadowBlur = 10;
          wx.beginPath();
          wx.arc(w * 0.82, h * 0.17, 15, 0, Math.PI * 2);
          wx.fill();
          wx.shadowBlur = 0;

          // Ground
          wx.fillStyle = "#1a0a3e";
          wx.fillRect(0, h * 0.68, w, h * 0.32);
          wx.strokeStyle = "#2d1b69";
          wx.lineWidth = 2;
          wx.beginPath();
          wx.moveTo(0, h * 0.68);
          wx.lineTo(w, h * 0.68);
          wx.stroke();

          // Rocks
          wx.fillStyle = "#2a2240";
          wx.beginPath();
          wx.ellipse(w * 0.24, h * 0.68, 28, 17, -0.2, 0, Math.PI * 2);
          wx.fill();
          wx.beginPath();
          wx.ellipse(w * 0.74, h * 0.68, 20, 13, 0.1, 0, Math.PI * 2);
          wx.fill();

          // Swaying grass
          wx.strokeStyle = "rgba(100,200,120,.3)";
          wx.lineWidth = 1.5;
          for (let i = 0; i < 8; i++) {
            const gx = i * (w / 8) + 16,
              gy = h * 0.68;
            const sw = Math.sin(wf * 0.04 + i * 0.8) * 6;
            wx.beginPath();
            wx.moveTo(gx, gy);
            wx.quadraticCurveTo(gx + sw, gy - 12, gx + sw * 1.5, gy - 20);
            wx.stroke();
          }

          // Wind lines
          wx.strokeStyle = "rgba(150,200,255,.06)";
          wx.lineWidth = 1.5;
          for (let i = 0; i < 3; i++) {
            const wy = h * 0.28 + i * 9,
              ph = wf * 0.03 + i * 1.2;
            wx.beginPath();
            wx.moveTo(0, wy);
            for (let x = 0; x < w; x += 8)
              wx.lineTo(x, wy + Math.sin(x * 0.04 + ph) * 3);
            wx.stroke();
          }

          const cx2 = w * 0.5,
            cy2 = h * 0.72;
          const breathe = Math.sin(wf * 0.06) * 0.6; // breathing animation

          // Mother silhouette shadow (abstract, emotional)
          wx.fillStyle = "rgba(45,20,80,.68)";
          wx.beginPath();
          wx.ellipse(cx2, cy2 + 12, 52, 20, 0, 0, Math.PI * 2);
          wx.fill();
          wx.fillStyle = "rgba(35,15,65,.65)";
          wx.beginPath();
          wx.ellipse(cx2 - 22, cy2 + 2, 17, 28, -0.3, 0, Math.PI * 2);
          wx.fill();
          wx.beginPath();
          wx.ellipse(cx2 + 22, cy2 + 2, 17, 28, 0.3, 0, Math.PI * 2);
          wx.fill();

          // Plushie â€” glowing warmly, fur particles floating
          wx.save();
          wx.translate(cx2 - 18, cy2 - 22 + breathe * 0.5);
          wx.shadowColor = "#ff4d6d77";
          wx.shadowBlur = 12;
          wx.fillStyle = "#ff4d6d";
          wx.beginPath();
          wx.arc(0, 0, 16, 0, Math.PI * 2);
          wx.fill();
          wx.shadowBlur = 0;
          wx.fillStyle = "#ff8fa3";
          wx.beginPath();
          wx.ellipse(0, 4, 12, 10, 0, 0, Math.PI * 2);
          wx.fill();
          wx.fillStyle = "#ff4d6d";
          wx.beginPath();
          wx.arc(-12, -12, 5, 0, Math.PI * 2);
          wx.arc(6, -13, 5, 0, Math.PI * 2);
          wx.fill();
          wx.restore();

          // Fur particles floating in wind
          for (let i = 0; i < 6; i++) {
            const ang = wf * 0.022 + i * ((Math.PI * 2) / 6);
            const dist = 22 + Math.sin(wf * 0.08 + i) * 5;
            const fx = cx2 - 18 + Math.cos(ang) * dist;
            const fy = cy2 - 22 + Math.sin(ang) * dist;
            wx.globalAlpha = 0.12 + 0.1 * Math.sin(wf * 0.06 + i);
            wx.fillStyle = "#ff8fa3";
            wx.beginPath();
            wx.arc(fx, fy, 2.2, 0, Math.PI * 2);
            wx.fill();
          }
          wx.globalAlpha = 1;

          // Punch sleeping, curled, breathing
          wx.save();
          wx.translate(cx2 + 4, cy2 - 24 + breathe);
          wx.fillStyle = "#c47a2e";
          wx.beginPath();
          wx.roundRect(-10, -18, 28, 24, 10);
          wx.fill();
          wx.beginPath();
          wx.arc(22, -18, 16, 0, Math.PI * 2);
          wx.fill();
          wx.fillStyle = "#e8a96a";
          wx.beginPath();
          wx.ellipse(22, -14, 11, 10, 0, 0, Math.PI * 2);
          wx.fill();
          // Closed sleeping eyes
          wx.strokeStyle = "#1a0a2e";
          wx.lineWidth = 2;
          wx.beginPath();
          wx.arc(16, -20, 4, Math.PI * 0.1, Math.PI * 0.9);
          wx.stroke();
          wx.beginPath();
          wx.arc(28, -20, 4, Math.PI * 0.1, Math.PI * 0.9);
          wx.stroke();
          // Tiny smile
          wx.beginPath();
          wx.arc(22, -13, 3, 0.2, Math.PI - 0.2);
          wx.stroke();
          // Ears
          wx.fillStyle = "#c47a2e";
          wx.beginPath();
          wx.arc(8, -24, 6, 0, Math.PI * 2);
          wx.arc(36, -24, 6, 0, Math.PI * 2);
          wx.fill();
          // Floating zzz
          const zoff = Math.sin(wf * 0.04) * 4;
          wx.fillStyle = "#ffd166";
          wx.font = "bold 11px Boogaloo";
          wx.textAlign = "left";
          wx.globalAlpha = 0.6 + 0.4 * Math.sin(wf * 0.06);
          wx.fillText("z", 40, -28 + zoff);
          wx.fillText("z", 47, -20 + zoff * 0.7);
          wx.fillText("z", 52, -36 + zoff * 0.5);
          wx.globalAlpha = 1;
          wx.restore();

          if (gameState === "won") winAnimId = requestAnimationFrame(frame);
        }

        frame();
      }

      // â”€â”€â”€ MAIN LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let animId;

      function mainLoop(ts) {
        if (gameState !== "playing") return;

        const dt = Math.min((ts - lastTS) / 1000, 0.05); // delta seconds, capped
        lastTS = ts;

        update(dt);
        renderFrame();

        animId = requestAnimationFrame(mainLoop);
      }

      // â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      resize();
      loadPersisted();
      buildHowToPlayContent(); // pre-build about content
      renderTitleArt();
      startBgMusic("calm"); // title screen flute
    </script>
  </body>
</html>
