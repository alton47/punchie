<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Punch's Great Escape üêí</title>
    <meta
      name="description"
      content="Help Punch the monkey get his red plushie back from the bully gang! Run, jump, slide through 10 wild levels. Free browser game inspired by a viral trend."
    />
    <meta
      name="keywords"
      content="punch monkey game, monkey runner game, punch plushie game, monkey escape game, free browser game, punch monkey trend"
    />
    <meta
      property="og:title"
      content="Punch's Great Escape üêí - Get the plushie back!"
    />
    <meta
      property="og:description"
      content="The bully monkeys YOINKED Punch's red plushie. Help him get it back through 10 wild levels!"
    />
    <meta name="twitter:card" content="summary" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêí</text></svg>"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Boogaloo&family=Nunito:wght@400;700;900&display=swap");

      :root {
        --org: #ff6b35;
        --org2: #c23b0a;
        --yel: #ffd166;
        --tea: #06d6a0;
        --red: #ff4d6d;
        --pur: #1a0a2e;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      html,
      body {
        width: 100%;
        height: 100%;
        background: #060210;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Boogaloo", cursive;
        overflow: hidden;
        touch-action: none;
        user-select: none;
        -webkit-user-select: none;
      }

      /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
      #wrap {
        position: relative;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      #gc {
        position: relative;
        overflow: hidden;
        background: #1a0a2e;
        box-shadow:
          0 0 80px rgba(255, 107, 53, 0.35),
          0 0 160px rgba(45, 27, 105, 0.5);
      }
      #canvas {
        display: block;
        touch-action: none;
      }

      /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
      .scr {
        position: absolute;
        inset: 0;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }
      .scr.on {
        display: flex;
      }

      /* ‚îÄ‚îÄ HUD ‚îÄ‚îÄ */
      #hud {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: none;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(6px);
        z-index: 20;
        flex-wrap: nowrap;
      }
      #hud.on {
        display: flex;
      }
      #hud-hearts {
        font-size: clamp(13px, 2.5vw, 18px);
        white-space: nowrap;
      }
      #hud-level {
        font-size: clamp(11px, 2vw, 15px);
        color: var(--tea);
        white-space: nowrap;
      }
      #hud-prog-wrap {
        flex: 1;
        height: 7px;
        background: rgba(255, 255, 255, 0.12);
        border-radius: 4px;
        overflow: hidden;
        min-width: 40px;
      }
      #hud-prog {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--tea), var(--yel));
        border-radius: 4px;
        transition: width 0.3s;
      }
      #hud-score {
        font-size: clamp(11px, 2vw, 15px);
        color: var(--yel);
        white-space: nowrap;
      }
      #hud-gems {
        font-size: clamp(10px, 1.8vw, 13px);
        color: #a78bfa;
        white-space: nowrap;
      }
      #hud-immuno {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 213, 79, 0.9);
        color: #1a0a2e;
        padding: 1px 10px;
        font-size: 12px;
        border-radius: 0 0 8px 8px;
        display: none;
      }
      #hud-pause {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        font-size: clamp(12px, 2vw, 16px);
        cursor: pointer;
        border-radius: 6px;
        padding: 3px 8px;
        font-family: "Boogaloo", cursive;
        flex-shrink: 0;
      }

      /* ‚îÄ‚îÄ TOP-RIGHT BUTTONS (coffee + mute) ‚îÄ‚îÄ */
      #top-btns {
        position: absolute;
        top: clamp(36px, 7vw, 55px);
        right: 8px;
        display: none;
        flex-direction: column;
        gap: 6px;
        z-index: 30;
        align-items: flex-end;
      }
      #top-btns.on {
        display: flex;
      }
      #coffee-link {
        background: rgba(255, 213, 79, 0.15);
        border: 1px solid rgba(255, 213, 79, 0.4);
        color: var(--yel);
        text-decoration: none;
        padding: 4px 10px;
        font-size: clamp(10px, 1.8vw, 12px);
        font-family: "Boogaloo", cursive;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
        transition: background 0.2s;
      }
      #coffee-link:hover {
        background: rgba(255, 213, 79, 0.28);
      }
      #mute-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        align-self: flex-end;
        transition: background 0.2s;
      }
      #mute-btn:hover {
        background: rgba(255, 255, 255, 0.22);
      }

      /* dev badge */
      #dev-badge {
        position: absolute;
        top: clamp(36px, 7vw, 55px);
        left: 8px;
        background: rgba(255, 77, 109, 0.2);
        border: 1px solid rgba(255, 77, 109, 0.5);
        color: var(--red);
        padding: 3px 10px;
        font-size: 11px;
        font-family: "Nunito", sans-serif;
        border-radius: 10px;
        z-index: 30;
        display: none;
      }
      #dev-badge.on {
        display: block;
      }

      /* ‚îÄ‚îÄ MOBILE CONTROLS ‚îÄ‚îÄ */
      #mob-ctrl {
        position: absolute;
        bottom: clamp(30px, 6vw, 50px);
        left: 0;
        right: 0;
        display: none;
        justify-content: space-between;
        padding: 0 clamp(10px, 3vw, 24px);
        z-index: 20;
        pointer-events: none;
      }
      #mob-ctrl.on {
        display: flex;
      }
      .mb {
        width: clamp(58px, 13vw, 76px);
        height: clamp(58px, 13vw, 76px);
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: clamp(24px, 5vw, 32px);
        pointer-events: all;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
        transition:
          background 0.1s,
          transform 0.1s;
        backdrop-filter: blur(4px);
      }
      .mb:active {
        background: rgba(255, 255, 255, 0.28);
        transform: scale(0.88);
      }
      #mb-mid {
        display: flex;
        gap: 10px;
      }

      /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
      #toast {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid var(--yel);
        border-radius: 16px;
        padding: 14px 28px;
        text-align: center;
        z-index: 55;
        pointer-events: none;
        display: none;
        backdrop-filter: blur(10px);
      }
      #toast-num {
        font-size: clamp(42px, 10vw, 64px);
        color: var(--yel);
        line-height: 1;
      }
      #toast-sub {
        font-size: clamp(13px, 2.5vw, 18px);
        color: rgba(255, 255, 255, 0.85);
        font-family: "Nunito", sans-serif;
      }
      #toast-bg {
        font-size: clamp(11px, 2vw, 15px);
        color: var(--tea);
        margin-top: 2px;
      }

      /* ‚îÄ‚îÄ RARE BANNER ‚îÄ‚îÄ */
      #rare-banner {
        position: absolute;
        top: clamp(45px, 9vw, 70px);
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, var(--yel), #ff9f1c);
        color: #1a0a2e;
        padding: 7px 20px;
        border-radius: 30px;
        font-size: clamp(12px, 2.3vw, 15px);
        font-family: "Nunito", sans-serif;
        font-weight: 700;
        z-index: 45;
        pointer-events: none;
        display: none;
        white-space: nowrap;
        box-shadow: 0 4px 20px rgba(255, 209, 102, 0.5);
      }
      #rare-banner.pop {
        display: block;
        animation: rarePop 2.6s ease forwards;
      }
      @keyframes rarePop {
        0% {
          opacity: 0;
          transform: translateX(-50%) scale(0.5);
        }
        15% {
          opacity: 1;
          transform: translateX(-50%) scale(1.1);
        }
        25% {
          transform: translateX(-50%) scale(1);
        }
        75% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translateX(-50%) scale(0.8);
        }
      }

      /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
      .madeby {
        position: absolute;
        bottom: clamp(3px, 1vw, 8px);
        left: 50%;
        transform: translateX(-50%);
        font-size: clamp(9px, 1.6vw, 11px);
        color: rgba(255, 255, 255, 0.22);
        font-family: "Nunito", sans-serif;
        white-space: nowrap;
        z-index: 5;
        pointer-events: all;
      }
      .madeby a {
        color: rgba(255, 255, 255, 0.4);
        text-decoration: none;
      }
      .madeby a:hover {
        color: rgba(255, 255, 255, 0.7);
      }

      /* ‚îÄ‚îÄ TITLE SCREEN ‚îÄ‚îÄ */
      #scr-title {
        padding: clamp(12px, 2vw, 20px);
        gap: 4px;
        background: transparent;
      }
      #title-canvas-wrap {
        position: relative;
        flex-shrink: 0;
      }
      .gtitle {
        font-size: clamp(28px, 7vw, 62px);
        color: var(--org);
        text-shadow:
          3px 3px 0 var(--org2),
          0 0 40px rgba(255, 107, 53, 0.4);
        line-height: 1;
        text-align: center;
        letter-spacing: 2px;
        margin-top: 4px;
      }
      .gsubtitle {
        font-size: clamp(10px, 2.2vw, 15px);
        color: var(--yel);
        letter-spacing: 3px;
        text-align: center;
        margin: 3px 0 10px;
      }
      .story-box {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 107, 53, 0.2);
        border-radius: 12px;
        padding: 10px 16px;
        max-width: 440px;
        font-size: clamp(11px, 2.2vw, 14px);
        font-family: "Nunito", sans-serif;
        color: rgba(255, 255, 255, 0.82);
        line-height: 1.6;
        text-align: center;
        margin-bottom: 12px;
        width: 100%;
      }
      .btn-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .btn-p {
        background: var(--org);
        color: white;
        border: none;
        padding: clamp(9px, 2vw, 14px) clamp(24px, 5vw, 44px);
        font-size: clamp(16px, 3.5vw, 24px);
        font-family: "Boogaloo", cursive;
        border-radius: 50px;
        cursor: pointer;
        box-shadow:
          0 5px 0 var(--org2),
          0 0 28px rgba(255, 107, 53, 0.4);
        transition:
          transform 0.1s,
          box-shadow 0.1s;
        letter-spacing: 1px;
      }
      .btn-p:active {
        transform: translateY(2px);
        box-shadow: 0 3px 0 var(--org2);
      }
      .btn-s {
        background: transparent;
        color: rgba(255, 255, 255, 0.55);
        border: 1px solid rgba(255, 255, 255, 0.18);
        padding: 7px 20px;
        font-size: clamp(11px, 2.2vw, 14px);
        font-family: "Boogaloo", cursive;
        border-radius: 50px;
        cursor: pointer;
        margin-top: 6px;
        transition: all 0.2s;
      }
      .btn-s:hover {
        color: white;
        border-color: rgba(255, 255, 255, 0.45);
      }
      .btn-t {
        background: var(--tea);
        color: #0d1a14;
        border: none;
        padding: clamp(8px, 1.8vw, 12px) clamp(18px, 4vw, 30px);
        font-size: clamp(13px, 2.8vw, 18px);
        font-family: "Boogaloo", cursive;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0 4px 0 #028a66;
      }
      .btn-r {
        background: var(--red);
        color: white;
        border: none;
        padding: clamp(8px, 1.8vw, 12px) clamp(18px, 4vw, 30px);
        font-size: clamp(13px, 2.8vw, 18px);
        font-family: "Boogaloo", cursive;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0 4px 0 #a01030;
      }
      .btn-sh {
        background: linear-gradient(135deg, var(--org), var(--red));
        color: white;
        border: none;
        padding: clamp(8px, 1.8vw, 12px) clamp(18px, 4vw, 30px);
        font-size: clamp(13px, 2.8vw, 18px);
        font-family: "Boogaloo", cursive;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0 4px 0 #a01030;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .best-row {
        font-size: clamp(10px, 1.8vw, 13px);
        color: rgba(255, 255, 255, 0.3);
        font-family: "Nunito", sans-serif;
        margin-top: 8px;
        text-align: center;
      }

      /* ‚îÄ‚îÄ HOW TO PLAY SCREEN ‚îÄ‚îÄ */
      #scr-how {
        padding: clamp(10px, 2vw, 18px);
        gap: 8px;
        overflow-y: auto;
        background: linear-gradient(160deg, #0d0420, #1a0a2e, #2d1b69);
      }
      #scr-how h2 {
        font-size: clamp(22px, 5vw, 38px);
        color: var(--yel);
        margin-bottom: 4px;
      }
      .ctrl-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 7px;
        width: 100%;
        max-width: 480px;
      }
      .ctrl-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 8px 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .ctrl-key {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 6px;
        padding: 3px 7px;
        font-size: clamp(10px, 1.8vw, 13px);
        color: var(--yel);
        white-space: nowrap;
        min-width: 55px;
        text-align: center;
        line-height: 1.4;
      }
      .ctrl-desc {
        font-size: clamp(10px, 1.8vw, 12px);
        font-family: "Nunito", sans-serif;
        color: rgba(255, 255, 255, 0.75);
        line-height: 1.3;
      }
      .gem-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
        width: 100%;
        max-width: 480px;
      }
      .gem-card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 6px 8px;
        text-align: center;
      }
      .gem-card .gem-ico {
        font-size: clamp(14px, 3vw, 20px);
      }
      .gem-card .gem-nm {
        font-size: clamp(9px, 1.6vw, 11px);
        font-family: "Nunito", sans-serif;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 2px;
        line-height: 1.2;
      }
      .villain-list {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        justify-content: center;
        max-width: 480px;
      }
      .vbadge {
        background: rgba(255, 77, 109, 0.12);
        border: 1px solid rgba(255, 77, 109, 0.3);
        border-radius: 7px;
        padding: 4px 9px;
        font-size: clamp(9px, 1.7vw, 11px);
        font-family: "Nunito", sans-serif;
        color: rgba(255, 190, 190, 0.9);
      }
      .goal-box {
        background: rgba(6, 214, 160, 0.08);
        border: 1px solid rgba(6, 214, 160, 0.28);
        border-radius: 10px;
        padding: 8px 14px;
        font-size: clamp(10px, 1.9vw, 13px);
        font-family: "Nunito", sans-serif;
        color: rgba(200, 255, 240, 0.9);
        text-align: center;
        max-width: 460px;
        line-height: 1.5;
        width: 100%;
      }

      /* ‚îÄ‚îÄ ABOUT ‚îÄ‚îÄ */
      #scr-about {
        padding: clamp(12px, 2.5vw, 22px);
        gap: 8px;
        overflow-y: auto;
        background: linear-gradient(160deg, #0d0420, #1a0a2e, #2d1b69);
        align-items: flex-start;
      }
      #scr-about h2 {
        font-size: clamp(20px, 4.5vw, 34px);
        color: var(--org);
        align-self: center;
      }
      .about-section {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.09);
        border-radius: 12px;
        padding: 10px 14px;
        width: 100%;
        max-width: 480px;
        align-self: center;
      }
      .about-section h3 {
        font-size: clamp(13px, 2.5vw, 17px);
        color: var(--yel);
        margin-bottom: 6px;
      }
      .about-section p {
        font-size: clamp(10px, 1.9vw, 13px);
        font-family: "Nunito", sans-serif;
        color: rgba(255, 255, 255, 0.75);
        line-height: 1.7;
      }
      .about-section a {
        color: var(--tea);
      }
      .villain-about-list {
        list-style: none;
        margin-top: 6px;
      }
      .villain-about-list li {
        font-size: clamp(10px, 1.8vw, 12px);
        font-family: "Nunito", sans-serif;
        color: rgba(255, 255, 255, 0.7);
        padding: 3px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        line-height: 1.5;
      }
      .villain-about-list li strong {
        color: rgba(255, 220, 150, 0.9);
      }

      /* ‚îÄ‚îÄ PAUSE SCREEN ‚îÄ‚îÄ */
      #scr-pause {
        background: rgba(8, 2, 18, 0.9);
        backdrop-filter: blur(10px);
      }
      #scr-pause h2 {
        font-size: clamp(30px, 7vw, 52px);
        color: var(--yel);
        margin-bottom: 16px;
      }
      #scr-pause p {
        color: rgba(255, 255, 255, 0.5);
        font-family: "Nunito", sans-serif;
        font-size: clamp(11px, 2vw, 14px);
        margin-bottom: 20px;
        text-align: center;
      }
      #countdown {
        font-size: clamp(64px, 16vw, 110px);
        color: var(--org);
        text-shadow: 0 0 40px rgba(255, 107, 53, 0.6);
        display: none;
        line-height: 1;
      }

      /* ‚îÄ‚îÄ GAME OVER ‚îÄ‚îÄ */
      #scr-over {
        padding: clamp(12px, 2.5vw, 20px);
        gap: 7px;
        background: linear-gradient(160deg, #0d0420, #1a0a2e, #2d1b69);
      }
      #scr-over h2 {
        font-size: clamp(24px, 6vw, 46px);
        line-height: 1.1;
        text-align: center;
      }
      .fail-reason {
        font-size: clamp(12px, 2.5vw, 17px);
        color: rgba(255, 200, 100, 0.9);
        text-align: center;
        font-family: "Nunito", sans-serif;
        max-width: 360px;
      }
      .stats-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .s-box {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 8px 14px;
        text-align: center;
        min-width: 70px;
      }
      .s-box .val {
        font-size: clamp(18px, 4.5vw, 30px);
        color: var(--yel);
      }
      .s-box .lbl {
        font-size: clamp(9px, 1.7vw, 12px);
        font-family: "Nunito", sans-serif;
        color: rgba(255, 255, 255, 0.45);
      }
      .gems-collected {
        font-size: clamp(11px, 2vw, 14px);
        font-family: "Nunito", sans-serif;
        color: rgba(200, 180, 255, 0.8);
        text-align: center;
      }

      /* ‚îÄ‚îÄ WIN SCREEN ‚îÄ‚îÄ */
      #scr-win {
        padding: clamp(12px, 2.5vw, 20px);
        gap: 8px;
        background: linear-gradient(160deg, #0d0420, #1a0a2e, #2d1b69);
      }
      #scr-win h2 {
        font-size: clamp(22px, 5.5vw, 44px);
        color: var(--tea);
        text-shadow: 2px 2px 0 #028a66;
        text-align: center;
      }
      #win-canvas {
        border-radius: 12px;
        background: #050218;
      }
      .win-story {
        font-size: clamp(11px, 2.2vw, 14px);
        font-family: "Nunito", sans-serif;
        color: rgba(255, 255, 255, 0.85);
        text-align: center;
        max-width: 400px;
        line-height: 1.7;
      }

      /* ‚îÄ‚îÄ SCORE POPUP ‚îÄ‚îÄ */
      .spop {
        position: absolute;
        pointer-events: none;
        font-family: "Boogaloo", cursive;
        font-size: clamp(13px, 2.5vw, 18px);
        z-index: 45;
        animation: floatUp 0.9s ease-out forwards;
      }
      @keyframes floatUp {
        0% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(-55px) scale(1.3);
        }
      }
    </style>
  </head>
  <body>
    <div id="wrap">
      <div id="gc">
        <!-- CANVAS -->
        <canvas id="canvas"></canvas>

        <!-- HUD -->
        <div id="hud">
          <div id="hud-hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
          <div id="hud-level">LVL 1</div>
          <div id="hud-prog-wrap"><div id="hud-prog"></div></div>
          <div id="hud-gems">üíé0</div>
          <div id="hud-score">0</div>
          <button id="hud-pause" onclick="togglePause()">‚è∏</button>
          <div id="hud-immuno">üõ°Ô∏è IMMUNE</div>
        </div>

        <!-- TOP BUTTONS -->
        <div id="top-btns">
          <a
            id="coffee-link"
            href="https://buymeacoffee.com/allanito"
            target="_blank"
            onclick="pauseOnCoffee()"
            >‚òï Buy me a coffee</a
          >
          <button id="mute-btn" onclick="toggleMute()">üîä</button>
        </div>

        <!-- DEV BADGE -->
        <div id="dev-badge">üîß DEV MODE</div>

        <!-- TITLE SCREEN -->
        <div id="scr-title" class="scr on">
          <div id="title-canvas-wrap">
            <canvas id="title-canvas" width="160" height="160"></canvas>
          </div>
          <h1 class="gtitle">PUNCH'S<br />GREAT ESCAPE</h1>
          <p class="gsubtitle">üß∏ THE PLUSHIE MUST BE RECLAIMED üß∏</p>
          <div class="story-box">
            The bully monkeys <strong>YOINKED</strong> Punch's beloved red
            plushie.<br />
            Now he has to fight through 10 wild levels of chaos<br />to get it
            back. <em>Jump. Slide. Survive. Reclaim.</em>
          </div>
          <div class="btn-row">
            <button class="btn-p" onclick="goHow()">Start Game!! üêí</button>
            <button class="btn-s" onclick="goAbout()">üìñ About</button>
          </div>
          <button class="btn-s" onclick="startGame()">Skip intro ‚Üí</button>
          <div class="best-row">
            üèÜ Best: <span id="best-sc">‚Äî</span> &nbsp;|&nbsp; Max LVL:
            <span id="best-lv">‚Äî</span>
          </div>
        </div>

        <!-- HOW TO PLAY -->
        <div id="scr-how" class="scr">
          <h2>üéÆ How to Play</h2>
          <div class="ctrl-grid" id="ctrl-grid">
            <!-- filled by JS based on device -->
          </div>
          <div
            style="
              font-size: clamp(11px, 2vw, 14px);
              color: var(--yel);
              margin-top: 2px;
              text-align: center;
            "
          >
            ‚ö†Ô∏è Dangers ‚Äî Jump or Slide to avoid!
          </div>
          <div class="villain-list" id="villain-list-how"></div>
          <div
            style="
              font-size: clamp(11px, 2vw, 14px);
              color: #a78bfa;
              text-align: center;
            "
          >
            ‚ú® Hidden Gems to Collect
          </div>
          <div class="gem-grid" id="gem-grid-how"></div>
          <div class="goal-box">
            üéØ <strong>Goal:</strong> Survive all 10 levels and reclaim the
            <strong>Red Plushie</strong>!<br />Each level you need to beat MORE
            obstacles. Collect gems for powers!
          </div>
          <div class="btn-row">
            <button class="btn-p" onclick="startGame()">LET'S GO!! üöÄ</button>
          </div>
        </div>

        <!-- ABOUT -->
        <div id="scr-about" class="scr">
          <h2>üìñ About</h2>
          <div class="about-section">
            <h3>üêí The Story</h3>
            <p>
              Inspired by the viral <strong>Punch monkey trend</strong> that
              took over the internet ‚Äî a lil monkey and his beloved red plushie.
              The bullies took it. He wants it back. Simple. Emotional.
              Legendary.
            </p>
          </div>
          <div class="about-section">
            <h3>üë®‚Äçüíª The Creator</h3>
            <p>
              <strong>Allan</strong> saw the Punch trend on Instagram in early
              2026 and decided to jump in and spread some love. Built this in a
              day.
              <a href="https://github.com/alton47" target="_blank"
                >@alton47 on GitHub</a
              >
              ‚Ä¢
              <a href="https://buymeacoffee.com/allanito" target="_blank"
                >Buy him a coffee ‚òï</a
              >
            </p>
          </div>
          <div class="about-section">
            <h3>üëø The Villain Gang</h3>
            <ul class="villain-about-list" id="villain-about-list"></ul>
          </div>
          <div class="about-section">
            <h3>‚ú® Gem Powers</h3>
            <ul class="villain-about-list" id="gem-about-list"></ul>
          </div>
          <div class="about-section">
            <h3>üéÆ Goal</h3>
            <p>
              Get through all <strong>10 levels</strong>. Each level adds more
              obstacles. Collect gems for special powers ‚Äî especially the
              <strong>üîÆ Immunity Orb</strong> (rarest!). Reach level 10 and
              watch Punch finally sleep peacefully with his plushie. üíõ
            </p>
          </div>
          <div
            class="btn-row"
            style="
              justify-content: center;
              width: 100%;
              max-width: 480px;
              align-self: center;
            "
          >
            <button class="btn-p" onclick="startGame()">Play Now üêí</button>
            <button class="btn-s" onclick="showScr('scr-title')">‚Üê Back</button>
          </div>
        </div>

        <!-- PAUSE -->
        <div id="scr-pause" class="scr">
          <h2>‚è∏ PAUSED</h2>
          <p id="pause-hint">Press P / ESC or tap Resume to continue</p>
          <div id="countdown"></div>
          <div class="btn-row">
            <button class="btn-p" onclick="resumeGame()">‚ñ∂ Resume</button>
            <button class="btn-s" onclick="goTitle()">Main Menu</button>
          </div>
        </div>

        <!-- GAME OVER -->
        <div id="scr-over" class="scr">
          <h2 id="fail-title">üíÄ GOT CAUGHT</h2>
          <p class="fail-reason" id="fail-msg">The gang caught up...</p>
          <div class="stats-row">
            <div class="s-box">
              <div class="val" id="go-sc">0</div>
              <div class="lbl">Score</div>
            </div>
            <div class="s-box">
              <div class="val" id="go-lv">1</div>
              <div class="lbl">Level</div>
            </div>
            <div class="s-box">
              <div class="val" id="go-best">0</div>
              <div class="lbl">Best</div>
            </div>
            <div class="s-box">
              <div class="val" id="go-maxlv">1</div>
              <div class="lbl">Max LVL</div>
            </div>
          </div>
          <div class="gems-collected" id="go-gems">Gems: 0 / 0</div>
          <div
            id="continue-info"
            style="
              font-size: clamp(10px, 1.9vw, 13px);
              color: rgba(255, 255, 255, 0.5);
              font-family: &quot;Nunito&quot;, sans-serif;
              text-align: center;
            "
          ></div>
          <div class="btn-row" style="margin-top: 4px">
            <button class="btn-t" id="cont-btn" onclick="continueRun()">
              Continue ‚ù§Ô∏è
            </button>
            <button class="btn-r" onclick="restartGame()">Restart üîÑ</button>
            <button class="btn-sh" onclick="doShare('over')">üì§ Share</button>
          </div>
          <button class="btn-s" onclick="goTitle()">Main Menu</button>
        </div>

        <!-- WIN -->
        <div id="scr-win" class="scr">
          <h2>üß∏ PLUSHIE RECLAIMED!</h2>
          <canvas id="win-canvas" width="300" height="160"></canvas>
          <p class="win-story">
            Punch ran through jungle, ruins, storms and chaos...<br />and he
            made it. He curled up with the red plushie,<br /><strong
              >finally at peace. üíõ</strong
            >
          </p>
          <div class="stats-row" style="justify-content: center">
            <div class="s-box">
              <div class="val" id="win-sc">0</div>
              <div class="lbl">Score</div>
            </div>
            <div class="s-box">
              <div class="val" id="win-time">0s</div>
              <div class="lbl">Time</div>
            </div>
            <div class="s-box">
              <div class="val" id="win-gems">0</div>
              <div class="lbl">Gems</div>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn-sh" onclick="doShare('win')">
              üì§ Share Victory!
            </button>
            <button class="btn-p" onclick="restartGame()">Play Again üêí</button>
          </div>
        </div>

        <!-- LEVEL TOAST -->
        <div id="toast">
          <div id="toast-num">1</div>
          <div id="toast-sub">LEVEL START</div>
          <div id="toast-bg">üå¥ Monkey Zoo</div>
        </div>

        <!-- RARE BANNER -->
        <div id="rare-banner"></div>

        <!-- MOBILE CONTROLS -->
        <div id="mob-ctrl">
          <div
            class="mb"
            id="mb-slide"
            ontouchstart="mSlide(1)"
            ontouchend="mSlide(0)"
          >
            ‚Üì
          </div>
          <div id="mb-mid">
            <div class="mb" id="mb-jump" ontouchstart="mJump()">‚Üë</div>
          </div>
        </div>

        <!-- FOOTER -->
        <div class="madeby">
          made with ‚ù§Ô∏è
          <a href="https://github.com/alton47" target="_blank">Allan</a>
        </div>
      </div>
    </div>

    <script>
      "use strict";
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  PUNCH'S GREAT ESCAPE ‚Äî V3 Complete Engine
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      // ‚îÄ‚îÄ CANVAS / SIZING ‚îÄ‚îÄ
      const cv = document.getElementById("canvas");
      const cx = cv.getContext("2d");
      let W = 800,
        H = 300,
        GR = 240,
        GR2 = 0.82; // GR=ground Y, GR2=ratio
      const GC = document.getElementById("gc");

      function resize() {
        const vw = window.innerWidth,
          vh = window.innerHeight;
        // Landscape aspect 8:3.4
        let cw, ch;
        const aspect = 8 / 3.4;
        if (vw / vh > aspect) {
          ch = Math.min(vh * 0.97, 520);
          cw = Math.round(ch * aspect);
        } else {
          cw = Math.min(vw * 0.97, 880);
          ch = Math.round(cw / aspect);
        }
        cw = Math.max(cw, 300);
        ch = Math.max(ch, 128);
        cv.width = cw;
        cv.height = ch;
        W = cw;
        H = ch;
        GR = Math.round(H * 0.82);
        GC.style.width = cw + "px";
        GC.style.height = ch + Math.round(ch * 0.14) + "px";
        S = cw / 800; // global scale ratio
        if (gameState === "idle") drawTitleScene();
        drawTitleArt();
      }
      window.addEventListener("resize", resize);
      let S = 1; // scale

      // ‚îÄ‚îÄ AUDIO (100% Web Audio API, no samples, no copyright) ‚îÄ‚îÄ
      let AC,
        muted = false;
      function getAC() {
        if (!AC) AC = new (window.AudioContext || window.webkitAudioContext)();
        return AC;
      }

      function tone(freq, type, dur, vol = 0.25, delay = 0) {
        if (muted) return;
        try {
          const a = getAC(),
            o = a.createOscillator(),
            g = a.createGain();
          o.connect(g);
          g.connect(a.destination);
          o.type = type;
          o.frequency.setValueAtTime(freq, a.currentTime + delay);
          g.gain.setValueAtTime(0, a.currentTime + delay);
          g.gain.linearRampToValueAtTime(vol, a.currentTime + delay + 0.015);
          g.gain.exponentialRampToValueAtTime(
            0.001,
            a.currentTime + delay + dur,
          );
          o.start(a.currentTime + delay);
          o.stop(a.currentTime + delay + dur + 0.06);
        } catch (e) {}
      }
      function noise(dur, vol = 0.15) {
        if (muted) return;
        try {
          const a = getAC(),
            buf = a.createBuffer(1, a.sampleRate * dur, a.sampleRate);
          const d = buf.getChannelData(0);
          for (let i = 0; i < d.length; i++)
            d[i] = (Math.random() * 2 - 1) * (1 - i / d.length) * vol * 1.5;
          const s = a.createBufferSource(),
            g = a.createGain();
          s.buffer = buf;
          s.connect(g);
          g.connect(a.destination);
          g.gain.setValueAtTime(vol, a.currentTime);
          g.gain.exponentialRampToValueAtTime(0.001, a.currentTime + dur);
          s.start();
        } catch (e) {}
      }
      // Pentatonic: D E G A B (D pentatonic)
      const PENTA = [
        293.66, 329.63, 392, 440, 493.88, 587.33, 659.25, 783.99, 880,
      ];
      const WIND_SCALE = [220, 246.94, 293.66, 329.63, 370, 440]; // E minor

      let bgTimer = null,
        bgPhase = 0;
      const PHRASES = [
        [4, 6, 7, 6, 4, 2, 0, 2, 4, 2],
        [0, 2, 4, 2, 0, 4, 6, 7, 6, 4],
        [2, 4, 6, 7, 8, 7, 6, 4, 2, 0],
        [7, 6, 4, 2, 0, 2, 0, 4, 6, 7],
        [0, 4, 6, 4, 2, 4, 6, 7, 6, 4],
        [6, 7, 8, 7, 6, 4, 2, 4, 6, 7],
      ];

      function startMusic(context = "game") {
        stopMusic();
        if (muted) return;
        // Different tempos for contexts
        const tempo =
          context === "title" ? 0.44 : context === "end" ? 0.52 : 0.36;
        const phrase = PHRASES[bgPhase % PHRASES.length];
        bgPhase++;
        let step = 0;
        function nextNote() {
          if (muted) return;
          const idx = phrase[step % phrase.length];
          const freq = PENTA[idx];
          // Flute-like: main sine + harmonics
          tone(freq, "sine", tempo * 0.75, 0.13);
          tone(freq * 2, "sine", tempo * 0.4, 0.04);
          tone(freq * 3, "sine", tempo * 0.25, 0.02);
          if (step % 4 === 0) tone(freq * 0.5, "triangle", tempo * 2, 0.07); // bass pad
          // Wind ambience occasionally
          if (step % 7 === 0)
            tone(
              WIND_SCALE[Math.floor(Math.random() * WIND_SCALE.length)],
              "sine",
              tempo * 1.5,
              0.03,
            );
          step++;
          if (step < phrase.length * 2)
            bgTimer = setTimeout(nextNote, tempo * 1000);
          else bgTimer = setTimeout(() => startMusic(context), 500);
        }
        nextNote();
      }
      function stopMusic() {
        if (bgTimer) {
          clearTimeout(bgTimer);
          bgTimer = null;
        }
      }
      function toggleMute() {
        muted = !muted;
        document.getElementById("mute-btn").textContent = muted ? "üîá" : "üîä";
        if (!muted && (gameState === "playing" || gameState === "title_anim"))
          startMusic(gameState === "title_anim" ? "title" : "game");
        else if (muted) stopMusic();
      }

      // SFX
      const sfx = {
        jump: () => {
          tone(440, "sine", 0.12, 0.18);
          tone(600, "sine", 0.08, 0.1, 0.07);
        },
        djump: () => {
          tone(660, "triangle", 0.1, 0.18);
          tone(880, "sine", 0.1, 0.14, 0.06);
        },
        slide: () => {
          noise(0.1, 0.18);
          tone(220, "sine", 0.08, 0.08);
        },
        hit: () => {
          tone(180, "square", 0.18, 0.22);
          tone(120, "sawtooth", 0.14, 0.18, 0.06);
          setTimeout(() => sfx.mkcry(), 150);
        },
        mkcry: () => {
          tone(340, "sine", 0.07, 0.12);
          tone(260, "sine", 0.1, 0.1, 0.07);
          tone(190, "sine", 0.14, 0.08, 0.14);
        },
        mkpass: () => {
          tone(500, "sawtooth", 0.06, 0.08);
          tone(320, "sine", 0.08, 0.06, 0.05);
        }, // whoosh past
        banana: () => {
          tone(880, "sine", 0.06, 0.18);
          tone(1100, "sine", 0.08, 0.14, 0.05);
        },
        rare: () => {
          [784, 1047, 1319, 1568].forEach((f, i) =>
            tone(f, "triangle", 0.28, 0.16, i * 0.09),
          );
        },
        immuno: () => {
          [523, 659, 784, 1047, 1319].forEach((f, i) =>
            tone(f, "sine", 0.22, 0.18, i * 0.07),
          );
          sfx.rare();
        },
        lvlup: () => {
          [392, 523, 659, 784].forEach((f, i) =>
            tone(f, "sine", 0.22, 0.2, i * 0.1),
          );
        },
        death: () => {
          tone(300, "square", 0.1, 0.22);
          tone(200, "square", 0.15, 0.2, 0.1);
          tone(100, "sawtooth", 0.3, 0.28, 0.22);
        },
        win: () => {
          [523, 659, 784, 1047, 784, 1047, 1319, 1047].forEach((f, i) =>
            tone(f, "sine", 0.3, 0.22, i * 0.16),
          );
        },
        count: () => {
          tone(440, "triangle", 0.2, 0.22);
        },
        go: () => {
          tone(660, "sine", 0.15, 0.3);
          tone(880, "sine", 0.2, 0.25, 0.12);
        },
        gem: () => {
          tone(1047, "sine", 0.08, 0.2);
          tone(1319, "sine", 0.1, 0.16, 0.06);
          tone(1568, "sine", 0.08, 0.12, 0.12);
        },
        wind: () => {
          if (muted) return;
          try {
            const a = getAC(),
              o = a.createOscillator(),
              g = a.createGain();
            o.connect(g);
            g.connect(a.destination);
            o.type = "sine";
            o.frequency.setValueAtTime(80, a.currentTime);
            o.frequency.linearRampToValueAtTime(140, a.currentTime + 1.5);
            g.gain.setValueAtTime(0.04, a.currentTime);
            g.gain.linearRampToValueAtTime(0.08, a.currentTime + 0.8);
            g.gain.exponentialRampToValueAtTime(0.001, a.currentTime + 2.5);
            o.start();
            o.stop(a.currentTime + 2.8);
          } catch (e) {}
        },
      };

      // ‚îÄ‚îÄ VILLAIN DEFINITIONS ‚îÄ‚îÄ
      const VILLAINS = [
        {
          id: "slider",
          name: "Knuckles",
          color: "#ef476f",
          desc: "Low slider. Jump over!",
          action: "JUMP",
          tier: 1,
        },
        {
          id: "jumper",
          name: "Bobo",
          color: "#ff9f1c",
          desc: "Mid jumper. Jump over!",
          action: "JUMP",
          tier: 1,
        },
        {
          id: "vine",
          name: "Creepvine",
          color: "#06d6a0",
          desc: "Hanging vine. Duck under!",
          action: "DUCK",
          tier: 1,
        },
        {
          id: "stone",
          name: "Rockhead",
          color: "#94a3b8",
          desc: "Stone block. Jump over!",
          action: "JUMP",
          tier: 2,
        },
        {
          id: "peel",
          name: "Slippy",
          color: "#ffd166",
          desc: "Banana peel. Jump over!",
          action: "JUMP",
          tier: 2,
        },
        {
          id: "bigbobo",
          name: "BIG Bobo",
          color: "#f97316",
          desc: "Tall jumper. High jump!",
          action: "HIGH",
          tier: 3,
        },
        {
          id: "swinger",
          name: "Swingby",
          color: "#a855f7",
          desc: "Swings from top. Duck!",
          action: "DUCK",
          tier: 3,
        },
        {
          id: "double",
          name: "Twin Trap",
          color: "#ec4899",
          desc: "Two at once!",
          action: "JUMP",
          tier: 4,
        },
        {
          id: "boulder",
          name: "Crusher",
          color: "#6b7280",
          desc: "Rolling boulder.",
          action: "JUMP",
          tier: 4,
        },
        {
          id: "spike",
          name: "Stabby",
          color: "#ef4444",
          desc: "Spike wall. High jump!",
          action: "HIGH",
          tier: 5,
        },
      ];

      // ‚îÄ‚îÄ GEM DEFINITIONS ‚îÄ‚îÄ
      const GEMS = [
        {
          id: "coin",
          emoji: "ü™ô",
          name: "Gold Coin",
          pts: 30,
          rarity: 0.55,
          color: "#ffd166",
          effect: "pts",
          desc: "+30 points",
        },
        {
          id: "banana",
          emoji: "üçå",
          name: "Banana",
          pts: 50,
          rarity: 0.25,
          color: "#fdd835",
          effect: "pts",
          desc: "+50 points",
        },
        {
          id: "ruby",
          emoji: "üíé",
          name: "Ruby Gem",
          pts: 120,
          rarity: 0.1,
          color: "#ff4d6d",
          effect: "pts",
          desc: "+120 points",
        },
        {
          id: "heart",
          emoji: "‚ù§Ô∏è",
          name: "Heart Gem",
          pts: 0,
          rarity: 0.05,
          color: "#ff6b6b",
          effect: "life",
          desc: "+1 heart!",
        },
        {
          id: "star",
          emoji: "‚≠ê",
          name: "Lucky Star",
          pts: 200,
          rarity: 0.04,
          color: "#ffd166",
          effect: "pts",
          desc: "+200 points + luck",
        },
        {
          id: "clover",
          emoji: "üçÄ",
          name: "Lucky Clover",
          pts: 150,
          rarity: 0.03,
          color: "#4ade80",
          effect: "pts",
          desc: "+150 pts + speed boost",
        },
        {
          id: "crystal",
          emoji: "üîÆ",
          name: "Immunity Orb",
          pts: 80,
          rarity: 0.008,
          color: "#c084fc",
          effect: "immuno",
          desc: "5s IMMUNITY! (rarest!)",
        },
        {
          id: "diamond",
          emoji: "üí†",
          name: "Diamond Shard",
          pts: 300,
          rarity: 0.002,
          color: "#67e8f9",
          effect: "pts",
          desc: "+300 points (ultra rare!)",
        },
      ];

      // ‚îÄ‚îÄ FAIL MESSAGES ‚îÄ‚îÄ
      const FAILS = [
        {
          title: "üíÄ BONKED!",
          msg: "A rock to the skull. Stars for days. ‚≠ê",
          col: "#ff4d6d",
        },
        {
          title: "üçå SLIPPED!",
          msg: "Classic banana peel. No shame.",
          col: "#ffd166",
        },
        {
          title: "üêí TACKLED!",
          msg: "Knuckles body-slammed him. Ouch.",
          col: "#ff9f1c",
        },
        {
          title: "üåø TANGLED!",
          msg: "Creepvine grabbed him mid-run.",
          col: "#06d6a0",
        },
        {
          title: "ü™® CRUSHED!",
          msg: "Crusher rolled right over Punch.",
          col: "#94a3b8",
        },
        {
          title: "üëø AMBUSHED!",
          msg: "Twin Trap ‚Äî they planned this.",
          col: "#ec4899",
        },
        {
          title: "‚ö° SPIKED!",
          msg: "Stabby came out of nowhere. Gone.",
          col: "#ef4444",
        },
        {
          title: "üòµ OVERWHELMED!",
          msg: "The whole gang showed up. It's a party.",
          col: "#a855f7",
        },
      ];

      // ‚îÄ‚îÄ LEVEL CONFIGS ‚îÄ‚îÄ
      const LEVELS = [
        {
          name: "Monkey Zoo",
          emoji: "üèõÔ∏è",
          bg: "zoo",
          speed: 3.8,
          obsCount: 10,
          desc: "Welcome to the zoo!",
        },
        {
          name: "Bamboo Forest",
          emoji: "üéã",
          bg: "bamboo",
          speed: 4.1,
          obsCount: 11,
          desc: "Watch the bamboo!",
        },
        {
          name: "River Banks",
          emoji: "üåä",
          bg: "river",
          speed: 4.4,
          obsCount: 12,
          desc: "Slippery here!",
        },
        {
          name: "Ancient Ruins",
          emoji: "üèõÔ∏è",
          bg: "ruins",
          speed: 4.8,
          obsCount: 13,
          desc: "Old temple chaos",
        },
        {
          name: "Mushroom Grove",
          emoji: "üçÑ",
          bg: "mushroom",
          speed: 5.2,
          obsCount: 14,
          desc: "Things get weird",
        },
        {
          name: "Crystal Cave",
          emoji: "üíé",
          bg: "cave",
          speed: 5.6,
          obsCount: 15,
          desc: "Dark & shiny",
        },
        {
          name: "Volcano Edge",
          emoji: "üåã",
          bg: "volcano",
          speed: 6.0,
          obsCount: 16,
          desc: "HOT HOT HOT!",
        },
        {
          name: "Moonlit Path",
          emoji: "üåô",
          bg: "moon",
          speed: 6.5,
          obsCount: 17,
          desc: "Almost there...",
        },
        {
          name: "Storm Valley",
          emoji: "‚ö°",
          bg: "storm",
          speed: 7.0,
          obsCount: 18,
          desc: "Final stretch!",
        },
        {
          name: "THE PLUSHIE!!!",
          emoji: "üß∏",
          bg: "final",
          speed: 7.5,
          obsCount: 20,
          desc: "THIS IS IT! üî•",
        },
      ];

      // ‚îÄ‚îÄ BACKGROUND THEMES ‚îÄ‚îÄ
      const BGTM = {
        zoo: {
          sky: ["#1a3a4a", "#0d1f2d"],
          gnd: ["#4a3a1a", "#2a1a0a"],
          acc: "#8b5e3c",
        },
        bamboo: {
          sky: ["#0d2e1a", "#071a0d"],
          gnd: ["#2a4a1a", "#1a2a0a"],
          acc: "#4a7a3a",
        },
        river: {
          sky: ["#0d1a3a", "#071022"],
          gnd: ["#1a3a4a", "#0a1a2a"],
          acc: "#3a6a8a",
        },
        ruins: {
          sky: ["#2a1a0a", "#1a0a05"],
          gnd: ["#3a2a1a", "#1a1a0a"],
          acc: "#7a6a4a",
        },
        mushroom: {
          sky: ["#2a0a2a", "#1a051a"],
          gnd: ["#3a1a3a", "#1a0a1a"],
          acc: "#8a3a8a",
        },
        cave: {
          sky: ["#0a0a1a", "#050510"],
          gnd: ["#1a1a2a", "#0a0a1a"],
          acc: "#3a3a6a",
        },
        volcano: {
          sky: ["#2a0a00", "#1a0500"],
          gnd: ["#3a1a0a", "#1a0a05"],
          acc: "#ff4a00",
        },
        moon: {
          sky: ["#0a0a2a", "#05051a"],
          gnd: ["#1a1a3a", "#0a0a1a"],
          acc: "#4a4a8a",
        },
        storm: {
          sky: ["#0a0a0a", "#050508"],
          gnd: ["#1a1a0a", "#0a0a05"],
          acc: "#dfdf00",
        },
        final: {
          sky: ["#1a0a2e", "#0d0420"],
          gnd: ["#2d1b69", "#1a0a3e"],
          acc: "#ff6b35",
        },
      };

      // ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ
      let gameState = "idle"; // idle|howtoplay|playing|paused|over|won|transition
      let score = 0,
        bestScore = 0,
        bestLevel = 1;
      let level = 1,
        lives = 3;
      let obsBeaten = 0,
        obsNeeded = 10; // level completion = beat N obstacles
      let speed = 3.8,
        frame = 0,
        hitCD = 0,
        immunoTimer = 0;
      let devMode = false,
        speedBoost = 0;
      let gemsCollected = 0,
        gemsTotal = 0,
        gemTypes = {};
      let particles = [],
        obstacles = [],
        collectibles = [],
        bgObjs = [];
      let obsSpawnCD = 50,
        colSpawnCD = 100;
      let startTime = 0;
      let bgX = [0, 0, 0, 0]; // parallax layers

      // ‚îÄ‚îÄ PUNCH ‚îÄ‚îÄ
      const P = {
        x: 0,
        y: 0,
        w: 0,
        h: 0,
        vy: 0,
        jc: 0,
        jumping: false,
        sliding: false,
        slideT: 0,
        aF: 0,
        aT: 0,
        get hy() {
          return this.y - (this.sliding ? this.h * 0.5 : this.h);
        },
        get hh() {
          return this.sliding ? this.h * 0.5 : this.h;
        },
      };

      function initP() {
        P.w = Math.round(44 * S);
        P.h = Math.round(52 * S);
        P.x = Math.round(W * 0.14);
        P.y = GR;
        P.vy = 0;
        P.jc = 0;
        P.jumping = false;
        P.sliding = false;
        P.slideT = 0;
        P.aF = 0;
        P.aT = 0;
      }

      // ‚îÄ‚îÄ LOAD/SAVE ‚îÄ‚îÄ
      function loadSaved() {
        try {
          bestScore = parseInt(localStorage.getItem("pmx_best") || "0");
          bestLevel = parseInt(localStorage.getItem("pmx_blv") || "1");
        } catch (e) {}
        document.getElementById("best-sc").textContent = bestScore || "‚Äî";
        document.getElementById("best-lv").textContent =
          bestLevel > 1 ? bestLevel : "‚Äî";
      }
      function saveBest() {
        try {
          if (score > bestScore) {
            bestScore = score;
            localStorage.setItem("pmx_best", bestScore);
          }
          if (level > bestLevel) {
            bestLevel = level;
            localStorage.setItem("pmx_blv", bestLevel);
          }
        } catch (e) {}
      }
      loadSaved();

      // ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ
      const K = {};
      document.addEventListener("keydown", (e) => {
        if (K[e.code]) return;
        K[e.code] = true;
        if (e.code === "Space" || e.code === "ArrowUp" || e.code === "KeyW") {
          e.preventDefault();
          if (gameState === "playing") doJump();
        }
        if (e.code === "ArrowDown" || e.code === "KeyS") {
          e.preventDefault();
          if (gameState === "playing") doSlide();
        }
        if (
          (e.code === "KeyP" || e.code === "Escape") &&
          (gameState === "playing" || gameState === "paused")
        ) {
          e.preventDefault();
          togglePause();
        }
        if (e.code === "KeyL" && gameState === "playing") {
          devMode = !devMode;
          document.getElementById("dev-badge").classList.toggle("on", devMode);
          if (devMode) {
            speed *= 0.4;
            lives = Math.max(lives, 5);
          } else recalcSpeed();
          sfx.rare();
        }
        if (e.code === "ArrowRight" && gameState === "playing") {
          speedBoost = 60;
        } // speed burst
      });
      document.addEventListener("keyup", (e) => {
        K[e.code] = false;
        if ((e.code === "ArrowDown" || e.code === "KeyS") && P.sliding) {
          P.sliding = false;
          P.slideT = 0;
        }
        if (e.code === "ArrowRight") {
          speedBoost = 0;
        }
      });

      // Touch / swipe
      let tsy = 0,
        tsx = 0,
        tsT = 0;
      document.addEventListener(
        "touchstart",
        (e) => {
          tsy = e.touches[0].clientY;
          tsx = e.touches[0].clientX;
          tsT = Date.now();
        },
        { passive: true },
      );
      document.addEventListener(
        "touchend",
        (e) => {
          if (gameState !== "playing") return;
          const dy = tsy - e.changedTouches[0].clientY;
          const dx = tsx - e.changedTouches[0].clientX;
          const dt = Date.now() - tsT;
          if (Math.abs(dy) > Math.abs(dx)) {
            if (dy > 18) doJump();
            else if (dy < -18) {
              P.sliding = true;
              P.slideT = 45;
            }
          } else {
            if (dx > 30 && dt < 300) speedBoost = 80; // swipe right = speed boost
            if (Math.abs(dy) < 15 && Math.abs(dx) < 20) doJump(); // tap = jump
          }
        },
        { passive: true },
      );

      function mJump() {
        if (gameState === "playing") doJump();
      }
      function mSlide(on) {
        if (gameState === "playing" && on) {
          P.sliding = true;
          P.slideT = 45;
        } else {
          P.sliding = false;
          P.slideT = 0;
        }
      }

      function doJump() {
        if (P.jc < 2) {
          P.vy = P.jc === 0 ? -15 * S * 0.82 : -12 * S * 0.82;
          P.jumping = true;
          P.jc++;
          P.sliding = false;
          spawnPtcl(P.x + P.w / 2, P.y, "#ffd166", 5);
          P.jc === 1 ? sfx.jump() : sfx.djump();
        }
      }
      function doSlide() {
        if (!P.jumping) {
          if (!P.sliding) sfx.slide();
          P.sliding = true;
          P.slideT = 45;
        }
      }

      // ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ
      function showScr(id) {
        document
          .querySelectorAll(".scr")
          .forEach((s) => s.classList.remove("on"));
        document.getElementById(id).classList.add("on");
      }
      function showHUD(v) {
        document.getElementById("hud").classList.toggle("on", v);
        document.getElementById("top-btns").classList.toggle("on", v);
        document
          .getElementById("mob-ctrl")
          .classList.toggle("on", v && isMobile());
      }
      function isMobile() {
        return window.innerWidth < 900 || "ontouchstart" in window;
      }

      function goHow() {
        buildCtrlGrid();
        buildHowGems();
        buildHowVillains();
        showScr("scr-how");
      }
      function goAbout() {
        buildAboutVillains();
        buildAboutGems();
        showScr("scr-about");
      }
      function goTitle() {
        gameState = "idle";
        stopMusic();
        cancelAnimationFrame(animID);
        showScr("scr-title");
        showHUD(false);
        loadSaved();
        setTimeout(() => startMusic("title"), 300);
      }
      function pauseOnCoffee() {
        if (gameState === "playing") {
          gameState = "paused";
          stopMusic();
          showScr("scr-pause");
          document.getElementById("hud-pause").textContent = "‚ñ∂";
        }
      }

      function buildCtrlGrid() {
        const mobile = isMobile();
        const ctrl = document.getElementById("ctrl-grid");
        const cards = mobile
          ? [
              { k: "Swipe ‚Üë / Tap", d: "Jump (tap again = double jump)" },
              { k: "Swipe ‚Üì", d: "Slide / duck under vines" },
              { k: "Swipe ‚Üí ", d: "Speed burst!" },
              { k: "P / ESC", d: "Pause / Resume (3-2-1)" },
            ]
          : [
              { k: "SPACE / ‚Üë / W", d: "Jump (double jump!)" },
              { k: "‚Üì / S", d: "Slide / duck under vines" },
              { k: "‚Üí / ArrowRight", d: "Speed burst!" },
              { k: "P / ESC", d: "Pause ‚Äî 3-2-1 to resume" },
              { k: "L key", d: "üîß Dev mode ‚Äî slow + revive" },
              { k: "A / ‚Üê ", d: "(future: roll)" },
            ];
        ctrl.innerHTML = cards
          .map(
            (c) =>
              `<div class="ctrl-card"><div class="ctrl-key">${c.k}</div><div class="ctrl-desc">${c.d}</div></div>`,
          )
          .join("");
      }
      function buildHowGems() {
        document.getElementById("gem-grid-how").innerHTML = GEMS.map(
          (g) =>
            `<div class="gem-card"><div class="gem-ico">${g.emoji}</div><div class="gem-nm"><b>${g.name}</b><br>${g.desc}</div></div>`,
        ).join("");
      }
      function buildHowVillains() {
        document.getElementById("villain-list-how").innerHTML = VILLAINS.map(
          (v) => `<div class="vbadge">${v.name} ‚Äî <b>${v.action}</b></div>`,
        ).join("");
      }
      function buildAboutVillains() {
        document.getElementById("villain-about-list").innerHTML = VILLAINS.map(
          (v) =>
            `<li><strong>${v.name}</strong> (${v.id}) ‚Äî ${v.desc} Tier ${v.tier}.</li>`,
        ).join("");
      }
      function buildAboutGems() {
        document.getElementById("gem-about-list").innerHTML = GEMS.map(
          (g) =>
            `<li>${g.emoji} <strong>${g.name}</strong> ‚Äî ${g.desc} (rarity ${Math.round(g.rarity * 100)}%)</li>`,
        ).join("");
      }

      // ‚îÄ‚îÄ PAUSE ‚îÄ‚îÄ
      let resuming = false;
      function togglePause() {
        if (gameState === "playing") {
          gameState = "paused";
          stopMusic();
          showScr("scr-pause");
          document.getElementById("hud-pause").textContent = "‚ñ∂";
          document.getElementById("countdown").style.display = "none";
        } else if (gameState === "paused") resumeGame();
      }
      function resumeGame() {
        if (resuming) return;
        resuming = true;
        const cd = document.getElementById("countdown");
        cd.style.display = "block";
        cd.textContent = "3";
        sfx.count();
        let c = 3;
        const iv = setInterval(() => {
          c--;
          if (c > 0) {
            cd.textContent = c;
            sfx.count();
          } else {
            clearInterval(iv);
            cd.textContent = "GO!";
            sfx.go();
            setTimeout(() => {
              gameState = "playing";
              showScr("scr-title");
              document
                .querySelectorAll(".scr")
                .forEach((s) => s.classList.remove("on"));
              document.getElementById("hud-pause").textContent = "‚è∏";
              cd.style.display = "none";
              resuming = false;
              startMusic("game");
              loop();
            }, 400);
          }
        }, 800);
      }

      // ‚îÄ‚îÄ GAME INIT ‚îÄ‚îÄ
      let animID;
      function startGame() {
        stopMusic();
        score = 0;
        level = 1;
        lives = 3;
        frame = 0;
        hitCD = 0;
        immunoTimer = 0;
        gemsCollected = 0;
        gemsTotal = 0;
        gemTypes = {};
        obstacles = [];
        collectibles = [];
        particles = [];
        speedBoost = 0;
        devMode = false;
        document.getElementById("dev-badge").classList.remove("on");
        startTime = Date.now();
        showHUD(true);
        updateHUD();
        initLevel(1);
      }
      function initLevel(lv) {
        level = lv;
        const lc = LEVELS[lv - 1];
        obsBeaten = 0;
        obsNeeded = lc.obsCount;
        obstacles = [];
        collectibles = [];
        recalcSpeed();
        initP();
        bgX = [0, 0, 0, 0];
        updateHUD();
        document
          .querySelectorAll(".scr")
          .forEach((s) => s.classList.remove("on"));
        showLevelToast(lv, () => {
          gameState = "playing";
          startMusic("game");
          cancelAnimationFrame(animID);
          loop();
        });
      }
      function recalcSpeed() {
        const lc = LEVELS[Math.min(level - 1, 9)];
        speed = devMode
          ? lc.speed * 0.35
          : lc.speed + (speedBoost > 0 ? 1.5 : 0);
      }

      // ‚îÄ‚îÄ LEVEL TOAST ‚îÄ‚îÄ
      function showLevelToast(lv, cb) {
        const lc = LEVELS[lv - 1];
        document.getElementById("toast-num").textContent = lv;
        document.getElementById("toast-sub").textContent =
          lv === 10 ? "üèÜ FINAL LEVEL!" : "LEVEL " + lv;
        document.getElementById("toast-bg").textContent =
          lc.emoji + " " + lc.name + " ‚Äî " + lc.desc;
        document.getElementById("toast").style.display = "block";
        sfx.lvlup();
        setTimeout(() => {
          document.getElementById("toast").style.display = "none";
          if (cb) cb();
        }, 2000);
      }

      // ‚îÄ‚îÄ HUD UPDATE ‚îÄ‚îÄ
      function updateHUD() {
        let h = "";
        for (let i = 0; i < lives; i++) h += "‚ù§Ô∏è";
        for (let i = lives; i < 3; i++) h += "üñ§";
        document.getElementById("hud-hearts").textContent = h || "üíÄ";
        document.getElementById("hud-level").textContent = "LVL " + level;
        document.getElementById("hud-score").textContent = score;
        document.getElementById("hud-gems").textContent = "üíé" + gemsCollected;
        document.getElementById("hud-prog").style.width =
          (obsBeaten / obsNeeded) * 100 + "%";
        document.getElementById("hud-immuno").style.display =
          immunoTimer > 0 ? "block" : "none";
      }

      // ‚îÄ‚îÄ OBSTACLE SPAWNING ‚îÄ‚îÄ
      function getVillainsForLevel(lv) {
        // unlock villains progressively
        if (lv <= 2) return VILLAINS.filter((v) => v.tier === 1);
        if (lv <= 4) return VILLAINS.filter((v) => v.tier <= 2);
        if (lv <= 6) return VILLAINS.filter((v) => v.tier <= 3);
        if (lv <= 8) return VILLAINS.filter((v) => v.tier <= 4);
        return VILLAINS;
      }
      function spawnObs() {
        const pool = getVillainsForLevel(level);
        const v = pool[Math.floor(Math.random() * pool.length)];
        const w = Math.round(50 * S),
          hBase = Math.round(46 * S);
        let ob = {
          type: v.id,
          villain: v,
          x: W + 20,
          w,
          h: hBase,
          y: GR,
          animF: 0,
          passed: false,
        };
        if (v.id === "vine" || v.id === "swinger")
          ob.y = GR - Math.round(100 * S);
        if (v.id === "bigbobo") ob.h = Math.round(68 * S);
        if (v.id === "boulder") ob.w = ob.h = Math.round(42 * S);
        if (v.id === "spike") ob.w = Math.round(30 * S);
        obstacles.push(ob);
        // double trap spawns a second
        if (v.id === "double") {
          obstacles.push({
            type: "jumper",
            villain: VILLAINS[1],
            x: W + Math.round(90 * S),
            w,
            h: hBase,
            y: GR,
            animF: 0,
            passed: false,
          });
        }
      }
      function spawnCol() {
        // weighted random gem
        const r = Math.random();
        let cum = 0,
          gem = GEMS[0];
        for (const g of GEMS) {
          cum += g.rarity;
          if (r < cum) {
            gem = g;
            break;
          }
        }
        gemsTotal++;
        collectibles.push({
          x: W + 20,
          y: GR - Math.round((40 + Math.random() * 70) * S),
          r: Math.round(11 * S),
          gem,
          collected: false,
        });
      }

      // ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ
      function spawnPtcl(x, y, col, n = 8) {
        for (let i = 0; i < n; i++)
          particles.push({
            x,
            y,
            vx: (Math.random() - 0.5) * 5 * S,
            vy: -Math.random() * 5 * S - S,
            life: 40 + Math.random() * 20,
            maxLife: 60,
            col,
            r: (3 + Math.random() * 4) * S,
          });
      }

      // ‚îÄ‚îÄ UPDATE ‚îÄ‚îÄ
      function update() {
        frame++;
        if (hitCD > 0) hitCD--;
        if (immunoTimer > 0) {
          immunoTimer--;
          if (immunoTimer === 0) sfx.hit();
        }
        if (speedBoost > 0) speedBoost--;
        recalcSpeed();

        score += Math.floor(speed * 0.07 + level * 0.03);

        // Parallax
        bgX[0] = (bgX[0] + 0.25) % (W * 2);
        bgX[1] = (bgX[1] + speed * 0.25) % (W * 1.5);
        bgX[2] = (bgX[2] + speed * 0.55) % W;
        bgX[3] = (bgX[3] + speed * 0.85) % W;

        // Punch physics
        if (P.sliding) {
          P.slideT--;
          if (P.slideT <= 0) P.sliding = false;
        }
        P.vy += 0.55 * S;
        P.y += P.vy;
        if (P.y >= GR) {
          P.y = GR;
          P.vy = 0;
          P.jumping = false;
          P.jc = 0;
        }
        P.aT++;
        if (P.aT > 7) {
          P.aT = 0;
          P.aF = (P.aF + 1) % 4;
        }

        // Spawn obstacles
        obsSpawnCD--;
        if (obsSpawnCD <= 0 && obstacles.length < 8) {
          spawnObs();
          // Gap = bigger at start of level, tighter at end
          const progress = obsBeaten / obsNeeded;
          const minGap = Math.max(35, 70 - level * 3 - progress * 20);
          const maxGap = Math.max(60, 130 - level * 4 - progress * 30);
          obsSpawnCD = minGap + Math.random() * (maxGap - minGap);
        }
        // Spawn gems
        colSpawnCD--;
        if (colSpawnCD <= 0) {
          spawnCol();
          colSpawnCD = 70 + Math.random() * 80;
        }

        // Move obstacles
        for (let i = obstacles.length - 1; i >= 0; i--) {
          const o = obstacles[i];
          o.x -= speed;
          o.animF = frame % 14 < 7 ? 0 : 1;
          // Passed check
          if (!o.passed && o.x + o.w < P.x) {
            o.passed = true;
            obsBeaten++;
            sfx.mkpass();
            score += 8 + level * 2;
            updateHUD();
            if (obsBeaten >= obsNeeded) {
              triggerLevelComplete();
              return;
            }
          }
          // Collision
          if (hitCD === 0 && immunoTimer === 0) {
            const mg = Math.round(7 * S);
            const px = P.x + mg,
              pw = P.w - mg * 2;
            const py = P.hy + mg * 0.5,
              ph = P.hh - mg;
            let ox, ow, oy, oh;
            if (o.type === "vine" || o.type === "swinger") {
              ox = o.x + mg / 2;
              ow = o.w - mg;
              oy = o.y;
              oh = Math.round(15 * S);
            } else {
              ox = o.x + mg;
              ow = o.w - mg * 2;
              oy = o.y - o.h + mg;
              oh = o.h - mg;
            }
            if (px < ox + ow && px + pw > ox && py < oy + oh && py + ph > oy) {
              takeDmg(o);
            }
          }
          if (o.x < -100) obstacles.splice(i, 1);
        }

        // Move collectibles
        for (let i = collectibles.length - 1; i >= 0; i--) {
          const c = collectibles[i];
          c.x -= speed;
          if (!c.collected) {
            const d = Math.hypot(P.x + P.w / 2 - c.x, P.hy + P.hh / 2 - c.y);
            if (d < c.r + P.w * 0.4) {
              c.collected = true;
              collectGem(c);
            }
          }
          if (c.x < -40) collectibles.splice(i, 1);
        }

        // Particles
        for (let i = particles.length - 1; i >= 0; i--) {
          const p = particles[i];
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.15 * S;
          p.life--;
          if (p.life <= 0) particles.splice(i, 1);
        }

        updateHUD();
      }

      function collectGem(c) {
        const g = c.gem;
        gemsCollected++;
        if (!gemTypes[g.id]) gemTypes[g.id] = 0;
        gemTypes[g.id]++;
        score += g.pts;
        spawnPtcl(c.x, c.y, g.color, 12);
        // Effect
        if (g.effect === "life" && lives < 5) {
          lives++;
          sfx.gem();
          showRare("‚ù§Ô∏è +1 HEART!", g.color);
        } else if (g.effect === "immuno") {
          immunoTimer = 300;
          sfx.immuno();
          showRare("üîÆ IMMUNITY! 5 SECS!", g.color);
        } else if (g.id === "star") {
          sfx.rare();
          showRare("‚≠ê LUCKY STAR! +200", g.color);
        } else if (g.id === "diamond") {
          sfx.rare();
          showRare("üí† DIAMOND! +300 (ULTRA RARE!)", g.color);
        } else if (g.id === "clover") {
          speedBoost = 120;
          sfx.rare();
          showRare("üçÄ SPEED BOOST!", g.color);
        } else if (g.rarity < 0.05) sfx.gem();
        else sfx.banana();
        updateHUD();
      }

      function showRare(txt, col) {
        const rb = document.getElementById("rare-banner");
        rb.textContent = txt;
        rb.style.borderColor = col || "#ffd166";
        rb.classList.remove("pop");
        void rb.offsetWidth;
        rb.classList.add("pop");
      }

      function takeDmg(obs) {
        lives--;
        hitCD = devMode ? 15 : 80;
        spawnPtcl(P.x + P.w / 2, P.y - P.h / 2, "#ff4d6d", 20);
        sfx.hit();
        updateHUD();
        if (lives <= 0) triggerGameOver(obs);
      }

      // ‚îÄ‚îÄ LEVEL COMPLETE ‚îÄ‚îÄ
      function triggerLevelComplete() {
        gameState = "transition";
        stopMusic();
        saveBest();
        if (level >= 10) {
          triggerWin();
          return;
        }
        sfx.lvlup();
        setTimeout(() => initLevel(level + 1), 400);
      }

      // ‚îÄ‚îÄ GAME OVER ‚îÄ‚îÄ
      function triggerGameOver(obs) {
        gameState = "over";
        stopMusic();
        saveBest();
        sfx.death();
        const f = FAILS[Math.floor(Math.random() * FAILS.length)];
        document.getElementById("fail-title").textContent = f.title;
        document.getElementById("fail-title").style.color = f.col;
        document.getElementById("fail-msg").textContent = obs
          ? `Killed by ${obs.villain.name}. ${f.msg}`
          : f.msg;
        document.getElementById("go-sc").textContent = score;
        document.getElementById("go-lv").textContent = level;
        document.getElementById("go-best").textContent = bestScore;
        document.getElementById("go-maxlv").textContent = bestLevel;
        document.getElementById("go-gems").textContent =
          `Gems collected: ${gemsCollected} of ${gemsTotal}`;
        const canCont = lives > 0;
        document.getElementById("cont-btn").style.display = canCont
          ? ""
          : "none";
        document.getElementById("continue-info").textContent = canCont
          ? `${lives} heart${lives > 1 ? "s" : ""} remaining ‚Äî continue from Level ${level}?`
          : "No hearts left. Start fresh!";
        showHUD(false);
        startMusic("end");
        showScr("scr-over");
      }

      function continueRun() {
        if (lives <= 0) {
          restartGame();
          return;
        }
        showHUD(true);
        obstacles = [];
        collectibles = [];
        obsBeaten = 0;
        hitCD = 0;
        initP();
        showLevelToast(level, () => {
          gameState = "playing";
          startMusic("game");
          cancelAnimationFrame(animID);
          loop();
        });
      }
      function restartGame() {
        cancelAnimationFrame(animID);
        startGame();
      }

      // ‚îÄ‚îÄ WIN ‚îÄ‚îÄ
      function triggerWin() {
        gameState = "won";
        stopMusic();
        saveBest();
        sfx.win();
        const elapsed = Math.round((Date.now() - startTime) / 1000);
        document.getElementById("win-sc").textContent = score;
        document.getElementById("win-time").textContent = elapsed + "s";
        document.getElementById("win-gems").textContent = gemsCollected;
        showHUD(false);
        setTimeout(() => {
          startMusic("end");
          showScr("scr-win");
          setTimeout(drawWinScene, 100);
        }, 600);
      }

      // ‚îÄ‚îÄ SHARE ‚îÄ‚îÄ
      function doShare(ctx) {
        let txt;
        if (ctx === "win") {
          txt = `üß∏ I BEAT PUNCH'S GREAT ESCAPE!\n10 levels, ${score} pts, ${gemsCollected} gems collected!\n\nThe plushie is finally back üíõ\n\nPlay: #PunchMonkey #PunchEscape\nhttps://punch-monkey.vercel.app`;
        } else {
          txt = `üêí Playing Punch's Great Escape!\nGot to Level ${level}, scored ${score} pts!\nBest level: ${bestLevel}\n\nCan you beat me? #PunchMonkey\nhttps://punch-monkey.vercel.app`;
        }
        if (navigator.share) {
          navigator
            .share({ title: "Punch's Great Escape", text: txt })
            .catch(() => {});
        } else {
          try {
            navigator.clipboard.writeText(txt);
            alert("Copied! Paste & share üêí\n\n" + txt);
          } catch (e) {
            alert(txt);
          }
        }
      }

      // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
      function drawBg() {
        const lc = LEVELS[level - 1];
        const th = BGTM[lc.bg] || BGTM.zoo;
        // Sky
        const g = cx.createLinearGradient(0, 0, 0, H);
        g.addColorStop(0, th.sky[0]);
        g.addColorStop(1, th.sky[1]);
        cx.fillStyle = g;
        cx.fillRect(0, 0, W, H);

        // Stars
        cx.fillStyle = "rgba(255,255,255,.55)";
        for (let i = 0; i < 22; i++) {
          cx.beginPath();
          cx.arc(
            (i * 137 + level * 19) % W,
            (i * 79 + 23) % (H * 0.65),
            (i % 3 === 0 ? 1.4 : 0.75) * S,
            0,
            Math.PI * 2,
          );
          cx.fill();
        }

        // Moon/sun
        if (["cave", "moon", "final"].includes(lc.bg)) {
          cx.fillStyle = "#ffd166";
          cx.shadowColor = "#ffd16666";
          cx.shadowBlur = 18 * S;
          cx.beginPath();
          cx.arc(W * 0.83, H * 0.14, 22 * S, 0, Math.PI * 2);
          cx.fill();
          cx.shadowBlur = 0;
        }

        // Level-specific atmosphere
        drawAtmo(lc.bg, th);

        // Far trees (parallax layer 1)
        cx.fillStyle = th.sky[0] + "cc";
        cx.globalAlpha = 0.65;
        for (let i = 0; i < 7; i++) {
          const tx = (((i / 7) * W * 1.3 + bgX[1] * 0.4) % (W * 1.5)) - W * 0.1;
          const th2 = H * (0.45 + (i % 3) * 0.1);
          drawTree(tx, GR, th2, lc.bg);
        }
        // Near trees (layer 2)
        cx.fillStyle = "rgba(0,0,0,.55)";
        for (let i = 0; i < 5; i++) {
          const tx = (((i / 5) * W * 1.2 + bgX[2] * 0.7) % (W * 1.3)) - W * 0.1;
          const th2 = H * (0.28 + (i % 2) * 0.08);
          drawTree(tx, GR, th2, lc.bg);
        }
        cx.globalAlpha = 1;

        // Ground
        const gg = cx.createLinearGradient(0, GR, 0, H);
        gg.addColorStop(0, th.gnd[0]);
        gg.addColorStop(1, th.gnd[1]);
        cx.fillStyle = gg;
        cx.fillRect(0, GR, W, H - GR);
        cx.strokeStyle = th.acc;
        cx.lineWidth = 2 * S;
        cx.beginPath();
        cx.moveTo(0, GR);
        cx.lineTo(W, GR);
        cx.stroke();
        // Ground marks
        cx.strokeStyle = th.acc + "44";
        cx.lineWidth = S;
        const mk = 80 * S,
          off = (frame * speed * 0.4) % mk;
        for (let x = -off; x < W; x += mk) {
          cx.beginPath();
          cx.moveTo(x, GR + 8 * S);
          cx.lineTo(x + 22 * S, GR + 8 * S);
          cx.stroke();
        }

        // Level watermark
        cx.globalAlpha = 0.05;
        cx.fillStyle = "white";
        cx.font = `bold ${28 * S}px Boogaloo`;
        cx.textAlign = "center";
        cx.fillText(lc.emoji + " " + lc.name.toUpperCase(), W / 2, H * 0.55);
        cx.globalAlpha = 1;
      }

      function drawAtmo(bg, th) {
        if (bg === "volcano" || bg === "storm") {
          cx.fillStyle = "rgba(255,50,0,.08)";
          cx.fillRect(0, 0, W, H);
        }
        if (bg === "bamboo") {
          cx.strokeStyle = "rgba(60,120,40,.2)";
          cx.lineWidth = 5 * S;
          for (let x = W * 0.05; x < W; x += W * 0.09) {
            cx.beginPath();
            cx.moveTo(x + Math.sin(bgX[0] * 0.02 + x) * 0.008 * W, 0);
            cx.lineTo(x, GR);
            cx.stroke();
          }
        }
        if (bg === "cave") {
          cx.fillStyle = "rgba(0,0,0,.3)";
          cx.fillRect(0, 0, W, H);
        }
        if (bg === "final") {
          const pg = cx.createRadialGradient(
            W * 0.5,
            GR,
            0,
            W * 0.5,
            GR,
            W * 0.45,
          );
          pg.addColorStop(0, "rgba(255,77,109,.18)");
          pg.addColorStop(1, "transparent");
          cx.fillStyle = pg;
          cx.fillRect(0, H * 0.25, W, H * 0.75);
          // Plushie silhouette hint on horizon
          cx.globalAlpha = 0.12;
          cx.fillStyle = "#ff4d6d";
          cx.beginPath();
          cx.arc(W * 0.5, GR - 60 * S, 35 * S, Math.PI, 0);
          cx.fill();
          cx.globalAlpha = 1;
        }
      }

      function drawTree(x, baseY, h, bg) {
        if (["ruins", "cave"].includes(bg)) {
          cx.fillRect(x - 8 * S, baseY - h, 16 * S, h);
          cx.fillRect(x - 14 * S, baseY - h, 28 * S, 7 * S);
        } else if (bg === "mushroom") {
          cx.fillRect(x - 4 * S, baseY - h * 0.45, 8 * S, h * 0.45);
          cx.beginPath();
          cx.arc(x, baseY - h * 0.55, h * 0.42, 0, Math.PI * 2);
          cx.fill();
          cx.fillStyle = "rgba(255,100,200,.3)";
          cx.beginPath();
          cx.arc(x, baseY - h * 0.55, h * 0.45, 0, Math.PI * 2);
          cx.fill();
        } else {
          cx.fillRect(x - 5 * S, baseY - h * 0.45, 10 * S, h * 0.45);
          cx.beginPath();
          cx.arc(x, baseY - h * 0.55, h * 0.38, 0, Math.PI * 2);
          cx.fill();
        }
      }

      // ‚îÄ‚îÄ DRAW PUNCH ‚îÄ‚îÄ
      function drawPunch() {
        const x = P.x,
          y = P.y,
          s = S;
        const bob = P.jumping ? 0 : Math.sin(frame * 0.28) * 2 * s;
        const flash = hitCD > 0 && Math.floor(hitCD / 5) % 2 === 0;
        const immGlow = immunoTimer > 0;

        cx.save();
        cx.translate(x + P.w / 2, y + bob);
        if (P.sliding) cx.scale(1, 0.55);
        if (flash) cx.globalAlpha = 0.22;

        // Immunity glow
        if (immGlow) {
          cx.shadowColor = "#c084fc";
          cx.shadowBlur = 18 * s;
        }

        // Shadow
        cx.globalAlpha = flash ? 0.05 : immGlow ? 0.5 : 0.22;
        cx.fillStyle = immGlow ? "#c084fc" : "#000";
        cx.beginPath();
        cx.ellipse(0, 3 * s, 22 * s, 7 * s, 0, 0, Math.PI * 2);
        cx.fill();
        cx.globalAlpha = flash ? 0.22 : 1;

        // Body
        cx.fillStyle = immGlow ? "#d8a0ff" : "#c47a2e";
        cx.shadowBlur = 0;
        cx.beginPath();
        cx.roundRect(-16 * s, -44 * s, 32 * s, 36 * s, 8 * s);
        cx.fill();
        // Belly
        cx.fillStyle = immGlow ? "#f0d0ff" : "#e8a96a";
        cx.beginPath();
        cx.ellipse(0, -30 * s, 10 * s, 12 * s, 0, 0, Math.PI * 2);
        cx.fill();
        // Head
        cx.fillStyle = immGlow ? "#d8a0ff" : "#c47a2e";
        cx.beginPath();
        cx.arc(0, -52 * s, 17 * s, 0, Math.PI * 2);
        cx.fill();
        // Face
        cx.fillStyle = immGlow ? "#f0d0ff" : "#e8a96a";
        cx.beginPath();
        cx.ellipse(0, -48 * s, 12 * s, 11 * s, 0, 0, Math.PI * 2);
        cx.fill();
        // Eyes
        cx.fillStyle = "#1a0a2e";
        cx.beginPath();
        cx.arc(-6 * s, -54 * s, 3.5 * s, 0, Math.PI * 2);
        cx.arc(6 * s, -54 * s, 3.5 * s, 0, Math.PI * 2);
        cx.fill();
        cx.fillStyle = "white";
        cx.beginPath();
        cx.arc(-5 * s, -55 * s, 1.2 * s, 0, Math.PI * 2);
        cx.arc(7 * s, -55 * s, 1.2 * s, 0, Math.PI * 2);
        cx.fill();
        // Smile
        cx.strokeStyle = "#1a0a2e";
        cx.lineWidth = 2 * s;
        cx.beginPath();
        cx.arc(0, -44 * s, 5 * s, 0.2, Math.PI - 0.2);
        cx.stroke();
        // Ears
        cx.fillStyle = immGlow ? "#d8a0ff" : "#c47a2e";
        cx.beginPath();
        cx.arc(-16 * s, -55 * s, 7 * s, 0, Math.PI * 2);
        cx.arc(16 * s, -55 * s, 7 * s, 0, Math.PI * 2);
        cx.fill();
        cx.fillStyle = immGlow ? "#f0d0ff" : "#e8c09a";
        cx.beginPath();
        cx.arc(-16 * s, -55 * s, 4 * s, 0, Math.PI * 2);
        cx.arc(16 * s, -55 * s, 4 * s, 0, Math.PI * 2);
        cx.fill();
        // RED PLUSHIE cradled
        cx.fillStyle = "#ff4d6d";
        cx.shadowColor = "#ff4d6d44";
        cx.shadowBlur = 8 * s;
        cx.beginPath();
        cx.arc(-20 * s, -30 * s, 10 * s, 0, Math.PI * 2);
        cx.fill();
        cx.shadowBlur = 0;
        cx.fillStyle = "#ff8fa3";
        cx.beginPath();
        cx.ellipse(-20 * s, -27 * s, 7 * s, 6 * s, 0, 0, Math.PI * 2);
        cx.fill();
        cx.fillStyle = "#ff4d6d";
        cx.beginPath();
        cx.arc(-27 * s, -38 * s, 4 * s, 0, Math.PI * 2);
        cx.arc(-14 * s, -39 * s, 4 * s, 0, Math.PI * 2);
        cx.fill();
        cx.fillStyle = "#1a0a2e";
        cx.beginPath();
        cx.arc(-22 * s, -29 * s, 1.5 * s, 0, Math.PI * 2);
        cx.arc(-17 * s, -29 * s, 1.5 * s, 0, Math.PI * 2);
        cx.fill();
        // Legs
        const leg = P.jumping ? 8 * s : Math.sin(frame * 0.38) * 13 * s;
        cx.fillStyle = immGlow ? "#d8a0ff" : "#c47a2e";
        cx.save();
        cx.translate(-7 * s, -8 * s);
        cx.rotate(leg * 0.04);
        cx.beginPath();
        cx.roundRect(-5 * s, 0, 10 * s, 14 * s, 4 * s);
        cx.fill();
        cx.fillStyle = "#9a5a1e";
        cx.beginPath();
        cx.ellipse(0, 15 * s, 8 * s, 5 * s, leg * 0.02, 0, Math.PI * 2);
        cx.fill();
        cx.restore();
        cx.fillStyle = immGlow ? "#d8a0ff" : "#c47a2e";
        cx.save();
        cx.translate(7 * s, -8 * s);
        cx.rotate(-leg * 0.04);
        cx.beginPath();
        cx.roundRect(-5 * s, 0, 10 * s, 14 * s, 4 * s);
        cx.fill();
        cx.fillStyle = "#9a5a1e";
        cx.beginPath();
        cx.ellipse(0, 15 * s, 8 * s, 5 * s, -leg * 0.02, 0, Math.PI * 2);
        cx.fill();
        cx.restore();

        cx.restore();
        cx.globalAlpha = 1;
      }

      // ‚îÄ‚îÄ DRAW VILLAINS ‚îÄ‚îÄ
      function drawVillain(o) {
        const s = S;
        cx.save();
        cx.translate(o.x + o.w / 2, 0);
        const v = o.villain;
        const bob = o.animF === 1 ? -4 * s : 0;

        // Label
        cx.fillStyle = "rgba(255,255,255,.75)";
        cx.font = `bold ${11 * s}px Boogaloo`;
        cx.textAlign = "center";

        if (o.type === "vine" || o.type === "swinger") {
          const vy = o.y;
          cx.fillStyle = "#2d7a2d";
          cx.fillRect(-o.w / 2, 0, o.w, vy);
          for (let i = 0; i < 4; i++) {
            const lx = (i % 2 === 0 ? 9 : -9) * s,
              ly = (i + 1) * (vy / 5);
            cx.fillStyle = i % 2 === 0 ? "#3da03d" : "#2d7a2d";
            cx.beginPath();
            cx.ellipse(lx, ly, 10 * s, 16 * s, 0.4, 0, Math.PI * 2);
            cx.fill();
          }
          if (o.type === "swinger") {
            // Monkey swinging
            const sy = vy - 20 * s + Math.sin(frame * 0.1) * 8 * s;
            cx.fillStyle = v.color;
            cx.beginPath();
            cx.arc(0, sy - 10 * s, 10 * s, 0, Math.PI * 2);
            cx.fill();
          }
          cx.fillStyle = "rgba(255,255,255,.8)";
          cx.fillText("DUCK!", 0, vy - 22 * s);
        } else if (o.type === "stone" || o.type === "boulder") {
          const gy = o.y;
          cx.fillStyle = "#6b7280";
          cx.beginPath();
          cx.roundRect(-o.w / 2, gy - o.h + bob, o.w, o.h, 8 * s);
          cx.fill();
          cx.fillStyle = "#9ca3af";
          cx.beginPath();
          cx.ellipse(
            -6 * s,
            gy - o.h + o.h * 0.3 + bob,
            7 * s,
            4 * s,
            -0.4,
            0,
            Math.PI * 2,
          );
          cx.fill();
          // Angry face on stone
          cx.fillStyle = "#1a0a2e";
          cx.beginPath();
          cx.arc(-5 * s, gy - o.h * 0.55 + bob, 3 * s, 0, Math.PI * 2);
          cx.arc(5 * s, gy - o.h * 0.55 + bob, 3 * s, 0, Math.PI * 2);
          cx.fill();
          cx.strokeStyle = "#1a0a2e";
          cx.lineWidth = 2 * s;
          cx.beginPath();
          cx.arc(0, gy - o.h * 0.35 + bob, 5 * s, 0, Math.PI);
          cx.stroke();
          cx.fillStyle = "rgba(255,255,255,.8)";
          cx.fillText("JUMP!", 0, gy - o.h - 12 * s + bob);
        } else if (o.type === "peel") {
          const gy = o.y;
          cx.fillStyle = "#fdd835";
          cx.beginPath();
          cx.ellipse(0, gy - 5 * s, 18 * s, 7 * s, 0.3, 0, Math.PI * 2);
          cx.fill();
          cx.strokeStyle = "#e6b800";
          cx.lineWidth = 2 * s;
          [-1, 0, 1].forEach((d) => {
            cx.beginPath();
            cx.moveTo(d * 8 * s, gy - 5 * s);
            cx.quadraticCurveTo(
              d * 15 * s,
              gy - 22 * s,
              d * 6 * s,
              gy - 26 * s,
            );
            cx.stroke();
          });
          cx.fillStyle = "rgba(255,255,255,.8)";
          cx.fillText("üçå", 0, gy - 30 * s);
        } else if (o.type === "spike") {
          const gy = o.y;
          for (let i = -1; i <= 1; i++) {
            cx.fillStyle = v.color;
            cx.beginPath();
            cx.moveTo(i * 16 * s + (o.w / 2) * i * 0.3, gy);
            cx.lineTo(i * 16 * s - 6 * s + (o.w / 2) * i * 0.3, gy - o.h);
            cx.lineTo(i * 16 * s + 6 * s + (o.w / 2) * i * 0.3, gy - o.h);
            cx.fill();
          }
          cx.fillStyle = "rgba(255,255,255,.8)";
          cx.fillText("HIGH!", 0, gy - o.h - 14 * s);
        } else {
          // Default: monkey figure
          const gy = o.y;
          const isSlider = o.type === "slider";
          const isBig = o.type === "bigbobo";
          const scale = isBig ? 1.35 : 1;

          cx.save();
          if (isSlider) {
            cx.scale(1, 0.7);
            cx.translate(0, -5 * s);
          }

          cx.fillStyle = v.color;
          // Body
          cx.beginPath();
          cx.roundRect(
            (-o.w / 2) * scale,
            gy - o.h * scale + bob,
            o.w * scale,
            o.h * 0.65 * scale,
            7 * s,
          );
          cx.fill();
          // Head
          const hx = isSlider ? (-o.w / 2) * scale + 13 * s : 0;
          const hy2 = gy - o.h * scale - 8 * s + bob;
          cx.beginPath();
          cx.arc(hx, hy2, (isBig ? 18 : 14) * s * scale, 0, Math.PI * 2);
          cx.fill();
          // Face
          cx.fillStyle = "rgba(255,255,255,.4)";
          cx.beginPath();
          cx.ellipse(
            hx,
            hy2 + 4 * s * scale,
            10 * s * scale,
            9 * s * scale,
            0,
            0,
            Math.PI * 2,
          );
          cx.fill();
          // Angry eyes
          cx.fillStyle = "white";
          cx.beginPath();
          cx.arc(
            hx - 5 * s * scale,
            hy2 - 2 * s * scale,
            4 * s * scale,
            0,
            Math.PI * 2,
          );
          cx.arc(
            hx + 5 * s * scale,
            hy2 - 2 * s * scale,
            4 * s * scale,
            0,
            Math.PI * 2,
          );
          cx.fill();
          cx.fillStyle = "#1a0a2e";
          cx.beginPath();
          cx.arc(
            hx - 4 * s * scale,
            hy2 - 1 * s * scale,
            2.5 * s * scale,
            0,
            Math.PI * 2,
          );
          cx.arc(
            hx + 6 * s * scale,
            hy2 - 1 * s * scale,
            2.5 * s * scale,
            0,
            Math.PI * 2,
          );
          cx.fill();
          // Angry brows
          cx.strokeStyle = "#1a0a2e";
          cx.lineWidth = 2.5 * s * scale;
          cx.beginPath();
          cx.moveTo(hx - 9 * s * scale, hy2 - 8 * s * scale);
          cx.lineTo(hx - 1 * s * scale, hy2 - 5 * s * scale);
          cx.moveTo(hx + 1 * s * scale, hy2 - 8 * s * scale);
          cx.lineTo(hx + 9 * s * scale, hy2 - 5 * s * scale);
          cx.stroke();
          // Name tag
          cx.fillStyle = "rgba(0,0,0,.6)";
          cx.beginPath();
          cx.roundRect(
            hx - v.name.length * 3.5 * s * scale - 2,
            hy2 - o.h * 0.6 * scale + bob,
            v.name.length * 7 * s * scale + 4,
            14 * s * scale,
            4 * s,
          );
          cx.fill();
          cx.fillStyle = "rgba(255,255,255,.9)";
          cx.font = `bold ${10 * s * scale}px Boogaloo`;
          cx.textAlign = "center";
          cx.fillText(v.name, hx, hy2 - o.h * 0.45 * scale + bob);

          cx.fillStyle = "rgba(255,255,255,.8)";
          cx.font = `bold ${11 * s}px Boogaloo`;
          cx.fillText(
            v.action === "HIGH" ? "HIGH JUMP!" : v.action + "!",
            isSlider ? 0 : 0,
            gy - o.h * scale - 32 * s + bob,
          );

          cx.restore();
        }

        cx.restore();
      }

      // ‚îÄ‚îÄ DRAW GEMS ‚îÄ‚îÄ
      function drawGems() {
        for (const c of collectibles) {
          if (c.collected) continue;
          const bob = Math.sin(frame * 0.12 + c.x * 0.015) * 4 * S;
          cx.save();
          cx.translate(c.x, c.y + bob);
          if (c.gem.rarity < 0.05) {
            cx.shadowColor = c.gem.color;
            cx.shadowBlur = 14 * S;
          }
          cx.fillStyle = c.gem.color;
          cx.beginPath();
          cx.arc(0, 0, c.r, 0, Math.PI * 2);
          cx.fill();
          cx.shadowBlur = 0;
          cx.font = `${c.r * 2}px serif`;
          cx.textAlign = "center";
          cx.textBaseline = "middle";
          cx.fillText(c.gem.emoji, 0, 1);
          cx.restore();
        }
      }

      // ‚îÄ‚îÄ DRAW PARTICLES ‚îÄ‚îÄ
      function drawPtcl() {
        for (const p of particles) {
          cx.globalAlpha = p.life / p.maxLife;
          cx.fillStyle = p.col;
          cx.beginPath();
          cx.arc(p.x, p.y, p.r * (p.life / p.maxLife), 0, Math.PI * 2);
          cx.fill();
        }
        cx.globalAlpha = 1;
      }

      // ‚îÄ‚îÄ TITLE ART (Punch hugging plushie from behind, emotional) ‚îÄ‚îÄ
      function drawTitleArt() {
        const tc = document.getElementById("title-canvas");
        if (!tc) return;
        const sz = Math.round(
          Math.min(window.innerWidth * 0.2, 148, window.innerHeight * 0.22),
        );
        tc.width = sz;
        tc.height = sz;
        const tx = tc.getContext("2d");
        const s = sz / 140;
        tx.clearRect(0, 0, sz, sz);

        // Background glow
        const glow = tx.createRadialGradient(
          sz * 0.5,
          sz * 0.65,
          0,
          sz * 0.5,
          sz * 0.65,
          sz * 0.55,
        );
        glow.addColorStop(0, "rgba(255,100,53,.18)");
        glow.addColorStop(1, "transparent");
        tx.fillStyle = glow;
        tx.fillRect(0, 0, sz, sz);

        // Subtle ground
        tx.fillStyle = "rgba(45,27,105,.4)";
        tx.fillRect(0, sz * 0.85, sz, sz * 0.15);

        tx.save();
        tx.translate(sz * 0.5, sz * 0.78);

        // PLUSHIE ‚Äî large, warm, in front, facing slightly toward viewer
        tx.save();
        tx.rotate(-0.15);
        // Shadow under plushie
        tx.fillStyle = "rgba(0,0,0,.35)";
        tx.beginPath();
        tx.ellipse(0, 4 * s, 26 * s, 9 * s, 0, 0, Math.PI * 2);
        tx.fill();
        // Body
        tx.fillStyle = "#ff4d6d";
        tx.shadowColor = "#ff4d6d";
        tx.shadowBlur = 16 * s;
        tx.beginPath();
        tx.arc(0, 0, 28 * s, 0, Math.PI * 2);
        tx.fill();
        tx.shadowBlur = 0;
        // Face glow
        tx.fillStyle = "#ff8fa3";
        tx.beginPath();
        tx.ellipse(0, 4 * s, 20 * s, 18 * s, 0, 0, Math.PI * 2);
        tx.fill();
        // Closed happy eyes
        tx.strokeStyle = "#1a0a2e";
        tx.lineWidth = 2.5 * s;
        tx.beginPath();
        tx.arc(-8 * s, -5 * s, 5 * s, Math.PI * 0.1, Math.PI * 0.9);
        tx.stroke();
        tx.beginPath();
        tx.arc(8 * s, -5 * s, 5 * s, Math.PI * 0.1, Math.PI * 0.9);
        tx.stroke();
        // Blush
        tx.fillStyle = "rgba(255,100,120,.45)";
        tx.beginPath();
        tx.ellipse(-13 * s, 3 * s, 6 * s, 4 * s, 0, 0, Math.PI * 2);
        tx.ellipse(13 * s, 3 * s, 6 * s, 4 * s, 0, 0, Math.PI * 2);
        tx.fill();
        // Ears
        tx.fillStyle = "#ff4d6d";
        tx.beginPath();
        tx.arc(-22 * s, -20 * s, 8 * s, 0, Math.PI * 2);
        tx.arc(22 * s, -20 * s, 8 * s, 0, Math.PI * 2);
        tx.fill();
        tx.fillStyle = "#ff8fa3";
        tx.beginPath();
        tx.arc(-22 * s, -20 * s, 5 * s, 0, Math.PI * 2);
        tx.arc(22 * s, -20 * s, 5 * s, 0, Math.PI * 2);
        tx.fill();
        tx.restore();

        // PUNCH ‚Äî behind, arms wrapped around, peeking with big hopeful eyes
        tx.save();
        tx.translate(3 * s, -16 * s);
        // Left arm around
        tx.fillStyle = "#b36a25";
        tx.save();
        tx.rotate(0.55);
        tx.beginPath();
        tx.roundRect(-8 * s, 10 * s, 15 * s, 30 * s, 7 * s);
        tx.fill();
        tx.restore();
        // Right arm around
        tx.save();
        tx.rotate(-0.4);
        tx.beginPath();
        tx.roundRect(-7 * s, 10 * s, 15 * s, 28 * s, 7 * s);
        tx.fill();
        tx.restore();
        // Body (partially behind)
        tx.fillStyle = "#b36a25";
        tx.beginPath();
        tx.roundRect(-14 * s, 0, 28 * s, 30 * s, 8 * s);
        tx.fill();
        // Head peeking
        tx.fillStyle = "#c47a2e";
        tx.beginPath();
        tx.arc(1 * s, -16 * s, 18 * s, 0, Math.PI * 2);
        tx.fill();
        tx.fillStyle = "#e8a96a";
        tx.beginPath();
        tx.ellipse(1 * s, -12 * s, 13 * s, 12 * s, 0, 0, Math.PI * 2);
        tx.fill();
        // BIG hopeful eyes looking forward/slightly up
        tx.fillStyle = "#1a0a2e";
        tx.beginPath();
        tx.arc(-6 * s, -18 * s, 5 * s, 0, Math.PI * 2);
        tx.arc(8 * s, -18 * s, 5 * s, 0, Math.PI * 2);
        tx.fill();
        tx.fillStyle = "white";
        tx.beginPath();
        tx.arc(-5 * s, -19 * s, 2 * s, 0, Math.PI * 2);
        tx.arc(9 * s, -19 * s, 2 * s, 0, Math.PI * 2);
        tx.fill();
        // Extra shine
        tx.fillStyle = "rgba(255,255,255,.6)";
        tx.beginPath();
        tx.arc(-4 * s, -20 * s, 0.8 * s, 0, Math.PI * 2);
        tx.arc(10 * s, -20 * s, 0.8 * s, 0, Math.PI * 2);
        tx.fill();
        // Slight smile, content
        tx.strokeStyle = "#1a0a2e";
        tx.lineWidth = 2.5 * s;
        tx.beginPath();
        tx.arc(1 * s, -8 * s, 6 * s, 0.1, Math.PI - 0.1);
        tx.stroke();
        // Blush on Punch
        tx.fillStyle = "rgba(220,110,50,.45)";
        tx.beginPath();
        tx.ellipse(-10 * s, -13 * s, 5 * s, 3 * s, 0, 0, Math.PI * 2);
        tx.ellipse(12 * s, -13 * s, 5 * s, 3 * s, 0, 0, Math.PI * 2);
        tx.fill();
        // Ears
        tx.fillStyle = "#c47a2e";
        tx.beginPath();
        tx.arc(-17 * s, -20 * s, 7 * s, 0, Math.PI * 2);
        tx.arc(19 * s, -20 * s, 7 * s, 0, Math.PI * 2);
        tx.fill();
        tx.fillStyle = "#e8c09a";
        tx.beginPath();
        tx.arc(-17 * s, -20 * s, 4 * s, 0, Math.PI * 2);
        tx.arc(19 * s, -20 * s, 4 * s, 0, Math.PI * 2);
        tx.fill();
        // Floating hearts
        tx.font = `${10 * s}px serif`;
        tx.textAlign = "center";
        tx.globalAlpha = 0.85;
        tx.fillText("üíõ", -26 * s, -34 * s);
        tx.fillText("‚ù§Ô∏è", 24 * s, -30 * s);
        tx.fillText("‚ú®", 30 * s, -44 * s);
        tx.globalAlpha = 1;
        tx.restore();
        tx.restore();
      }

      // ‚îÄ‚îÄ TITLE BG ‚îÄ‚îÄ
      function drawTitleScene() {
        if (!W) return;
        cx.clearRect(0, 0, W, H);
        const g = cx.createLinearGradient(0, 0, 0, H);
        g.addColorStop(0, "#0d0420");
        g.addColorStop(1, "#1a0a2e");
        cx.fillStyle = g;
        cx.fillRect(0, 0, W, H);
        cx.fillStyle = "rgba(255,255,255,.45)";
        for (let i = 0; i < 25; i++) {
          cx.beginPath();
          cx.arc(
            (i * 137) % W,
            (i * 79 + 23) % (H * 0.7),
            (i % 3 === 0 ? 1.5 : 0.8) * S,
            0,
            Math.PI * 2,
          );
          cx.fill();
        }
        cx.fillStyle = "#ffd166";
        cx.shadowColor = "#ffd16655";
        cx.shadowBlur = 16 * S;
        cx.beginPath();
        cx.arc(W * 0.83, H * 0.15, 22 * S, 0, Math.PI * 2);
        cx.fill();
        cx.shadowBlur = 0;
      }

      // ‚îÄ‚îÄ WIN SCENE (animated sleeping) ‚îÄ‚îÄ
      let winF = 0,
        winAnim;
      function drawWinScene() {
        const wc = document.getElementById("win-canvas");
        if (!wc) return;
        const w = wc.width,
          h = wc.height;
        const wx = wc.getContext("2d");

        function drawFrame() {
          winF++;
          wx.clearRect(0, 0, w, h);
          // Night sky
          const bg = wx.createLinearGradient(0, 0, 0, h);
          bg.addColorStop(0, "#05020f");
          bg.addColorStop(1, "#1a0a2e");
          wx.fillStyle = bg;
          wx.fillRect(0, 0, w, h);
          // Stars twinkling
          for (let i = 0; i < 20; i++) {
            const sx = (i * 97) % w,
              sy = (i * 53) % (h * 0.55);
            const twink = 0.4 + 0.6 * Math.abs(Math.sin(winF * 0.05 + i * 1.3));
            wx.globalAlpha = twink;
            wx.fillStyle = "white";
            wx.beginPath();
            wx.arc(sx, sy, 1.2, 0, Math.PI * 2);
            wx.fill();
          }
          wx.globalAlpha = 1;
          // Moon
          wx.fillStyle = "#ffd166";
          wx.shadowColor = "#ffd16666";
          wx.shadowBlur = 12;
          wx.beginPath();
          wx.arc(w * 0.82, h * 0.18, 16, 0, Math.PI * 2);
          wx.fill();
          wx.shadowBlur = 0;
          // Ground
          wx.fillStyle = "#1a0a3e";
          wx.fillRect(0, h * 0.68, w, h * 0.32);
          wx.strokeStyle = "#2d1b69";
          wx.lineWidth = 2;
          wx.beginPath();
          wx.moveTo(0, h * 0.68);
          wx.lineTo(w, h * 0.68);
          wx.stroke();
          // Rocks
          wx.fillStyle = "#2a2240";
          wx.beginPath();
          wx.ellipse(w * 0.25, h * 0.68, 30, 18, -0.2, 0, Math.PI * 2);
          wx.fill();
          wx.beginPath();
          wx.ellipse(w * 0.75, h * 0.68, 22, 14, 0.1, 0, Math.PI * 2);
          wx.fill();
          // Wind particles (blowing grass)
          wx.strokeStyle = "rgba(100,200,120,.3)";
          wx.lineWidth = 1.5;
          for (let i = 0; i < 8; i++) {
            const gx = i * (w / 8) + 20,
              gy = h * 0.68;
            const sway = Math.sin(winF * 0.04 + i * 0.8) * 6;
            wx.beginPath();
            wx.moveTo(gx, gy);
            wx.quadraticCurveTo(gx + sway, gy - 12, gx + sway * 1.5, gy - 20);
            wx.stroke();
          }

          const cx2 = w * 0.5,
            cy2 = h * 0.72;
          const breathe = Math.sin(winF * 0.06) * 0.5; // gentle breathing

          // Mother shadow underneath (silhouette, abstract)
          wx.fillStyle = "rgba(45,20,80,.65)";
          wx.beginPath();
          wx.ellipse(cx2, cy2 + 12, 52, 20, 0, 0, Math.PI * 2);
          wx.fill();
          // Mother arms silhouette
          wx.fillStyle = "rgba(35,15,65,.7)";
          wx.beginPath();
          wx.ellipse(cx2 - 22, cy2 + 2, 18, 28, -0.3, 0, Math.PI * 2);
          wx.fill();
          wx.beginPath();
          wx.ellipse(cx2 + 22, cy2 + 2, 18, 28, 0.3, 0, Math.PI * 2);
          wx.fill();

          // Plushie ‚Äî warm glowing
          wx.save();
          wx.translate(cx2 - 18, cy2 - 22 + breathe * 0.5);
          wx.fillStyle = "#ff4d6d";
          wx.shadowColor = "#ff4d6d66";
          wx.shadowBlur = 10;
          wx.beginPath();
          wx.arc(0, 0, 16, 0, Math.PI * 2);
          wx.fill();
          wx.shadowBlur = 0;
          wx.fillStyle = "#ff8fa3";
          wx.beginPath();
          wx.ellipse(0, 4, 12, 10, 0, 0, Math.PI * 2);
          wx.fill();
          wx.fillStyle = "#ff4d6d";
          wx.beginPath();
          wx.arc(-12, -12, 5, 0, Math.PI * 2);
          wx.arc(6, -13, 5, 0, Math.PI * 2);
          wx.fill();
          wx.restore();

          // FUR blowing (small dots around plushie)
          for (let i = 0; i < 6; i++) {
            const angle = winF * 0.02 + i * ((Math.PI * 2) / 6);
            const dist = 20 + Math.sin(winF * 0.08 + i) * 4;
            const fx = cx2 - 18 + Math.cos(angle) * dist,
              fy = cy2 - 22 + Math.sin(angle) * dist;
            wx.globalAlpha = 0.15 + 0.1 * Math.sin(winF * 0.06 + i);
            wx.fillStyle = "#ff8fa3";
            wx.beginPath();
            wx.arc(fx, fy, 2, 0, Math.PI * 2);
            wx.fill();
          }
          wx.globalAlpha = 1;

          // Punch sleeping, curled around plushie
          wx.save();
          wx.translate(cx2 + 4, cy2 - 24 + breathe);
          // Body (curled)
          wx.fillStyle = "#c47a2e";
          wx.beginPath();
          wx.roundRect(-10, -18, 28, 24, 10);
          wx.fill();
          // Head
          wx.beginPath();
          wx.arc(22, -18, 16, 0, Math.PI * 2);
          wx.fill();
          wx.fillStyle = "#e8a96a";
          wx.beginPath();
          wx.ellipse(22, -14, 11, 10, 0, 0, Math.PI * 2);
          wx.fill();
          // Closed sleeping eyes
          wx.strokeStyle = "#1a0a2e";
          wx.lineWidth = 2;
          wx.beginPath();
          wx.arc(16, -20, 4, Math.PI * 0.1, Math.PI * 0.9);
          wx.stroke();
          wx.beginPath();
          wx.arc(28, -20, 4, Math.PI * 0.1, Math.PI * 0.9);
          wx.stroke();
          // Tiny smile
          wx.beginPath();
          wx.arc(22, -13, 3, 0.2, Math.PI - 0.2);
          wx.stroke();
          // Ears
          wx.fillStyle = "#c47a2e";
          wx.beginPath();
          wx.arc(8, -24, 6, 0, Math.PI * 2);
          wx.arc(36, -24, 6, 0, Math.PI * 2);
          wx.fill();
          // zzz floating
          wx.fillStyle = "#ffd166";
          wx.font = "bold 11px Boogaloo";
          wx.textAlign = "left";
          const zOff = Math.sin(winF * 0.04) * 4;
          wx.globalAlpha = 0.7 + 0.3 * Math.sin(winF * 0.06);
          wx.fillText("z", 40, -28 + zOff);
          wx.fillText("z", 47, -20 + zOff * 0.7);
          wx.fillText("z", 52, -35 + zOff * 0.5);
          wx.globalAlpha = 1;
          wx.restore();

          // Wind sound visual (wavy lines)
          wx.strokeStyle = "rgba(150,200,255,.08)";
          wx.lineWidth = 1.5;
          for (let i = 0; i < 3; i++) {
            const wy = h * 0.3 + i * 8;
            const wph = winF * 0.03 + i * 1.2;
            wx.beginPath();
            wx.moveTo(0, wy);
            for (let x = 0; x < w; x += 10)
              wx.lineTo(x, wy + Math.sin(x * 0.04 + wph) * 3);
            wx.stroke();
          }

          if (gameState === "won") winAnim = requestAnimationFrame(drawFrame);
        }
        drawFrame();
      }

      // ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ
      function render() {
        cx.clearRect(0, 0, W, H);
        drawBg();
        drawGems();
        for (const o of obstacles) drawVillain(o);
        drawPunch();
        drawPtcl();
      }

      function loop() {
        if (gameState !== "playing") {
          cancelAnimationFrame(animID);
          return;
        }
        update();
        render();
        animID = requestAnimationFrame(loop);
      }

      // ‚îÄ‚îÄ TITLE IDLE ANIMATION ‚îÄ‚îÄ
      let titleAnim;
      function animateTitle() {
        if (
          gameState !== "idle" &&
          gameState !== "howtoplay" &&
          gameState !== "about"
        ) {
          cancelAnimationFrame(titleAnim);
          return;
        }
        drawTitleScene();
        titleAnim = requestAnimationFrame(animateTitle);
      }

      // ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ
      resize();
      drawTitleArt();
      drawTitleScene();
      startMusic("title");

      // Start idle canvas animation
      gameState = "idle";
      animateTitle();
    </script>
  </body>
</html>
