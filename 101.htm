<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PUNCH'S GREAT ESCAPE üêí</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Boogaloo&family=Nunito:wght@400;700;900&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #1a0a2e;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        overflow: hidden;
        font-family: "Boogaloo", cursive;
      }

      #game-wrapper {
        position: relative;
        width: 800px;
      }

      #title-screen {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 100;
        background: #1a0a2e;
        border-radius: 16px;
      }

      #title-screen h1 {
        font-size: 64px;
        color: #ff6b35;
        text-shadow:
          4px 4px 0 #c23b0a,
          0 0 40px #ff6b3566;
        line-height: 1;
        text-align: center;
      }

      #title-screen .subtitle {
        font-size: 22px;
        color: #ffd166;
        margin: 12px 0 32px;
        letter-spacing: 2px;
      }

      .story-text {
        font-size: 16px;
        color: #ccc;
        font-family: "Nunito", sans-serif;
        text-align: center;
        max-width: 500px;
        line-height: 1.6;
        margin-bottom: 28px;
        opacity: 0.85;
      }

      #start-btn {
        background: #ff6b35;
        color: white;
        border: none;
        padding: 16px 48px;
        font-size: 28px;
        font-family: "Boogaloo", cursive;
        border-radius: 50px;
        cursor: pointer;
        box-shadow:
          0 6px 0 #c23b0a,
          0 0 30px #ff6b3566;
        transition:
          transform 0.1s,
          box-shadow 0.1s;
        letter-spacing: 1px;
      }

      #start-btn:hover {
        transform: translateY(-3px);
        box-shadow:
          0 9px 0 #c23b0a,
          0 0 40px #ff6b35aa;
      }
      #start-btn:active {
        transform: translateY(3px);
        box-shadow: 0 3px 0 #c23b0a;
      }

      #hud {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 16px;
        color: white;
        font-size: 22px;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 12px 12px 0 0;
      }

      #hud .hearts span {
        font-size: 20px;
      }
      #score-display {
        color: #ffd166;
      }
      #progress-bar-wrap {
        width: 200px;
        height: 12px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 6px;
        overflow: hidden;
      }
      #progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #06d6a0, #ffd166);
        border-radius: 6px;
        transition: width 0.3s;
        width: 0%;
      }

      #canvas {
        display: block;
        border-radius: 0 0 12px 12px;
      }

      #controls-hint {
        color: rgba(255, 255, 255, 0.4);
        font-size: 14px;
        font-family: "Nunito", sans-serif;
        margin-top: 10px;
        text-align: center;
      }

      #game-over-screen,
      #win-screen {
        position: absolute;
        inset: 0;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 50;
        background: rgba(15, 5, 30, 0.92);
        border-radius: 16px;
      }

      #game-over-screen h2 {
        font-size: 52px;
        color: #ff4d6d;
        text-shadow: 3px 3px 0 #7b0020;
      }
      #win-screen h2 {
        font-size: 48px;
        color: #06d6a0;
        text-shadow: 3px 3px 0 #02705a;
      }

      .end-score {
        font-size: 28px;
        color: #ffd166;
        margin: 12px 0 24px;
      }

      .restart-btn {
        background: #06d6a0;
        color: #1a0a2e;
        border: none;
        padding: 14px 40px;
        font-size: 24px;
        font-family: "Boogaloo", cursive;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0 5px 0 #028a66;
        transition: transform 0.1s;
      }

      .restart-btn:hover {
        transform: translateY(-2px);
      }
      .restart-btn:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 #028a66;
      }

      .win-msg {
        font-size: 20px;
        color: #fff;
        font-family: "Nunito", sans-serif;
        text-align: center;
        max-width: 420px;
        line-height: 1.6;
        margin: 10px 0 20px;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div id="game-wrapper">
      <div id="title-screen">
        <h1>üêí PUNCH'S<br />GREAT ESCAPE</h1>
        <p class="subtitle">üß∏ PROTECT THE PLUSHIE üß∏</p>
        <p class="story-text">
          Punch just YOINKED the red plushie from the monkey gang.<br />
          Now they're coming for him. RUN, Punch. <strong>RUN.</strong><br />
          Get to your mom and she'll keep you safe. üíõ
        </p>
        <button id="start-btn" onclick="startGame()">DAAAAAVAI! üöÄ</button>
      </div>

      <div id="game-over-screen">
        <h2>üíÄ GOT CAUGHT</h2>
        <p class="end-score" id="go-score">Score: 0</p>
        <p
          style="
            color: #ccc;
            font-family: Nunito, sans-serif;
            font-size: 16px;
            margin-bottom: 20px;
          "
        >
          The monkeys took the plushie back... for now.
        </p>
        <button class="restart-btn" onclick="restartGame()">
          TRY AGAIN üêí
        </button>
      </div>

      <div id="win-screen">
        <h2>üéâ SAFE AT LAST!</h2>
        <p class="win-msg">
          Punch made it to his mama! She tucked him in and he fell asleep
          cuddling his little red plushie. üß∏üí§<br /><br />The monkey gang never
          bothered him again.
        </p>
        <p class="end-score" id="win-score">Score: 0</p>
        <button class="restart-btn" onclick="restartGame()">
          PLAY AGAIN üåô
        </button>
      </div>

      <div id="hud">
        <div class="hearts" id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div id="score-display">0 pts</div>
        <div id="progress-bar-wrap"><div id="progress-bar"></div></div>
      </div>
      <canvas id="canvas" width="800" height="300"></canvas>
      <p id="controls-hint">
        SPACE / ‚Üë = Jump &nbsp;|&nbsp; ‚Üì = Slide &nbsp;|&nbsp; Double jump
        supported!
      </p>
    </div>

    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      const W = canvas.width;
      const H = canvas.height;
      const GROUND = H - 60;

      // === GAME STATE ===
      let state = "idle"; // idle | playing | over | win
      let score = 0;
      let distance = 0;
      let winDistance = 4000;
      let lives = 3;
      let speed = 5;
      let frame = 0;
      let hitCooldown = 0;
      let particles = [];

      // === BG LAYERS ===
      let bgLayers = [
        { x: 0, speed: 0.5, color: "#2d1b69", stars: generateStars(30) },
        { x: 0, speed: 1.5, trees: generateTrees(8, 160, 220) },
        { x: 0, speed: 2.5, trees: generateTrees(6, 80, 130) },
      ];

      function generateStars(n) {
        let s = [];
        for (let i = 0; i < n; i++)
          s.push({
            x: Math.random() * W,
            y: Math.random() * H * 0.6,
            r: Math.random() * 2 + 0.5,
          });
        return s;
      }

      function generateTrees(n, minH, maxH) {
        let t = [];
        for (let i = 0; i < n; i++) {
          t.push({
            x: (W / n) * i + Math.random() * 80,
            h: minH + Math.random() * (maxH - minH),
          });
        }
        return t;
      }

      // === PUNCH ===
      let punch = {
        x: 120,
        y: GROUND,
        w: 44,
        h: 50,
        vy: 0,
        jumping: false,
        jumpCount: 0,
        sliding: false,
        slideTimer: 0,
        animFrame: 0,
        animTimer: 0,
        get top() {
          return this.y - (this.sliding ? this.h * 0.5 : this.h);
        },
        get bottom() {
          return this.y;
        },
        get right() {
          return this.x + this.w;
        },
        get hitH() {
          return this.sliding ? this.h * 0.5 : this.h;
        },
        get hitY() {
          return this.y - this.hitH;
        },
      };

      // === OBSTACLES ===
      let obstacles = [];
      let obsCooldown = 80;

      // === COLLECTIBLES (bananas) ===
      let collectibles = [];
      let colCooldown = 120;

      // === INPUT ===
      const keys = {};
      document.addEventListener("keydown", (e) => {
        if (keys[e.code]) return;
        keys[e.code] = true;

        if (state !== "playing") return;

        if (e.code === "Space" || e.code === "ArrowUp") {
          e.preventDefault();
          doJump();
        }
        if (e.code === "ArrowDown") {
          e.preventDefault();
          doSlide();
        }
      });
      document.addEventListener("keyup", (e) => {
        keys[e.code] = false;
        if (e.code === "ArrowDown" && punch.sliding) {
          punch.sliding = false;
          punch.slideTimer = 0;
        }
      });

      // Touch controls
      canvas.addEventListener("touchstart", (e) => {
        e.preventDefault();
        const t = e.touches[0];
        if (t.clientY < canvas.getBoundingClientRect().top + H * 0.5) doJump();
        else doSlide();
      });
      canvas.addEventListener("touchend", (e) => {
        e.preventDefault();
        punch.sliding = false;
      });

      function doJump() {
        if (punch.jumpCount < 2) {
          punch.vy = punch.jumpCount === 0 ? -14 : -11;
          punch.jumping = true;
          punch.jumpCount++;
          punch.sliding = false;
          spawnParticles(punch.x + punch.w / 2, punch.y, "#ffd166", 5);
        }
      }

      function doSlide() {
        if (!punch.jumping) {
          punch.sliding = true;
          punch.slideTimer = 40;
        }
      }

      // === OBSTACLE TYPES ===
      // type: 'slider' (low, duck it) | 'jumper' (mid, jump it) | 'thrower' (high, slide under?)
      function spawnObstacle() {
        let r = Math.random();
        let type, y, w, h, color;

        if (r < 0.4) {
          // Slider: runs low, you must jump
          type = "slider";
          h = 30;
          w = 48;
          y = GROUND;
          color = "#ef476f";
        } else if (r < 0.75) {
          // Jumper: leaps at mid height, jump over
          type = "jumper";
          h = 44;
          w = 44;
          y = GROUND;
          color = "#ff9f1c";
        } else {
          // Vine: low hanging, you must slide
          type = "vine";
          h = 60;
          w = 18;
          y = GROUND - 80;
          color = "#06d6a0";
        }

        obstacles.push({ type, x: W + 20, y, w, h, color, animFrame: 0 });
      }

      function spawnCollectible() {
        collectibles.push({
          x: W + 20,
          y: GROUND - 60 - Math.random() * 50,
          r: 10,
          collected: false,
        });
      }

      // === PARTICLES ===
      function spawnParticles(x, y, color, n = 8) {
        for (let i = 0; i < n; i++) {
          particles.push({
            x,
            y,
            vx: (Math.random() - 0.5) * 5,
            vy: -Math.random() * 5 - 1,
            life: 40 + Math.random() * 20,
            maxLife: 60,
            color,
            r: 3 + Math.random() * 4,
          });
        }
      }

      // === UPDATE ===
      function update() {
        frame++;
        distance += speed;
        score += Math.floor(speed * 0.1);
        speed = 5 + Math.min(distance / 800, 7);

        if (hitCooldown > 0) hitCooldown--;

        // Progress
        let prog = Math.min(distance / winDistance, 1);
        document.getElementById("progress-bar").style.width = prog * 100 + "%";

        // Win condition
        if (distance >= winDistance) {
          triggerWin();
          return;
        }

        // BG parallax
        for (let l of bgLayers) {
          l.x -= l.speed;
          if (l.trees) {
            for (let t of l.trees) {
              t.x -= l.speed;
              if (t.x < -50) t.x = W + 50;
            }
          }
        }

        // Punch physics
        if (punch.sliding) {
          punch.slideTimer--;
          if (punch.slideTimer <= 0) punch.sliding = false;
        }

        punch.vy += 0.7;
        punch.y += punch.vy;

        if (punch.y >= GROUND) {
          punch.y = GROUND;
          punch.vy = 0;
          punch.jumping = false;
          punch.jumpCount = 0;
        }

        // Punch animation
        punch.animTimer++;
        if (punch.animTimer > 8) {
          punch.animTimer = 0;
          punch.animFrame = (punch.animFrame + 1) % 4;
        }

        // Spawn obstacles
        obsCooldown--;
        if (obsCooldown <= 0) {
          spawnObstacle();
          obsCooldown = 50 + Math.random() * 80;
        }

        // Spawn collectibles
        colCooldown--;
        if (colCooldown <= 0) {
          spawnCollectible();
          colCooldown = 80 + Math.random() * 80;
        }

        // Move obstacles
        for (let i = obstacles.length - 1; i >= 0; i--) {
          let o = obstacles[i];
          o.x -= speed;
          o.animFrame = frame % 16 < 8 ? 0 : 1;

          // Collision
          if (hitCooldown === 0) {
            let px = punch.x + 8,
              pw = punch.w - 16;
            let py = punch.hitY + 6,
              ph = punch.hitH - 10;

            let ox = o.x + 6,
              ow = o.w - 12;
            let oy = o.type === "vine" ? o.y : o.y - o.h + 6,
              oh = o.h - 10;

            if (px < ox + ow && px + pw > ox && py < oy + oh && py + ph > oy) {
              takeDamage();
            }
          }

          if (o.x < -80) obstacles.splice(i, 1);
        }

        // Move collectibles
        for (let i = collectibles.length - 1; i >= 0; i--) {
          let c = collectibles[i];
          c.x -= speed;
          if (!c.collected) {
            let px = punch.x + 8,
              pw = punch.w - 16;
            let py = punch.hitY,
              ph = punch.hitH;
            if (
              px < c.x + c.r &&
              px + pw > c.x - c.r &&
              py < c.y + c.r &&
              py + ph > c.y - c.r
            ) {
              c.collected = true;
              score += 50;
              spawnParticles(c.x, c.y, "#ffd166", 10);
            }
          }
          if (c.x < -20) collectibles.splice(i, 1);
        }

        // Particles
        for (let i = particles.length - 1; i >= 0; i--) {
          let p = particles[i];
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.2;
          p.life--;
          if (p.life <= 0) particles.splice(i, 1);
        }

        // Update HUD
        document.getElementById("score-display").textContent = score + " pts";
      }

      function takeDamage() {
        lives--;
        hitCooldown = 90;
        spawnParticles(
          punch.x + punch.w / 2,
          punch.y - punch.h / 2,
          "#ff4d6d",
          15,
        );
        let h = "";
        for (let i = 0; i < lives; i++) h += "‚ù§Ô∏è";
        for (let i = lives; i < 3; i++) h += "üñ§";
        document.getElementById("hearts").textContent = h || "üíÄ";
        if (lives <= 0) triggerGameOver();
      }

      // === DRAW ===
      function drawBackground() {
        // Sky gradient
        let grad = ctx.createLinearGradient(0, 0, 0, H);
        grad.addColorStop(0, "#0d0426");
        grad.addColorStop(1, "#2d1b69");
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);

        // Stars
        let l0 = bgLayers[0];
        ctx.fillStyle = "rgba(255,255,255,0.7)";
        for (let s of l0.stars) {
          ctx.beginPath();
          ctx.arc((((s.x - l0.x * 0.5) % W) + W) % W, s.y, s.r, 0, Math.PI * 2);
          ctx.fill();
        }

        // Moon
        ctx.fillStyle = "#ffd166";
        ctx.shadowColor = "#ffd16688";
        ctx.shadowBlur = 20;
        ctx.beginPath();
        ctx.arc(680, 50, 28, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;

        // Far trees
        let l1 = bgLayers[1];
        ctx.fillStyle = "#1a0a3e";
        for (let t of l1.trees) {
          drawTree(
            ((((t.x - l1.x) % (W + 100)) + W + 100) % (W + 100)) - 100,
            GROUND,
            t.h,
          );
        }

        // Near trees
        let l2 = bgLayers[2];
        ctx.fillStyle = "#150834";
        for (let t of l2.trees) {
          drawTree(
            ((((t.x - l2.x) % (W + 100)) + W + 100) % (W + 100)) - 100,
            GROUND,
            t.h,
          );
        }

        // Ground
        let ggrad = ctx.createLinearGradient(0, GROUND, 0, H);
        ggrad.addColorStop(0, "#3d2b0a");
        ggrad.addColorStop(1, "#1f1507");
        ctx.fillStyle = ggrad;
        ctx.fillRect(0, GROUND, W, H - GROUND);

        // Ground line detail
        ctx.strokeStyle = "#5a3f10";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, GROUND);
        ctx.lineTo(W, GROUND);
        ctx.stroke();

        // Running ground marks
        ctx.strokeStyle = "rgba(90,63,16,0.5)";
        ctx.lineWidth = 1;
        let markSpacing = 80;
        let offset = (frame * speed * 0.5) % markSpacing;
        for (let x = -offset; x < W; x += markSpacing) {
          ctx.beginPath();
          ctx.moveTo(x, GROUND + 10);
          ctx.lineTo(x + 30, GROUND + 10);
          ctx.stroke();
        }
      }

      function drawTree(x, baseY, h) {
        // trunk
        ctx.fillRect(x - 8, baseY - h * 0.4, 16, h * 0.4);
        // canopy
        ctx.beginPath();
        ctx.arc(x, baseY - h * 0.5, h * 0.4, 0, Math.PI * 2);
        ctx.fill();
      }

      function drawPunch() {
        let x = punch.x;
        let y = punch.y;
        let bobY = punch.jumping ? 0 : Math.sin(frame * 0.25) * 2;
        let isSliding = punch.sliding;
        let flash = hitCooldown > 0 && Math.floor(hitCooldown / 6) % 2 === 0;

        if (flash) {
          ctx.globalAlpha = 0.3;
        }

        ctx.save();
        ctx.translate(x + punch.w / 2, y + bobY);
        if (isSliding) ctx.scale(1, 0.5);

        // Shadow
        ctx.globalAlpha = flash ? 0.1 : 0.3;
        ctx.fillStyle = "#000";
        ctx.beginPath();
        ctx.ellipse(0, 2, 22, 8, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = flash ? 0.3 : 1;

        // Body
        ctx.fillStyle = "#c47a2e";
        ctx.beginPath();
        ctx.roundRect(-16, -42, 32, 34, 8);
        ctx.fill();

        // Belly
        ctx.fillStyle = "#e8a96a";
        ctx.beginPath();
        ctx.ellipse(0, -30, 10, 12, 0, 0, Math.PI * 2);
        ctx.fill();

        // Head
        ctx.fillStyle = "#c47a2e";
        ctx.beginPath();
        ctx.arc(0, -50, 16, 0, Math.PI * 2);
        ctx.fill();

        // Face
        ctx.fillStyle = "#e8a96a";
        ctx.beginPath();
        ctx.ellipse(0, -46, 11, 10, 0, 0, Math.PI * 2);
        ctx.fill();

        // Eyes
        ctx.fillStyle = "#1a0a2e";
        ctx.beginPath();
        ctx.arc(-5, -52, 3, 0, Math.PI * 2);
        ctx.arc(5, -52, 3, 0, Math.PI * 2);
        ctx.fill();

        // Eye shine
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(-4, -53, 1, 0, Math.PI * 2);
        ctx.arc(6, -53, 1, 0, Math.PI * 2);
        ctx.fill();

        // Smile
        ctx.strokeStyle = "#1a0a2e";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(0, -42, 5, 0.2, Math.PI - 0.2);
        ctx.stroke();

        // Ears
        ctx.fillStyle = "#c47a2e";
        ctx.beginPath();
        ctx.arc(-15, -52, 7, 0, Math.PI * 2);
        ctx.arc(15, -52, 7, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "#e8c09a";
        ctx.beginPath();
        ctx.arc(-15, -52, 4, 0, Math.PI * 2);
        ctx.arc(15, -52, 4, 0, Math.PI * 2);
        ctx.fill();

        // Plushie (red)
        ctx.fillStyle = "#ff4d6d";
        let punchArmX = -18;
        let punchArmY = -28;
        ctx.beginPath();
        ctx.arc(punchArmX, punchArmY, 10, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "#ff8fa3";
        ctx.beginPath();
        ctx.arc(punchArmX - 2, punchArmY - 3, 4, 0, Math.PI * 2);
        ctx.fill();
        // plushie ears
        ctx.fillStyle = "#ff4d6d";
        ctx.beginPath();
        ctx.arc(punchArmX - 7, punchArmY - 8, 4, 0, Math.PI * 2);
        ctx.arc(punchArmX + 3, punchArmY - 10, 4, 0, Math.PI * 2);
        ctx.fill();

        // Running legs
        let legCycle = punch.jumping ? 0 : Math.sin(frame * 0.4) * 12;
        ctx.fillStyle = "#c47a2e";
        ctx.beginPath();
        ctx.roundRect(-12, -10, 10, 14, 4);
        ctx.roundRect(2, -10, 10, 14, 4);
        ctx.fill();
        // feet
        ctx.fillStyle = "#a05a1e";
        ctx.beginPath();
        ctx.ellipse(-7, 5, 8, 5, legCycle * 0.03, 0, Math.PI * 2);
        ctx.ellipse(7, 5, 8, 5, -legCycle * 0.03, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
        ctx.globalAlpha = 1;
      }

      function drawObstacle(o) {
        ctx.save();
        ctx.translate(o.x + o.w / 2, 0);

        if (o.type === "vine") {
          // Hanging vine / branch
          ctx.fillStyle = "#06d6a0";
          ctx.fillRect(-o.w / 2, o.y - 8, o.w, 8);
          // leaves
          for (let i = 0; i < 3; i++) {
            let lx = -o.w / 2 + i * (o.w / 2) + 4;
            ctx.fillStyle = i % 2 === 0 ? "#06d6a0" : "#05b386";
            ctx.beginPath();
            ctx.ellipse(lx, o.y - 16 - i * 8, 8, 14, 0.3, 0, Math.PI * 2);
            ctx.fill();
          }
          // "DUCK!" label
          ctx.fillStyle = "#fff";
          ctx.font = "bold 11px Boogaloo, cursive";
          ctx.textAlign = "center";
          ctx.fillText("DUCK!", 0, o.y - o.h + 10);
        } else if (o.type === "slider") {
          // Low sliding monkey
          let bob = o.animFrame === 0 ? 0 : 2;
          let gy = o.y + bob;

          ctx.fillStyle = "#ef476f";
          // body low
          ctx.beginPath();
          ctx.roundRect(-o.w / 2, gy - 20, o.w, 20, 6);
          ctx.fill();
          // head
          ctx.fillStyle = "#ff7096";
          ctx.beginPath();
          ctx.arc(-o.w / 2 + 12, gy - 28, 12, 0, Math.PI * 2);
          ctx.fill();
          // angry eyes
          ctx.fillStyle = "white";
          ctx.beginPath();
          ctx.arc(-o.w / 2 + 8, gy - 31, 4, 0, Math.PI * 2);
          ctx.arc(-o.w / 2 + 16, gy - 31, 4, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = "#1a0a2e";
          ctx.beginPath();
          ctx.arc(-o.w / 2 + 9, gy - 30, 2.5, 0, Math.PI * 2);
          ctx.arc(-o.w / 2 + 17, gy - 30, 2.5, 0, Math.PI * 2);
          ctx.fill();
          // angry brows
          ctx.strokeStyle = "#1a0a2e";
          ctx.lineWidth = 2.5;
          ctx.beginPath();
          ctx.moveTo(-o.w / 2 + 5, gy - 36);
          ctx.lineTo(-o.w / 2 + 13, gy - 33);
          ctx.moveTo(-o.w / 2 + 13, gy - 36);
          ctx.lineTo(-o.w / 2 + 20, gy - 33);
          ctx.stroke();
          // mouth
          ctx.strokeStyle = "#1a0a2e";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(-o.w / 2 + 12, gy - 24, 4, 0, Math.PI);
          ctx.stroke();

          // JUMP label
          ctx.fillStyle = "#fff";
          ctx.font = "bold 11px Boogaloo";
          ctx.textAlign = "center";
          ctx.fillText("JUMP!", 0, gy - 42);
        } else {
          // Jumper monkey - upright
          let bob = o.animFrame === 0 ? 0 : -4;

          ctx.fillStyle = "#ff9f1c";
          // body
          ctx.beginPath();
          ctx.roundRect(-o.w / 2, o.y - o.h + bob, o.w, o.h * 0.7, 8);
          ctx.fill();
          // head
          ctx.beginPath();
          ctx.arc(0, o.y - o.h - 8 + bob, 16, 0, Math.PI * 2);
          ctx.fill();
          // face
          ctx.fillStyle = "#ffc76b";
          ctx.beginPath();
          ctx.ellipse(0, o.y - o.h - 4 + bob, 10, 9, 0, 0, Math.PI * 2);
          ctx.fill();
          // eyes
          ctx.fillStyle = "white";
          ctx.beginPath();
          ctx.arc(-5, o.y - o.h - 11 + bob, 4, 0, Math.PI * 2);
          ctx.arc(5, o.y - o.h - 11 + bob, 4, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = "#1a0a2e";
          ctx.beginPath();
          ctx.arc(-4, o.y - o.h - 10 + bob, 2.5, 0, Math.PI * 2);
          ctx.arc(6, o.y - o.h - 10 + bob, 2.5, 0, Math.PI * 2);
          ctx.fill();
          // furrowed brows
          ctx.strokeStyle = "#1a0a2e";
          ctx.lineWidth = 2.5;
          ctx.beginPath();
          ctx.moveTo(-9, o.y - o.h - 17 + bob);
          ctx.lineTo(-1, o.y - o.h - 14 + bob);
          ctx.moveTo(1, o.y - o.h - 17 + bob);
          ctx.lineTo(9, o.y - o.h - 14 + bob);
          ctx.stroke();

          ctx.fillStyle = "#fff";
          ctx.font = "bold 11px Boogaloo";
          ctx.textAlign = "center";
          ctx.fillText("JUMP!", 0, o.y - o.h - 36 + bob);
        }

        ctx.restore();
      }

      function drawCollectible(c) {
        if (c.collected) return;
        let bob = Math.sin(frame * 0.08 + c.x) * 4;
        ctx.fillStyle = "#ffd166";
        ctx.shadowColor = "#ffd166";
        ctx.shadowBlur = 10;
        ctx.beginPath();
        ctx.arc(c.x, c.y + bob, c.r, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
        // banana icon
        ctx.font = "16px serif";
        ctx.textAlign = "center";
        ctx.fillText("üçå", c.x, c.y + bob + 5);
      }

      function drawParticles() {
        for (let p of particles) {
          ctx.globalAlpha = p.life / p.maxLife;
          ctx.fillStyle = p.color;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r * (p.life / p.maxLife), 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.globalAlpha = 1;
      }

      function drawDistanceMarker() {
        ctx.fillStyle = "rgba(255,255,255,0.15)";
        ctx.font = "14px Nunito, sans-serif";
        ctx.textAlign = "right";
        ctx.fillText(
          `${Math.floor(distance)}m / ${winDistance}m to mama`,
          W - 10,
          H - 10,
        );

        // checkpoint markers
        let phases = [
          { d: winDistance * 0.33, label: "üå¥ Deep Jungle" },
          { d: winDistance * 0.66, label: "üåô Moonlit Path" },
          { d: winDistance, label: "üè† Mama's House" },
        ];
        for (let p of phases) {
          if (Math.abs(distance - p.d) < speed * 2) {
            ctx.font = "bold 24px Boogaloo";
            ctx.textAlign = "center";
            ctx.fillStyle = "#ffd166";
            ctx.fillText(p.label, W / 2, H / 2 - 20);
          }
        }
      }

      // === RENDER ===
      function render() {
        ctx.clearRect(0, 0, W, H);
        drawBackground();

        for (let c of collectibles) drawCollectible(c);
        for (let o of obstacles) drawObstacle(o);
        drawPunch();
        drawParticles();
        drawDistanceMarker();
      }

      // === LOOP ===
      let animId;
      function loop() {
        if (state !== "playing") return;
        update();
        render();
        animId = requestAnimationFrame(loop);
      }

      // === CONTROLS ===
      function startGame() {
        document.getElementById("title-screen").style.display = "none";
        resetState();
        state = "playing";
        loop();
      }

      function restartGame() {
        document.getElementById("game-over-screen").style.display = "none";
        document.getElementById("win-screen").style.display = "none";
        cancelAnimationFrame(animId);
        resetState();
        state = "playing";
        loop();
      }

      function resetState() {
        score = 0;
        distance = 0;
        lives = 3;
        speed = 5;
        frame = 0;
        hitCooldown = 0;
        obstacles = [];
        collectibles = [];
        particles = [];
        obsCooldown = 80;
        colCooldown = 120;

        punch.y = GROUND;
        punch.vy = 0;
        punch.jumping = false;
        punch.jumpCount = 0;
        punch.sliding = false;
        punch.slideTimer = 0;
        punch.animFrame = 0;
        punch.animTimer = 0;

        document.getElementById("hearts").textContent = "‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è";
        document.getElementById("score-display").textContent = "0 pts";
        document.getElementById("progress-bar").style.width = "0%";
      }

      function triggerGameOver() {
        state = "over";
        cancelAnimationFrame(animId);
        document.getElementById("go-score").textContent = "Score: " + score;
        document.getElementById("game-over-screen").style.display = "flex";
      }

      function triggerWin() {
        state = "win";
        cancelAnimationFrame(animId);

        // Draw final peaceful scene
        render();
        drawWinScene();

        document.getElementById("win-score").textContent = "Score: " + score;
        setTimeout(() => {
          document.getElementById("win-screen").style.display = "flex";
        }, 1500);
      }

      function drawWinScene() {
        // Flash
        ctx.fillStyle = "rgba(255,215,100,0.3)";
        ctx.fillRect(0, 0, W, H);

        // Stars burst
        for (let i = 0; i < 30; i++) {
          spawnParticles(
            Math.random() * W,
            Math.random() * H,
            ["#ffd166", "#06d6a0", "#ff6b35", "#ff4d6d"][
              Math.floor(Math.random() * 4)
            ],
            3,
          );
        }
      }

      // Draw idle scene before start
      (function drawIdle() {
        drawBackground();

        // Punch sleeping in corner
        ctx.save();
        ctx.translate(200, GROUND);
        ctx.fillStyle = "#c47a2e";
        ctx.beginPath();
        ctx.roundRect(-20, -30, 40, 30, 8);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(0, -38, 16, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "#e8a96a";
        ctx.beginPath();
        ctx.ellipse(0, -34, 11, 10, 0, 0, Math.PI * 2);
        ctx.fill();
        // closed eyes
        ctx.strokeStyle = "#1a0a2e";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(-5, -40, 3, Math.PI, 0);
        ctx.arc(5, -40, 3, Math.PI, 0);
        ctx.stroke();
        // plushie
        ctx.fillStyle = "#ff4d6d";
        ctx.beginPath();
        ctx.arc(-22, -22, 10, 0, Math.PI * 2);
        ctx.fill();
        // zzz
        ctx.fillStyle = "#ffd166";
        ctx.font = "bold 14px Boogaloo";
        ctx.textAlign = "center";
        ctx.fillText("z z z", 20, -55);
        ctx.restore();
      })();
    </script>
  </body>
</html>
